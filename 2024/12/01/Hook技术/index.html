<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#f5b8d5"><meta name="author" content="l1pmoluy,1392181761@qq.com"><meta name="copyright" content="l1pmoluy"><meta name="generator" content="Hexo 7.3.0"><meta name="theme" content="hexo-theme-yun"><title>HookæŠ€æœ¯ | l1pmoluy</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#f5b8d5"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"l1pmoluy.github.io","root":"/","title":"è¸ç€æ¢¦èµ°è¿‡æ—¶å…‰","version":"1.10.11","mode":"time","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"æœç´¢...","empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹: ${query}","hits":"æ‰¾åˆ° ${hits} æ¡ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"algolia":{"hits":{"per_page":8}},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="l1pmoluy" type="application/atom+xml"><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><meta name="description" content="å†…æ ¸å‰ç½®â€”â€”HookæŠ€æœ¯">
<meta property="og:type" content="article">
<meta property="og:title" content="HookæŠ€æœ¯">
<meta property="og:url" content="https://l1pmoluy.github.io/2024/12/01/Hook%E6%8A%80%E6%9C%AF/index.html">
<meta property="og:site_name" content="l1pmoluy">
<meta property="og:description" content="å†…æ ¸å‰ç½®â€”â€”HookæŠ€æœ¯">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/l1pmoluy/l1pmoluy.github.io/master/postpic/Hook%E6%8A%80%E6%9C%AF/1.png">
<meta property="article:published_time" content="2024-12-01T12:01:05.000Z">
<meta property="article:modified_time" content="2025-10-08T13:43:31.797Z">
<meta property="article:author" content="l1pmoluy">
<meta property="article:tag" content="windowsæ·±åº¦å­¦ä¹ ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/l1pmoluy/l1pmoluy.github.io/master/postpic/Hook%E6%8A%80%E6%9C%AF/1.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="æ–‡ç« ç›®å½•"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="ç«™ç‚¹æ¦‚è§ˆ"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="l1pmoluy"><img width="96" loading="lazy" src="/images/rika.jpg" alt="l1pmoluy"><span class="site-author-status" title="Looking for dawn.">ğŸ¥°</span></a><div class="site-author-name"><a href="/about/">l1pmoluy</a></div><span class="site-name">l1pmoluy</span><sub class="site-subtitle">Dawing...</sub><div class="site-description">l1pmoluy's blog</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="é¦–é¡µ"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="å½’æ¡£"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">17</span></a></div><div class="site-state-item"><a href="/categories/" title="åˆ†ç±»"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">2</span></a></div><div class="site-state-item"><a href="/tags/" title="æ ‡ç­¾"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">3</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="ç•™è¨€æ¿"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:clipboard-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" title="1392181761" target="_blank" style="color:#12B7F5"><span class="icon iconify" data-icon="ri:qq-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://blog.csdn.net/dawn_ing_" title="csdn" target="_blank" style="color:#e83b07"><span class="icon iconify" data-icon="ri:terminal-box-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://bbs.kanxue.com/user-home-1012312.htm" title="çœ‹é›ª" target="_blank" style="color:#e83b07"><span class="icon iconify" data-icon="ri:snowflake-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="1392181761@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.yuque.com/l1pmpluy" title="è¯­é›€" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:yuque-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="å‹é“¾" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:user-community-line"></span></a><a class="links-item hty-icon-button" href="/girl/" title="å–œæ¬¢çš„å¥³å­©å­" style="color:hotpink"><span class="icon iconify" data-icon="ri:women-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E9%97%AE%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">æ€»é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.</span> <span class="toc-text">åœ°å€é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Detour%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.</span> <span class="toc-text">Detourå‡½æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TrampolineFun%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.</span> <span class="toc-text">TrampolineFunå‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hook%E5%88%86%E7%B1%BB"><span class="toc-number">2.</span> <span class="toc-text">Hookåˆ†ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%84%9F%E6%82%9F"><span class="toc-number">2.1.</span> <span class="toc-text">æ„Ÿæ‚Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">2.1.1.</span> <span class="toc-text">é—®é¢˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E9%97%AE%E9%A2%98"><span class="toc-number">2.1.2.</span> <span class="toc-text">ä¸ºä»€ä¹ˆæœ‰é—®é¢˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3"><span class="toc-number">2.1.3.</span> <span class="toc-text">è§£å†³</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B6%E9%9B%86%E5%88%B0%E7%9A%84%E5%A4%A7%E8%B7%B3%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">2.1.4.</span> <span class="toc-text">æ”¶é›†åˆ°çš„å¤§è·³å­—èŠ‚ç </span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Inline-Hook"><span class="toc-number">2.2.</span> <span class="toc-text">Inline Hook</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#InlineHook-movjmp"><span class="toc-number">2.2.1.</span> <span class="toc-text">InlineHook-movjmp</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">æºç </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B6%85%E8%AF%A6%E7%BB%86%E8%A7%A3%E8%AF%BB%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">è¶…è¯¦ç»†è§£è¯»ç¨‹åº</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AE%B5%E5%87%BD%E6%95%B0void-InlineHook"><span class="toc-number">2.2.1.3.1.</span> <span class="toc-text">ç¬¬ä¸€æ®µå‡½æ•°void InlineHook()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%AE%9A%E4%B9%89"><span class="toc-number">2.2.1.3.2.</span> <span class="toc-text">åˆå§‹å®šä¹‰</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E5%89%8D14%E5%AD%97%E8%8A%82"><span class="toc-number">2.2.1.3.3.</span> <span class="toc-text">è¯»å–å‰14å­—èŠ‚</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Hook14%E5%AD%97%E8%8A%82"><span class="toc-number">2.2.1.3.4.</span> <span class="toc-text">Hook14å­—èŠ‚</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%86%99%E5%85%A5hook"><span class="toc-number">2.2.1.3.5.</span> <span class="toc-text">å†™å…¥hook</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#InlineHook%E2%80%93HotPatch"><span class="toc-number">2.2.2.</span> <span class="toc-text">InlineHookâ€“HotPatch</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A0%81-1"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">æºç </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#SetPrivilege"><span class="toc-number">2.2.2.2.1.</span> <span class="toc-text">SetPrivilege</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#HOOKByHotpatch"><span class="toc-number">2.2.2.2.2.</span> <span class="toc-text">HOOKByHotpatch</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#InlineHook%E2%80%93call"><span class="toc-number">2.2.3.</span> <span class="toc-text">InlineHookâ€“call</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">åŸç†</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84Hook"><span class="toc-number">2.3.</span> <span class="toc-text">åŸºäºå¼‚å¸¸å¤„ç†çš„Hook</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-number">2.3.1.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81-2"><span class="toc-number">2.3.2.</span> <span class="toc-text">æºç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90"><span class="toc-number">2.3.3.</span> <span class="toc-text">è§£æ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#main%E5%87%BD%E6%95%B0"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">mainå‡½æ•°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E5%BC%82%E5%B8%B8%E5%87%BD%E6%95%B0"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">ä¸‰ç§å¼‚å¸¸å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%B1%E5%90%8C%E9%83%A8%E5%88%86"><span class="toc-number">2.3.3.2.1.</span> <span class="toc-text">å…±åŒéƒ¨åˆ†</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#VectoredHandler1"><span class="toc-number">2.3.3.2.2.</span> <span class="toc-text">VectoredHandler1</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#VectoredHandler2"><span class="toc-number">2.3.3.2.3.</span> <span class="toc-text">VectoredHandler2</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#VectoredHandler3"><span class="toc-number">2.3.3.2.4.</span> <span class="toc-text">VectoredHandler3</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#InstallVEHHook%E5%87%BD%E6%95%B0"><span class="toc-number">2.3.3.3.</span> <span class="toc-text">InstallVEHHookå‡½æ•°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Address-Hook%EF%BC%88%E5%BE%85%E5%AE%8C%E5%96%84%EF%BC%89%EF%BC%88%E5%81%8F%E5%86%85%E6%A0%B8%EF%BC%89"><span class="toc-number">2.4.</span> <span class="toc-text">Address Hookï¼ˆå¾…å®Œå–„ï¼‰ï¼ˆåå†…æ ¸ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">2.4.1.</span> <span class="toc-text">å‰è¨€</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%84%E7%B1%BB%E8%A1%A8%E4%B8%AD%E7%9A%84%E5%9C%B0%E5%9D%80"><span class="toc-number">2.4.1.1.</span> <span class="toc-text">å„ç±»è¡¨ä¸­çš„åœ°å€</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#DRIVER-OBJECT-%E7%9A%84-MajorFunction-%E5%8F%8AFasIo-%E6%B4%BE%E9%81%A3%E5%8E%86%E7%A8%8B%E5%9C%B0%E5%9D%80"><span class="toc-number">2.4.1.1.1.</span> <span class="toc-text">DRIVER_OBJECT çš„ MajorFunction åŠFasIo æ´¾é£å†ç¨‹åœ°å€</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#StartIo%E7%AD%89%E7%89%B9%E6%AE%8A%E4%BE%8B%E7%A8%8B%E7%9A%84%E5%9C%B0%E5%9D%80"><span class="toc-number">2.4.1.1.2.</span> <span class="toc-text">StartIoç­‰ç‰¹æ®Šä¾‹ç¨‹çš„åœ°å€</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#OBJECT-TYPE-%E4%B8%AD-OBJECT-TYPE-INITIALIZER%E5%8C%85%E5%90%AB%E7%9A%84%E5%90%84%E7%A7%8D%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B"><span class="toc-number">2.4.1.1.3.</span> <span class="toc-text">OBJECT_TYPE ä¸­ _OBJECT_TYPE_INITIALIZERåŒ…å«çš„å„ç§å¤„ç†è¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E5%AF%84%E5%AD%98%E5%99%A8%E4%B8%AD%E7%9A%84%E5%9C%B0%E5%9D%80"><span class="toc-number">2.4.1.2.</span> <span class="toc-text">ç‰¹æ®Šå¯„å­˜å™¨ä¸­çš„åœ°å€</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E7%9A%84%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88"><span class="toc-number">2.4.1.3.</span> <span class="toc-text">ç‰¹æ®Šçš„å‡½æ•°æŒ‡é’ˆ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IATHook"><span class="toc-number">2.4.2.</span> <span class="toc-text">IATHook</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#IAT"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">IAT</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-3"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A0%81-3"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">æºç </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-1"><span class="toc-number">2.4.2.4.</span> <span class="toc-text">è§£æ</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AE%B5"><span class="toc-number">2.4.2.4.1.</span> <span class="toc-text">ç¬¬ä¸€æ®µ</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AE%B5"><span class="toc-number">2.4.2.4.2.</span> <span class="toc-text">ç¬¬äºŒæ®µ</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AE%B5"><span class="toc-number">2.4.2.4.3.</span> <span class="toc-text">ç¬¬ä¸‰æ®µ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%99%9A%E5%87%BD%E6%95%B0hook"><span class="toc-number">2.4.3.</span> <span class="toc-text">è™šå‡½æ•°hook</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%99%9A%E5%87%BD%E6%95%B0%E8%A1%A8"><span class="toc-number">2.4.3.1.</span> <span class="toc-text">è™šå‡½æ•°è¡¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-4"><span class="toc-number">2.4.3.2.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A0%81-4"><span class="toc-number">2.4.3.3.</span> <span class="toc-text">æºç </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="toc-number">2.4.3.4.</span> <span class="toc-text">å‡½æ•°åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1-%E8%8E%B7%E5%8F%96%E8%99%9A%E6%8B%9F%E5%87%BD%E6%95%B0%E8%A1%A8%E5%9C%B0%E5%9D%80"><span class="toc-number">2.4.3.4.1.</span> <span class="toc-text">æ­¥éª¤ 1: è·å–è™šæ‹Ÿå‡½æ•°è¡¨åœ°å€</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-2-%E4%BF%AE%E6%94%B9%E8%99%9A%E6%8B%9F%E5%87%BD%E6%95%B0%E8%A1%A8"><span class="toc-number">2.4.3.4.2.</span> <span class="toc-text">æ­¥éª¤ 2: ä¿®æ”¹è™šæ‹Ÿå‡½æ•°è¡¨</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-3-%E6%81%A2%E5%A4%8D%E8%99%9A%E6%8B%9F%E5%87%BD%E6%95%B0%E8%A1%A8%E4%BF%AE%E6%94%B9"><span class="toc-number">2.4.3.4.3.</span> <span class="toc-text">æ­¥éª¤ 3: æ¢å¤è™šæ‹Ÿå‡½æ•°è¡¨ä¿®æ”¹</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-4-%E8%B0%83%E7%94%A8%E8%99%9A%E6%8B%9F%E5%87%BD%E6%95%B0"><span class="toc-number">2.4.3.4.4.</span> <span class="toc-text">æ­¥éª¤ 4: è°ƒç”¨è™šæ‹Ÿå‡½æ•°</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1hook%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">3.</span> <span class="toc-text">äºŒæ¬¡hookæ³¨æ„äº‹é¡¹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%8DHook"><span class="toc-number">3.1.</span> <span class="toc-text">1.ä¸Hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%81%A2%E5%A4%8DHook%E5%89%8D%E7%9A%84%E6%8C%87%E4%BB%A4"><span class="toc-number">3.2.</span> <span class="toc-text">2.æ¢å¤Hookå‰çš„æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%8D%A2%E4%B8%AA%E7%9B%AE%E6%A0%87%E5%9C%B0%E5%9D%80Hook"><span class="toc-number">3.3.</span> <span class="toc-text">3.æ¢ä¸ªç›®æ ‡åœ°å€Hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Hook%E4%B8%8A%E4%B8%80%E4%B8%AAHook%E8%BF%87%E7%A8%8B%E7%9A%84Detour%E5%87%BD%E6%95%B0"><span class="toc-number">3.4.</span> <span class="toc-text">4.Hookä¸Šä¸€ä¸ªHookè¿‡ç¨‹çš„Detourå‡½æ•°</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#f5b8d5;"><link itemprop="mainEntityOfPage" href="https://l1pmoluy.github.io/2024/12/01/Hook%E6%8A%80%E6%9C%AF/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="l1pmoluy,1392181761@qq.com"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="l1pmoluy"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">HookæŠ€æœ¯</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="åˆ›å»ºæ—¶é—´ï¼š2024-12-1 20:01:05" itemprop="dateCreated datePublished" datetime="2024-12-01T20:01:05+08:00">2024-12-1</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-10-8 21:43:31" itemprop="dateModified" datetime="2025-10-08T21:43:31+08:00">2025-10-8</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="æœ¬æ–‡å­—æ•°"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="æœ¬æ–‡å­—æ•°">11.1k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="é˜…è¯»æ—¶é•¿"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="é˜…è¯»æ—¶é•¿">51m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E9%80%86%E5%90%91%E8%A1%8C%E9%A9%B6/" style="--text-color:#FF0000" itemprop="url" rel="index"><span itemprop="text">é€†å‘è¡Œé©¶</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/windows%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" style="--text-color:#416482"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">windowsæ·±åº¦å­¦ä¹ </span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><p>å†…æ ¸å‰ç½®â€”â€”HookæŠ€æœ¯</p>
<span id="more"></span>


<h2 id="æ€»é—®é¢˜"><a href="#æ€»é—®é¢˜" class="headerlink" title="æ€»é—®é¢˜"></a>æ€»é—®é¢˜</h2><h3 id="åœ°å€é—®é¢˜"><a href="#åœ°å€é—®é¢˜" class="headerlink" title="åœ°å€é—®é¢˜"></a>åœ°å€é—®é¢˜</h3><p>è¿™ä¸ªæˆ‘é‡åˆ°è¿‡å‡ æ¬¡ï¼Œé¦–å…ˆï¼š</p>
<p><strong>åœ°å€å¤§å°</strong>ï¼š åœ¨ 32 ä½ç³»ç»Ÿä¸­ï¼ŒæŒ‡é’ˆçš„å¤§å°æ˜¯ 4 å­—èŠ‚ï¼Œè€Œåœ¨ 64 ä½ç³»ç»Ÿä¸­ï¼ŒæŒ‡é’ˆçš„å¤§å°æ˜¯ 8 å­—èŠ‚ã€‚å› æ­¤ï¼Œå¯¹äº 64 ä½ç³»ç»Ÿï¼Œå‡½æ•°çš„åœ°å€è®¡ç®—ã€æŒ‡é’ˆè¿ç®—éœ€è¦ä½¿ç”¨ 64 ä½å¤§å°çš„åœ°å€ã€‚  </p>
<p>æ‰€ä»¥ç½‘ä¸Šçš„è„šæœ¬æœ‰äº›æ˜¯32ä½è„šæœ¬ï¼Œæ— æ³•è¿è¡Œçš„è¯å°±è¦è€ƒè™‘è¿™ä¸ª</p>
<h3 id="Detourå‡½æ•°"><a href="#Detourå‡½æ•°" class="headerlink" title="Detourå‡½æ•°"></a>Detourå‡½æ•°</h3><p><code>Detour</code> å‡½æ•°ä¸€èˆ¬æŒ‡çš„æ˜¯åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¿®æ”¹æˆ–æ›¿æ¢æŸä¸ªå‡½æ•°çš„æ‰§è¡Œè·¯å¾„çš„æŠ€æœ¯ï¼Œä¹Ÿå«åš <strong>å‡½æ•°é’©å­ï¼ˆFunction Hookingï¼‰</strong> æˆ– <strong>å‡½æ•°åŠ«æŒï¼ˆFunction Detouringï¼‰</strong>ã€‚è¿™ä¸ªè¿‡ç¨‹å…è®¸æˆ‘ä»¬åœ¨ä¸æ”¹å˜åŸå‡½æ•°ä»£ç çš„æƒ…å†µä¸‹ï¼Œæ’å…¥è‡ªå®šä¹‰çš„é€»è¾‘æˆ–ä»£ç ã€‚  </p>
<h3 id="TrampolineFunå‡½æ•°"><a href="#TrampolineFunå‡½æ•°" class="headerlink" title="TrampolineFunå‡½æ•°"></a>TrampolineFunå‡½æ•°</h3><p>è¯¥å‡½æ•°ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å‡½æ•°ï¼Œæ˜¯è°ƒç”¨åŸå‡½æ•°çš„å…¥å£</p>
<h2 id="Hookåˆ†ç±»"><a href="#Hookåˆ†ç±»" class="headerlink" title="Hookåˆ†ç±»"></a>Hookåˆ†ç±»</h2><p>å¯¹äºhookï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ˜¯å¯¹å¼•ç”¨å‡½æ•°çš„åœ°å€è¿›è¡Œæ“ä½œï¼Œå¦ä¸€ç§æ˜¯å¯¹å¼•ç”¨å‡½æ•°çš„åœ°å€çš„å†…å®¹è¿›è¡Œæ“ä½œ</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªcè¯­è¨€ç¨‹åºï¼Œç›®çš„æ˜¯å°†åŸæœ¬æ‰“å°çš„Aæ¢æˆB</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">PrintChar</span><span class="params">(<span class="type">char</span>* pch)</span> &#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Address=0x%x  Char=%c\n&quot;</span>, pch, *pch);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">char</span> ch = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">	<span class="type">char</span> ch2 = <span class="string">&#x27;B&#x27;</span>;</span><br><span class="line">	<span class="type">char</span>* pChar;</span><br><span class="line">	pChar = &amp;ch;</span><br><span class="line">	PrintChar(pChar);					<span class="comment">//Address=0x84cff704  Char=A</span></span><br><span class="line">	<span class="comment">//Adress hook</span></span><br><span class="line">	pChar = &amp;ch2;</span><br><span class="line">	PrintChar(pChar);					<span class="comment">//Address=0x84cff724  Char=B</span></span><br><span class="line">	pChar = &amp;ch;</span><br><span class="line">	<span class="comment">//Inline hook</span></span><br><span class="line">	*pChar = <span class="string">&#x27;B&#x27;</span>;</span><br><span class="line">	PrintChar(pChar);					<span class="comment">//Address=0x84cff704  Char=B</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸‰ç§ç»“æœä¸éš¾çœ‹å‡ºï¼Œç¬¬ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡æ”¹å˜åœ°å€ï¼Œå®ç°çš„æ‰“å°æ”¹å˜ï¼Œç¬¬äºŒç§ä¸æ”¹å˜åœ°å€ï¼Œä½†æ˜¯æ”¹å˜æŒ‡é’ˆæŒ‡å‘çš„å€¼</p>
<p>åœ¨è¿™ä¸ªç®€å•çš„ä¾‹å­ä¹‹åï¼Œå»äº†è§£åˆ«çš„Hookæ–¹å¼å°±ä¸éš¾äº†ã€‚åç›®ç¹å¤šçš„Hookï¼Œæ€»ç»“èµ·æ¥å…¶å®åªæœ‰ä¸¤ç§ï¼š</p>
<p><strong>Address Hook</strong> å’Œ** Inline Hook**</p>
<h3 id="æ„Ÿæ‚Ÿ"><a href="#æ„Ÿæ‚Ÿ" class="headerlink" title="æ„Ÿæ‚Ÿ"></a>æ„Ÿæ‚Ÿ</h3><p>åœ¨InlineHookè¿™é‡Œï¼Œå­¦ä¹ çš„å¾ˆå¤šï¼Œæ„Ÿè§‰æ¯”ä¹‹å‰æ‚Ÿäº†å¾ˆå¤š</p>
<p>hookåŸç†å°±æ˜¯è·³è·³è·³</p>
<h4 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h4><p>é‚£ä¹ˆé¦–å…ˆç¬¬ä¸€ä¸ªæˆ‘å¡ä½çš„æ˜¯HotPatch Hook</p>
<p>è¿™ä¸ªhooké‡åˆ°çš„é—®é¢˜å°±æ˜¯è·³è½¬çš„æ—¶å€™ï¼Œè·ç¦»å¤ªå¤§äº†ï¼Œæºåœ°å€ï¼š<code>00007FFE556D61B6</code> ï¼Œè·³è½¬åœ°å€æ˜¯<code>000000014001213B</code>ï¼Œå°±æ˜¯ä¸€ä¸ªæ˜¯APTå‡½æ•°ï¼Œä¸€ä¸ªæ˜¯è‡ªå·±å†™çš„hookå‡½æ•°ï¼Œè·ç¦»å¤ªè¿œäº†æ‰€ä»¥è·³è½¬å®ç°ä¸äº†</p>
<p>ç¬¬äºŒä¸ªé‡åˆ°é—®é¢˜æ˜¯åœ¨InlineHooké‡Œé¢çš„InlineHookï¼Œå…¶ä¸­æœ¬æ¥åº”è¯¥ï¼Œå°è·³åˆ°IATè¡¨ä¸­åœ°å€ç„¶åå¯¹åœ°å€è·³è½¬ï¼Œé€šè¿‡hookåå˜æˆå°è·³åˆ°ç”³è¯·çš„åœ°å€ä¸­ï¼Œå¯¹åœ°å€ä¸­çš„åœ°å€æŒ‘æˆ˜ï¼Œä½†é‡åˆ°çš„é—®é¢˜å’Œä¸Šé¢ä¸€æ ·</p>
<h4 id="ä¸ºä»€ä¹ˆæœ‰é—®é¢˜"><a href="#ä¸ºä»€ä¹ˆæœ‰é—®é¢˜" class="headerlink" title="ä¸ºä»€ä¹ˆæœ‰é—®é¢˜"></a>ä¸ºä»€ä¹ˆæœ‰é—®é¢˜</h4><p>å¯¹äºä¸€ä¸ª64ä½ç¨‹åºæ¥è¯´ï¼Œä¸€ä¸ªæ™®æ™®é€šé€šçš„ç¨‹åºå¼€å§‹çš„åœ°æ–¹ï¼Œéƒ½åœ¨<code>1 40 00 00 00</code>å¦‚æ­¤çš„é«˜åœ°å€èµ·æ­¥ï¼ŒIATè¡¨ä¸€èˆ¬éƒ½ä¼šåœ¨éå¸¸éå¸¸é«˜çš„ä½ç½®å¦‚<code>00007FFE556D61B6</code> ï¼Œç„¶è€Œè‡ªå·±ç”³è¯·çš„åœ°å€åˆåœ¨ååˆ†ä½çš„ä½ç½®ï¼Œè¿™æ ·æƒ³å®ç°é€šè¿‡æœ¬æ¥çš„å°è·³è½¬å®ç°hookå°±å¾ˆè‰°éš¾äº†</p>
<h4 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h4><p>å¯¹äºè¿™äº›çš„è§£å†³ï¼Œå…¶å®å°±æ˜¯æ‰¾64ä½ç¨‹åºçš„è·³è½¬æ–¹æ³•ï¼Œæ‰¾å®ç°è¿œè·ç¦»å¤§è·³çš„å­—èŠ‚ç ï¼ŒåŸºæœ¬éƒ½æ˜¯å¾—é€šè¿‡ä¿®æ”¹å­—èŠ‚ç æ¥å®ç°è·³è½¬äº†ï¼ˆé™¤éè¿™ä¸¤ä¸ªå¾ˆè¿‘ï¼‰</p>
<h4 id="æ”¶é›†åˆ°çš„å¤§è·³å­—èŠ‚ç "><a href="#æ”¶é›†åˆ°çš„å¤§è·³å­—èŠ‚ç " class="headerlink" title="æ”¶é›†åˆ°çš„å¤§è·³å­—èŠ‚ç "></a>æ”¶é›†åˆ°çš„å¤§è·³å­—èŠ‚ç </h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,  <span class="comment">//mov rax,xxx</span></span><br><span class="line"><span class="number">0xFF</span>,<span class="number">0xE0</span>			                                <span class="comment">//jmp rax </span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x68</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span><span class="comment">//push 000000</span></span><br><span class="line"><span class="number">0xc7</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span><span class="comment">//mov dword ptr [rsp+4],00000000</span></span><br><span class="line"><span class="number">0xc3</span>					<span class="comment">//retn</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xff</span>,<span class="number">0x25</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span><span class="comment">//jmp qword ptr [00000000 00000000]</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå¯ä»¥è·³çš„å¾ˆè¿œï¼Œä½†æ˜¯è®¡ç®—çš„æ˜¯åç§»</p>
<h3 id="Inline-Hook"><a href="#Inline-Hook" class="headerlink" title="Inline Hook"></a>Inline Hook</h3><p>Inline Hookæ˜¯æŒ‡ç›´æ¥ä¿®æ”¹æŒ‡ä»¤çš„hook</p>
<p>å› ä¸ºå…¶å…³é”®æ˜¯è½¬ç§»ç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼Œæ‰€ä»¥ä¸€èˆ¬æ˜¯ç”¨jmpã€callã€retnä¹‹ç±»çš„è½¬ç§»æŒ‡ä»¤</p>
<p>é‚£ä¹ˆæ ¹æ®ä¸åŒåœºåˆä¼šæœ‰ä¸åŒçš„æ”¹å˜æŒ‡ä»¤æ–¹å¼ï¼Œå¦‚ä¸‹æ˜¯äº”ç§æ¨¡å¼ï¼š</p>
<p>1.jmp xxxxxxxxï¼ˆ5å­—èŠ‚ï¼‰</p>
<p>ç›´æ¥è·³è½¬</p>
<p>2.push xxxxxxxxï¼ˆ6å­—èŠ‚ï¼‰</p>
<p>   retn</p>
<p>å‹æ ˆè¿”å›å®ç°è·³è½¬</p>
<p>3.mov eax,xxxxxxxx 	(7å­—èŠ‚)</p>
<p>   jmp eax</p>
<p>å…ˆå°†è½¬ç§»åœ°å€æ”¾å…¥å¯„å­˜å™¨ï¼Œåœ¨å®ç°è·³è½¬ï¼ˆæ³¨ï¼šè¿™é‡Œä½¿ç”¨eaxå¯„å­˜å™¨æ˜¯å› ä¸ºeaxé€šå¸¸ç”¨äºå­˜å‚¨è¿”å›å€¼ï¼Œåœ¨å‡½æ•°å¼€å§‹æ—¶ä¸ä¼šå½±å“ä»€ä¹ˆï¼‰</p>
<p>4.call Hookï¼ˆæ›´æ¢æŒ‡ä»¤æˆ–è¾“å…¥è¡¨ï¼‰</p>
<p>5.HotPatch Hook</p>
<p>è¿™ä¸ªè¦ç»†è¯´ï¼Œé‡æ–°å¼€ä¸€ä¸ªhook</p>
<h4 id="InlineHook-movjmp"><a href="#InlineHook-movjmp" class="headerlink" title="InlineHook-movjmp"></a>InlineHook-movjmp</h4><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/142621824">https://zhuanlan.zhihu.com/p/142621824</a></p>
<h5 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h5><p>åŸç†å¤§è‡´æ˜¯ï¼Œåœ¨ä¸€ä¸ªAPIå‡½æ•°å¼€å§‹å‰ï¼Œä¼šæœ‰ä¸€ä¸ªcallå‡½æ•°æ‰§è¡Œï¼Œæˆ‘ä»¬é€šè¿‡æ”¹å˜APIå‡½æ•°çš„æ„é€ ï¼Œæ¥åšåˆ°hook</p>
<p>ä»¥<code>MessageBoxA</code>ä¸¾ä¾‹ï¼Œè¿™æ˜¯APIå‡½æ•°ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªå‡½æ•°æ‰€åœ¨æ¨¡å—ä¼šè®°å½•è¿™ä¸ªå‡½æ•°å¦‚æœè¢«è°ƒç”¨çš„è¯å…¨è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Œè¿™ä¸ªå‡½æ•°æ­£å¸¸æ‰§è¡Œæµç¨‹æ˜¯<code>call MessageBoxA</code>ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªæ¨¡å—ä¸­ï¼Œ<code>MessageBoxAadress</code>éƒ¨åˆ†ç¬¬ä¸€é¡¹å°±ä¼šä½¿<code>call MessageBoxA</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨è¿‡ä½¿ç”¨APIå‡½æ•°æ‰€åœ¨æ¨¡å—çš„å¥æŸ„ï¼Œè·å¾—å‡½æ•°åœ°å€ï¼Œå†é€šè¿‡å‡½æ•°åœ°å€ï¼Œä½¿ç”¨  <code>WriteProcessMemory</code>å‡½æ•°å†™å…¥å‡†å¤‡å¥½çš„åŒå­—èŠ‚å¤§å°è·³è½¬å‡½æ•°ï¼Œå³å¯å®Œæˆhook</p>
<p><img src="https://raw.githubusercontent.com/l1pmoluy/l1pmoluy.github.io/master/postpic/Hook%E6%8A%80%E6%9C%AF/1.png" loading="lazy"></p>
<h5 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹APIå…¥å£ä¸º mov rax, JmpAddr;jmp rax æ˜¯ç¨‹åºèƒ½è·³è½¬åˆ°è‡ªå·±çš„å‡½æ•°</span></span><br><span class="line">BYTE __NewCode[<span class="number">14</span>] = &#123; <span class="number">0x48</span>, <span class="number">0xB8</span> &#125;;  <span class="comment">// mov rax, JmpAddr å’Œ jmp rax</span></span><br><span class="line">BYTE __OldCode[<span class="number">14</span>] = &#123; <span class="number">0</span> &#125;;  <span class="comment">// å­˜å‚¨MessageBoxAåŸå§‹ä»£ç </span></span><br><span class="line"></span><br><span class="line">FARPROC __MessageBoxAddress;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> WINAPI <span class="title function_">MyMessageBoxA</span><span class="params">(</span></span><br><span class="line"><span class="params">    HWND hWnd,        <span class="comment">// handle to owner window</span></span></span><br><span class="line"><span class="params">    LPCTSTR lpText,   <span class="comment">// text in message box</span></span></span><br><span class="line"><span class="params">    LPCTSTR lpCaption, <span class="comment">// message box title</span></span></span><br><span class="line"><span class="params">    UINT uType        <span class="comment">// message box style</span></span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">InlineHook</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    InlineHook();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨MessageBoxAæµ‹è¯•ä¸€ä¸‹ã€‚</span></span><br><span class="line">    MessageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;Hello World&quot;</span>, <span class="string">&quot;Title&quot;</span>, MB_OK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">InlineHook</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    HMODULE hModule_User32 = LoadLibrary(<span class="string">L&quot;user32.dll&quot;</span>);</span><br><span class="line">    __MessageBoxAddress = GetProcAddress(hModule_User32, <span class="string">&quot;MessageBoxA&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å°MessageBoxAçš„åœ°å€</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;__MessageBoxAddress is %p\n&quot;</span>, __MessageBoxAddress);</span><br><span class="line">    <span class="comment">// MyMessageBoxAçš„åœ°å€</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;MyMessageBoxA Addr is %p\n&quot;</span>, MyMessageBoxA);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»MessageBoxAå‡½æ•°çš„å‰6ä¸ªå­—èŠ‚</span></span><br><span class="line">    HANDLE hProcess = OpenProcess(PROCESS_VM_READ | PROCESS_VM_WRITE | PROCESS_VM_OPERATION, FALSE, GetCurrentProcessId());</span><br><span class="line">    <span class="keyword">if</span> (ReadProcessMemory(hProcess, __MessageBoxAddress, __OldCode, <span class="number">14</span>, <span class="literal">NULL</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ReadProcessMemory error\n&quot;</span>);</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å°åŸå§‹MessageBoxAçš„ä»£ç </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;__OldCode is &quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">14</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02X &quot;</span>, __OldCode[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    DWORD64 JmpAddress = (DWORD64)MyMessageBoxA;  <span class="comment">// 64 ä½åœ°å€</span></span><br><span class="line">    <span class="comment">// æ„é€ æ–°å¤´éƒ¨ä»£ç </span></span><br><span class="line">    __NewCode[<span class="number">0</span>] = <span class="number">0x48</span>;  <span class="comment">// 64 ä½æ“ä½œçš„å‰ç¼€</span></span><br><span class="line">    __NewCode[<span class="number">1</span>] = <span class="number">0xB8</span>;  <span class="comment">// mov rax, [JmpAddr]</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;__NewCode[<span class="number">2</span>], &amp;JmpAddress, <span class="number">8</span>);   <span class="comment">// å°† 64 ä½åœ°å€å†™å…¥</span></span><br><span class="line">    __NewCode[<span class="number">10</span>] = <span class="number">0xFF</span>;  <span class="comment">// jmp rax</span></span><br><span class="line">    __NewCode[<span class="number">11</span>] = <span class="number">0xE0</span>;  <span class="comment">// jmp rax</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å°æ–°ä»£ç </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;NewBytes are &quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">14</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02X &quot;</span>, __NewCode[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    DWORD dwOldProtect = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å»å†…å­˜ä¿æŠ¤</span></span><br><span class="line">    VirtualProtectEx(hProcess, (LPVOID)__MessageBoxAddress, <span class="number">14</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥è·³è½¬ï¼Œå¼€å§‹Hook</span></span><br><span class="line">    <span class="keyword">if</span> (!WriteProcessMemory(hProcess, __MessageBoxAddress, __NewCode, <span class="number">14</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory error\n&quot;</span>);</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¢å¤å†…å­˜ä¿æŠ¤</span></span><br><span class="line">    VirtualProtectEx(hProcess, (LPVOID)__MessageBoxAddress, <span class="number">14</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">    CloseHandle(hProcess);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> WINAPI <span class="title function_">MyMessageBoxA</span><span class="params">(</span></span><br><span class="line"><span class="params">    HWND hWnd,        <span class="comment">// handle to owner window</span></span></span><br><span class="line"><span class="params">    LPCTSTR lpText,   <span class="comment">// text in message box</span></span></span><br><span class="line"><span class="params">    LPCTSTR lpCaption, <span class="comment">// message box title</span></span></span><br><span class="line"><span class="params">    UINT uType        <span class="comment">// message box style</span></span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;MessageBoxA å·²ç»è¢«Hook\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¢å¤åŸå§‹çš„APIä»£ç </span></span><br><span class="line">    HANDLE hProcess = OpenProcess(PROCESS_VM_WRITE | PROCESS_VM_OPERATION, FALSE, GetCurrentProcessId());</span><br><span class="line">    DWORD dwOldProtect = <span class="number">0</span>;</span><br><span class="line">    VirtualProtectEx(hProcess, (LPVOID)__MessageBoxAddress, <span class="number">14</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line">    WriteProcessMemory(hProcess, (LPVOID)__MessageBoxAddress, (LPVOID)__OldCode, <span class="number">14</span>, <span class="literal">NULL</span>);</span><br><span class="line">    VirtualProtectEx(hProcess, (LPVOID)__MessageBoxAddress, <span class="number">14</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line">    <span class="comment">// è°ƒç”¨æ­£ç¡®çš„å‡½æ•°</span></span><br><span class="line">    <span class="type">int</span> ret = MessageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;Title&quot;</span>, MB_OK);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥è·³è½¬è¯­å¥ï¼Œç»§ç»­Hook</span></span><br><span class="line">    WriteProcessMemory(hProcess, (LPVOID)__MessageBoxAddress, (LPVOID)__NewCode, <span class="number">14</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    CloseHandle(hProcess);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="è¶…è¯¦ç»†è§£è¯»ç¨‹åº"><a href="#è¶…è¯¦ç»†è§£è¯»ç¨‹åº" class="headerlink" title="è¶…è¯¦ç»†è§£è¯»ç¨‹åº"></a>è¶…è¯¦ç»†è§£è¯»ç¨‹åº</h5><h6 id="ç¬¬ä¸€æ®µå‡½æ•°void-InlineHook"><a href="#ç¬¬ä¸€æ®µå‡½æ•°void-InlineHook" class="headerlink" title="ç¬¬ä¸€æ®µå‡½æ•°void InlineHook()"></a>ç¬¬ä¸€æ®µå‡½æ•°<code>void InlineHook()</code></h6><h6 id="åˆå§‹å®šä¹‰"><a href="#åˆå§‹å®šä¹‰" class="headerlink" title="åˆå§‹å®šä¹‰"></a>åˆå§‹å®šä¹‰</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HMODULE hModule_User32 = LoadLibrary(<span class="string">L&quot;user32.dll&quot;</span>);</span><br><span class="line">__MessageBoxAddress = GetProcAddress(hModule_User32, <span class="string">&quot;MessageBoxA&quot;</span>);</span><br><span class="line"><span class="comment">//æ‰“å°MessageBoxAçš„åœ°å€</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;__MessageBoxAddress is %x\n&quot;</span>, __MessageBoxAddress);</span><br><span class="line"><span class="comment">//MyMessageBoxAçš„åœ°å€</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;MyMessageBoxA Addr is %x\n&quot;</span>, MyMessageBoxA);</span><br></pre></td></tr></table></figure>

<p>å…ˆè·å¾—user32.dllæ¨¡å—çš„å¥æŸ„ï¼Œå†ç”¨å¥æŸ„è·å¾—æ¨¡å—ä¸­MessageBoxAå‡½æ•°çš„åœ°å€ï¼ŒåŒæ—¶æ‰“å°MyMessageBoxçš„åœ°å€å’ŒMessageBoxAçš„åœ°å€</p>
<h6 id="è¯»å–å‰14å­—èŠ‚"><a href="#è¯»å–å‰14å­—èŠ‚" class="headerlink" title="è¯»å–å‰14å­—èŠ‚"></a>è¯»å–å‰14å­—èŠ‚</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»MessageBoxAå‡½æ•°çš„å‰14ä¸ªå­—èŠ‚</span></span><br><span class="line">HANDLE hProcess = OpenProcess(PROCESS_VM_READ | PROCESS_VM_WRITE | PROCESS_VM_OPERATION, FALSE, GetCurrentProcessId());</span><br><span class="line"><span class="keyword">if</span> (ReadProcessMemory(hProcess, __MessageBoxAddress, __OldCode, <span class="number">14</span>, <span class="literal">NULL</span>) == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ReadProcessMemory error\n&quot;</span>);</span><br><span class="line">    CloseHandle(hProcess);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°åŸå§‹MessageBoxAçš„ä»£ç </span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;__OldCode is &quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">14</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%02X &quot;</span>, __OldCode[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå…ˆè¯»å–MessageBoxAå‡½æ•°é‡Œçš„å‰åå››ä¸ªå­—èŠ‚ï¼Œå­˜å‚¨åœ¨_OldCodeä¸­ï¼Œåœ¨æ‰“å°å‰åå››å­—èŠ‚</p>
<p>è§£æä¸€ä¸‹<code>ReadProcessMemory</code>å‡½æ•°ï¼š ç”¨äºä»æŒ‡å®šè¿›ç¨‹çš„å†…å­˜ç©ºé—´ä¸­è¯»å–æ•°æ®ã€‚  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">ReadProcessMemory</span><span class="params">(</span></span><br><span class="line"><span class="params">  HANDLE  hProcess,      <span class="comment">// ç›®æ ‡è¿›ç¨‹çš„å¥æŸ„</span></span></span><br><span class="line"><span class="params">  LPCVOID lpBaseAddress, <span class="comment">// ç›®æ ‡å†…å­˜çš„èµ·å§‹åœ°å€</span></span></span><br><span class="line"><span class="params">  LPVOID  lpBuffer,      <span class="comment">// å­˜å‚¨è¯»å–æ•°æ®çš„ç¼“å†²åŒº</span></span></span><br><span class="line"><span class="params">  SIZE_T  nSize,         <span class="comment">// è¦è¯»å–çš„å­—èŠ‚æ•°</span></span></span><br><span class="line"><span class="params">  SIZE_T *lpNumberOfBytesRead <span class="comment">// å®é™…è¯»å–çš„å­—èŠ‚æ•°</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<h6 id="Hook14å­—èŠ‚"><a href="#Hook14å­—èŠ‚" class="headerlink" title="Hook14å­—èŠ‚"></a>Hook14å­—èŠ‚</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DWORD64 JmpAddress = (DWORD64)MyMessageBoxA;  <span class="comment">// 64 ä½åœ°å€</span></span><br><span class="line"><span class="comment">// æ„é€ æ–°å¤´éƒ¨ä»£ç </span></span><br><span class="line">__NewCode[<span class="number">0</span>] = <span class="number">0x48</span>;  <span class="comment">// 64 ä½æ“ä½œçš„å‰ç¼€</span></span><br><span class="line">__NewCode[<span class="number">1</span>] = <span class="number">0xB8</span>;  <span class="comment">// mov rax, [JmpAddr]</span></span><br><span class="line"><span class="built_in">memcpy</span>(&amp;__NewCode[<span class="number">2</span>], &amp;JmpAddress, <span class="number">8</span>);   <span class="comment">// å°† 64 ä½åœ°å€å†™å…¥</span></span><br><span class="line">__NewCode[<span class="number">10</span>] = <span class="number">0xFF</span>;  <span class="comment">// jmp rax</span></span><br><span class="line">__NewCode[<span class="number">11</span>] = <span class="number">0xE0</span>;  <span class="comment">// jmp rax</span></span><br><span class="line"><span class="comment">// æ‰“å°æ–°ä»£ç </span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;NewBytes are &quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">14</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%02X &quot;</span>, __NewCode[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™äº›ä½œç”¨å°±æ˜¯ç”¨åå››å­—èŠ‚å®ç°ï¼Œmov eax MyMessageBoxA  jmp eaxï¼Œäºæ˜¯å‡½æ•°å°±è¢«hookæˆè‡ªå·±çš„å‡½æ•°äº†ï¼Œåˆ›é€ ä¹‹åçœ‹çœ‹å­—èŠ‚ç å¯¹ä¸å¯¹</p>
<h6 id="å†™å…¥hook"><a href="#å†™å…¥hook" class="headerlink" title="å†™å…¥hook"></a>å†™å…¥hook</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DWORD dwOldProtect = 0; //æ—§ä¿æŠ¤å±æ€§</span></span><br><span class="line"><span class="comment">// å»å†…å­˜ä¿æŠ¤</span></span><br><span class="line">::VirtualProtect(__MessageBoxAddress, <span class="number">14</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line"><span class="comment">//å†™å…¥è·³è½¬ï¼Œå¼€å§‹Hook</span></span><br><span class="line">WriteProcessMemory(INVALID_HANDLE_VALUE, __MessageBoxAddress, __NewCode, <span class="number">14</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">// å†™å†…å­˜ä¿æŠ¤</span></span><br><span class="line">::VirtualProtect(__MessageBoxAddress, <span class="number">14</span>, dwOldProtect, &amp;dwOldProtect);</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå…¶å®æ²¡å•¥å¥½è¯´çš„çœ‹æ³¨é‡Šå°±å¥½ï¼Œå‡½æ•°çŒœçš„è¯ä¹ŸçŒœå‡ºæ¥äº†ï¼Œäºæ˜¯è¿™æ®µå‡½æ•°å°±ç»“æŸäº†</p>
<p>äºæ˜¯ç¨‹åºè¿”å›æ‰§è¡ŒMessageBoxAï¼Œæœ¬æ¥åº”è¯¥call MassageBoxAï¼Œå˜æˆäº†movä¸jmpï¼Œhookæˆäº†è¿›å…¥è‡ªå·±çš„å‡½æ•°</p>
<h4 id="InlineHookâ€“HotPatch"><a href="#InlineHookâ€“HotPatch" class="headerlink" title="InlineHookâ€“HotPatch"></a>InlineHookâ€“HotPatch</h4><p>ä¸€èˆ¬çš„hookéœ€è¦5å­—èŠ‚ï¼Œlock ä»€ä¹ˆçš„ï¼Œä¹Ÿæœ€å¤šåŒæ—¶æ“ä½œ4å­—èŠ‚ï¼Œå¦‚æœè¦ä¿®æ”¹5å­—èŠ‚ï¼Œä¸¥æ ¼è¯´æ¥æ˜¯è¦ä½¿ç”¨åŒæ­¥çš„ï¼Œä»¥é˜²æ­¢å…¶ä»–CPUè®¿é—®æ­£è¢«ä¿®æ”¹çš„æŒ‡ä»¤ã€‚</p>
<p>hotpatchçš„æŠ€æ³•åˆ™æ˜¯é¦–å…ˆåœ¨å‡½æ•°ä¸Šæ–¹ï¼Œä¸€èˆ¬ä¼šå› ä¸ºå¯¹é½ï¼Œæˆ–è€…ç¼–è¯‘æ—¶ä½¿ç”¨&#x2F;hotpatché€‰é¡¹è€Œé¢„ç•™å‡ºå‡ å­—èŠ‚çš„ç©ºé—´ï¼Œé¦–å…ˆåœ¨è¿™äº›ç©ºé—´é‡Œå†™å…¥ä¸€ä¸ª5å­—èŠ‚çš„è¿œç¨‹è·³è½¬ï¼Œç„¶åå†å°†å‡½æ•°çš„ä¿©å­—èŠ‚mov ediï¼ŒediæŒ‡ä»¤æ¢æˆä¸€ä¸ªè¿‘è·³è½¬ï¼Œè·³åˆ°ä¸Šæ–¹çš„é•¿è·³è½¬ä¸­ï¼Œ2å­—èŠ‚çš„ä¿®æ”¹ã€‚æ­¤ç§æŠ€æ³•å®Œå…¨ä¸ç”¨è€ƒè™‘åŒæ­¥â€¦</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xDragonx_/article/details/6241448">hotpatch çš„hook æ–¹å¼_hotpatch hook-CSDNåšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_30384217/article/details/95490108">â€œçƒ­è¡¥ä¸â€Hookï¼Œå¤šçº¿ç¨‹ä¸‹InlineHookè§£å†³æ–¹æ³•-CSDNåšå®¢</a></p>
<h5 id="æºç -1"><a href="#æºç -1" class="headerlink" title="æºç "></a>æºç </h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HotPatch.cpp : å®šä¹‰æ§åˆ¶å°åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#include &quot;stdafx.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span><span class="params">(WINAPI* pfnCreateprocessW)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSTARTUPINFO lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SetPrivilege</span><span class="params">(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">HOOKByHotpatch</span><span class="params">(LPWSTR wzDllName, LPCSTR szFuncName, PROC pfnNewFunc)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">UnhookByHotpatch</span><span class="params">(LPWSTR wzDllName, LPCSTR szFuncName)</span></span>;</span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">NewCreateProcessW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSTARTUPINFO lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">SetPrivilege</span>(SE_DEBUG_NAME, TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//hook</span></span><br><span class="line">    <span class="type">wchar_t</span> moduleName[] = <span class="string">L&quot;kernel32.dll&quot;</span>;  <span class="comment">// åˆ›å»ºä¸€ä¸ªéå¸¸é‡çš„æ•°ç»„</span></span><br><span class="line">    <span class="built_in">HOOKByHotpatch</span>(moduleName, <span class="string">&quot;CreateProcessW&quot;</span>, (PROC)NewCreateProcessW);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    STARTUPINFO si = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    si.cb = <span class="built_in">sizeof</span>(si);</span><br><span class="line">    si.dwFlags = STARTF_USESHOWWINDOW;</span><br><span class="line">    si.wShowWindow = SW_SHOW;</span><br><span class="line">    PROCESS_INFORMATION pi;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºè¿›ç¨‹</span></span><br><span class="line">    TCHAR cmdLine[MAXBYTE] = <span class="string">L&quot;notepad.exe&quot;</span>;</span><br><span class="line">    BOOL bOk = <span class="built_in">CreateProcess</span>(<span class="literal">NULL</span>, cmdLine,</span><br><span class="line">        <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">wchar_t</span> wzDllName[] = <span class="string">L&quot;kernel32.dll&quot;</span>;  <span class="comment">// åˆ›å»ºä¸€ä¸ªéå¸¸é‡å®½å­—ç¬¦æ•°ç»„</span></span><br><span class="line">    <span class="built_in">UnhookByHotpatch</span>(wzDllName, <span class="string">&quot;CreateProcessW&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®æƒé™</span></span><br><span class="line"><span class="function">BOOL <span class="title">SetPrivilege</span><span class="params">(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TOKEN_PRIVILEGES TokenPrivileges;<span class="comment">//æƒé™ä»¤ç‰Œ</span></span><br><span class="line">    HANDLE TokenHandle = <span class="literal">NULL</span>;       <span class="comment">//æƒé™ä»¤ç‰Œå¥æŸ„</span></span><br><span class="line">    LUID   Luid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">OpenProcessToken</span>(<span class="built_in">GetCurrentProcess</span>(),</span><br><span class="line">        TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY,</span><br><span class="line">        &amp;TokenHandle))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;OpenProcessToken error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">LookupPrivilegeValue</span>(<span class="literal">NULL</span>,             <span class="comment">// lookup privilege on local system</span></span><br><span class="line">        lpszPrivilege,    <span class="comment">// privilege to lookup </span></span><br><span class="line">        &amp;Luid))           <span class="comment">// receives LUID of privilege</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;LookupPrivilegeValue error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TokenPrivileges.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">    TokenPrivileges.Privileges[<span class="number">0</span>].Luid = Luid;</span><br><span class="line">    <span class="keyword">if</span> (bEnablePrivilege)</span><br><span class="line">        TokenPrivileges.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        TokenPrivileges.Privileges[<span class="number">0</span>].Attributes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable the privilege or disable all privileges.</span></span><br><span class="line">    <span class="comment">//è°ƒæ•´æƒé™</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">AdjustTokenPrivileges</span>(TokenHandle,</span><br><span class="line">        FALSE,</span><br><span class="line">        &amp;TokenPrivileges,</span><br><span class="line">        <span class="built_in">sizeof</span>(TOKEN_PRIVILEGES),</span><br><span class="line">        (PTOKEN_PRIVILEGES)<span class="literal">NULL</span>,</span><br><span class="line">        (PDWORD)<span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;AdjustTokenPrivileges error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">GetLastError</span>() == ERROR_NOT_ALL_ASSIGNED)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The token does not have the specified privilege. \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Hootpatchï¼Œå°†å‡½æ•°é¦–å­—èŠ‚æ”¹ä¸º short jmpï¼ˆEB F9ï¼‰</span></span><br><span class="line"><span class="function">BOOL <span class="title">HOOKByHotpatch</span><span class="params">(LPWSTR wzDllName, LPCSTR szFuncName, PROC pfnNewFunc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FARPROC pOrgFuncAddr = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD   dwOldProtect, dwAddress;</span><br><span class="line">    BYTE    pBuf[<span class="number">5</span>] = &#123; <span class="number">0xE9</span>, <span class="number">0</span>, &#125;;</span><br><span class="line">    BYTE    pBuf2[<span class="number">2</span>] = &#123; <span class="number">0xEB</span>, <span class="number">0xF9</span> &#125;;</span><br><span class="line">    PBYTE   pByte;</span><br><span class="line"></span><br><span class="line">    pOrgFuncAddr = (FARPROC)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(wzDllName), szFuncName);</span><br><span class="line">    pByte = (PBYTE)pOrgFuncAddr;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦è¢«å‹¾</span></span><br><span class="line">    <span class="keyword">if</span> (pByte[<span class="number">0</span>] == <span class="number">0xEB</span>)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†å‰äº”å­—èŠ‚ä»£ç æ”¹ä¸ºå¯è¯»å¯å†™</span></span><br><span class="line">    <span class="built_in">VirtualProtect</span>((LPVOID)((DWORD)pOrgFuncAddr - <span class="number">5</span>), <span class="number">7</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. NOP (0x90)</span></span><br><span class="line">    <span class="comment">//å°†å‰äº”å­—èŠ‚æ”¹ä¸ºE8 xxxxxxxx</span></span><br><span class="line">    dwAddress = (DWORD)pfnNewFunc - (DWORD)pOrgFuncAddr;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;pBuf[<span class="number">1</span>], &amp;dwAddress, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>((LPVOID)((DWORD)pOrgFuncAddr - <span class="number">5</span>), pBuf, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. MOV EDI, EDI (0x8BFF)</span></span><br><span class="line">    <span class="comment">//å°†å‡½æ•°å‰ä¸¤ä¸ªå­—èŠ‚æ”¹ä¸ºEB F9</span></span><br><span class="line">    <span class="built_in">memcpy</span>(pOrgFuncAddr, pBuf2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualProtect</span>((LPVOID)((DWORD)pOrgFuncAddr - <span class="number">5</span>), <span class="number">7</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">UnhookByHotpatch</span><span class="params">(LPWSTR wzDllName, LPCSTR szFuncName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FARPROC pHookFunc = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD   dwOldProtect;</span><br><span class="line">    PBYTE   pByte;</span><br><span class="line">    BYTE    pBuf[<span class="number">5</span>] = &#123; <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span>, <span class="number">0x90</span> &#125;;</span><br><span class="line">    BYTE    pBuf2[<span class="number">2</span>] = &#123; <span class="number">0x8B</span>, <span class="number">0xFF</span> &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pHookFunc = (FARPROC)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(wzDllName), szFuncName);</span><br><span class="line">    pByte = (PBYTE)pHookFunc;</span><br><span class="line">    <span class="keyword">if</span> (pByte[<span class="number">0</span>] != <span class="number">0xEB</span>)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualProtect</span>((LPVOID)pHookFunc, <span class="number">5</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. NOP (0x90)</span></span><br><span class="line">    <span class="built_in">memcpy</span>((LPVOID)((DWORD)pHookFunc - <span class="number">5</span>), pBuf, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. MOV EDI, EDI (0x8BFF)</span></span><br><span class="line">    <span class="built_in">memcpy</span>(pHookFunc, pBuf2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualProtect</span>((LPVOID)pHookFunc, <span class="number">5</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">NewCreateProcessW</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPTSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPCTSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPSTARTUPINFO lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, <span class="string">L&quot;Hook&quot;</span>, <span class="string">L&quot;&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h5><p>è€è§„çŸ©ï¼ŒæŒ‰ç…§ä¸»å‡½æ•°è°ƒç”¨é¡ºåºåˆ†æ</p>
<h6 id="SetPrivilege"><a href="#SetPrivilege" class="headerlink" title="SetPrivilege"></a>SetPrivilege</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">SetPrivilege</span><span class="params">(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TOKEN_PRIVILEGES TokenPrivileges;<span class="comment">//æƒé™ä»¤ç‰Œ</span></span><br><span class="line">    HANDLE TokenHandle = <span class="literal">NULL</span>;       <span class="comment">//æƒé™ä»¤ç‰Œå¥æŸ„</span></span><br><span class="line">    LUID   Luid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">OpenProcessToken</span>(<span class="built_in">GetCurrentProcess</span>(),</span><br><span class="line">        TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY,</span><br><span class="line">        &amp;TokenHandle))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;OpenProcessToken error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">LookupPrivilegeValue</span>(<span class="literal">NULL</span>,             <span class="comment">// lookup privilege on local system</span></span><br><span class="line">        lpszPrivilege,    <span class="comment">// privilege to lookup </span></span><br><span class="line">        &amp;Luid))           <span class="comment">// receives LUID of privilege</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;LookupPrivilegeValue error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TokenPrivileges.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">    TokenPrivileges.Privileges[<span class="number">0</span>].Luid = Luid;</span><br><span class="line">    <span class="keyword">if</span> (bEnablePrivilege)</span><br><span class="line">        TokenPrivileges.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        TokenPrivileges.Privileges[<span class="number">0</span>].Attributes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable the privilege or disable all privileges.</span></span><br><span class="line">    <span class="comment">//è°ƒæ•´æƒé™</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">AdjustTokenPrivileges</span>(TokenHandle,</span><br><span class="line">        FALSE,</span><br><span class="line">        &amp;TokenPrivileges,</span><br><span class="line">        <span class="built_in">sizeof</span>(TOKEN_PRIVILEGES),</span><br><span class="line">        (PTOKEN_PRIVILEGES)<span class="literal">NULL</span>,</span><br><span class="line">        (PDWORD)<span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;AdjustTokenPrivileges error: %u\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">GetLastError</span>() == ERROR_NOT_ALL_ASSIGNED)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The token does not have the specified privilege. \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®æƒé™å‡½æ•°</p>
<h6 id="HOOKByHotpatch"><a href="#HOOKByHotpatch" class="headerlink" title="HOOKByHotpatch"></a>HOOKByHotpatch</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">HOOKByHotpatch</span><span class="params">(LPWSTR wzDllName, LPCSTR szFuncName, PROC pfnNewFunc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FARPROC pOrgFuncAddr = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD   dwOldProtect, dwAddress;</span><br><span class="line">    BYTE    pBuf[<span class="number">5</span>] = &#123; <span class="number">0xE9</span>, <span class="number">0</span>, &#125;;</span><br><span class="line">    BYTE    pBuf2[<span class="number">2</span>] = &#123; <span class="number">0xEB</span>, <span class="number">0xF9</span> &#125;;</span><br><span class="line">    PBYTE   pByte;</span><br><span class="line"></span><br><span class="line">    pOrgFuncAddr = (FARPROC)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(wzDllName), szFuncName);</span><br><span class="line">    pByte = (PBYTE)pOrgFuncAddr;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦è¢«å‹¾</span></span><br><span class="line">    <span class="keyword">if</span> (pByte[<span class="number">0</span>] == <span class="number">0xEB</span>)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†å‰äº”å­—èŠ‚ä»£ç æ”¹ä¸ºå¯è¯»å¯å†™</span></span><br><span class="line">    <span class="built_in">VirtualProtect</span>((LPVOID)((DWORD)pOrgFuncAddr - <span class="number">5</span>), <span class="number">7</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. NOP (0x90)</span></span><br><span class="line">    <span class="comment">//å°†å‰äº”å­—èŠ‚æ”¹ä¸ºE8 xxxxxxxx</span></span><br><span class="line">    dwAddress = (DWORD)pfnNewFunc - (DWORD)pOrgFuncAddr;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;pBuf[<span class="number">1</span>], &amp;dwAddress, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>((LPVOID)((DWORD)pOrgFuncAddr - <span class="number">5</span>), pBuf, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. MOV EDI, EDI (0x8BFF)</span></span><br><span class="line">    <span class="comment">//å°†å‡½æ•°å‰ä¸¤ä¸ªå­—èŠ‚æ”¹ä¸ºEB F9</span></span><br><span class="line">    <span class="built_in">memcpy</span>(pOrgFuncAddr, pBuf2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualProtect</span>((LPVOID)((DWORD)pOrgFuncAddr - <span class="number">5</span>), <span class="number">7</span>, dwOldProtect, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸€ç›´åœ¨æŠ¥é”™ä¸€ç›´æä¸å®šï¼Œç­‰å¼€å§‹å†™é¡¹ç›®äº†å›æ¥ä¿®è¡¥ï¼Œå¤§è‡´æ„æ€çœ‹ä¸¤éå°±çŸ¥é“äº†</p>
<h4 id="InlineHookâ€“call"><a href="#InlineHookâ€“call" class="headerlink" title="InlineHookâ€“call"></a>InlineHookâ€“call</h4><h5 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h5><p>è¿™é‡Œåˆ†ä¸ºä¸¤ç§ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨è¿è¡Œä¸€ä¸ªå‡½æ•°ä¹‹å‰ï¼Œä¼š<code>call &lt;ä½ ç”¨çš„å‡½æ•°&gt;</code>ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæ”¹åŠ¨ï¼Œä½¿å…¶å˜æˆ</p>
<p><code>call &lt;æˆ‘çš„å‡½æ•°&gt;</code></p>
<p>å¦‚æœè°ƒç”¨çš„æ˜¯IATå‡½æ•°ï¼Œå°†å…ˆä½¿ç”¨ <code>FF 15 &lt;IATè¡¨&gt;</code>ï¼Œå¯¹IATè¡¨ä¸­çš„å‡½æ•°åœ°å€ï¼Œå®ç°è·³è½¬ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥è‡ªå·±å…ˆç”³è¯·ä¸€å—åœ°å€ï¼Œå†æŠŠè‡ªå·±å†™çš„å‡½æ•°æ”¾åœ¨åœ°å€ä¸Šï¼Œå®ç°è·³è½¬ï¼Œå°±ç›¸å½“äºå’Œä¸Šæ–‡ä¸€æ ·å®ç°äº†<code>FF 15 &lt;ç”³è¯·çš„åœ°å€è¡¨&gt;</code>ï¼Œå¯¹è‡ªå·±ç”³è¯·çš„åœ°å€ä¸­å­˜æ”¾çš„åœ°å€ï¼Œå®ç°è·³è½¬ï¼Œä¸è¿‡è¿™é‡Œä¼šå‡ºç°é—®é¢˜æˆ‘éƒ½ä¼šåœ¨æ„Ÿæ‚Ÿä¸­æåˆ°</p>
<p>å¦‚æœç”¨çš„æ˜¯E8callè·³è½¬ï¼Œé‚£å°±ç›´æ¥æ¢E8åé¢çš„å€¼å°±å¥½</p>
<h3 id="åŸºäºå¼‚å¸¸å¤„ç†çš„Hook"><a href="#åŸºäºå¼‚å¸¸å¤„ç†çš„Hook" class="headerlink" title="åŸºäºå¼‚å¸¸å¤„ç†çš„Hook"></a>åŸºäºå¼‚å¸¸å¤„ç†çš„Hook</h3><p>è¿™ä¸ªæ¯”æˆ‘æƒ³è±¡çš„å¥½ç©</p>
<h4 id="åŸç†-2"><a href="#åŸç†-2" class="headerlink" title="åŸç†"></a>åŸç†</h4><p><strong>å‘é‡åŒ–å¼‚å¸¸å¤„ç†ï¼ˆVectored Exception Handlingï¼ŒVEHï¼‰</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªæ‰©å±•çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå…è®¸æ³¨å†Œå¼‚å¸¸å¤„ç†ç¨‹åºï¼Œä»¥ä¾¿åœ¨ç¨‹åºå‘ç”Ÿå¼‚å¸¸æ—¶æ¥ç®¡å¤„ç†ã€‚  </p>
<p>æ‰‹åŠ¨çš„å¯¹ä½ æ¥ä¸‹æ¥è¦è¿›è¡Œçš„å‡½æ•°è®¾ç½®æ–­ç‚¹ï¼ˆ0xCCï¼‰ï¼Œåœ¨æ•è·å¼‚å¸¸åç”¨è‡ªå·±çš„æ–¹æ³•ä¿®å¤å¼‚å¸¸ï¼Œåœ¨ä¿®å¤çš„æ—¶å€™å°±å¯ä»¥è¿›é¡¹hookäº†</p>
<h4 id="æºç -2"><a href="#æºç -2" class="headerlink" title="æºç "></a>æºç </h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*-----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">ç¬¬13ç«   HookæŠ€æœ¯</span></span><br><span class="line"><span class="comment">ã€ŠåŠ å¯†ä¸è§£å¯†ï¼ˆç¬¬å››ç‰ˆï¼‰ã€‹</span></span><br><span class="line"><span class="comment">(c)  çœ‹é›ªå­¦é™¢ www.kanxue.com 2000-2018</span></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// VEHHook.cpp : Defines the entry point for the console application.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">SetBreakPoint</span><span class="params">(PVOID pFuncAddr)</span>;</span><br><span class="line">BOOL <span class="title function_">ClearBreakPoint</span><span class="params">(PVOID pFuncAddr)</span>;</span><br><span class="line">BOOL <span class="title function_">InstallVEHHook</span><span class="params">(PVECTORED_EXCEPTION_HANDLER Handler)</span>;</span><br><span class="line">VOID <span class="title function_">UnInstallVEHHook</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> </span><br><span class="line"><span class="params">(WINAPI *PFN_MessageBox)</span><span class="params">(</span></span><br><span class="line"><span class="params">	HWND hWnd,          <span class="comment">// handle of owner window</span></span></span><br><span class="line"><span class="params">	LPCTSTR lpText,     <span class="comment">// address of text in message box</span></span></span><br><span class="line"><span class="params">	LPCTSTR lpCaption,  <span class="comment">// address of title of message box</span></span></span><br><span class="line"><span class="params">	UINT uType          <span class="comment">// style of message box</span></span></span><br><span class="line"><span class="params">	)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> WINAPI <span class="title function_">My_MessageBox</span><span class="params">(</span></span><br><span class="line"><span class="params">	HWND hWnd,          <span class="comment">// handle of owner window</span></span></span><br><span class="line"><span class="params">	LPCTSTR lpText,     <span class="comment">// address of text in message box</span></span></span><br><span class="line"><span class="params">	LPCTSTR lpCaption,  <span class="comment">// address of title of message box</span></span></span><br><span class="line"><span class="params">	UINT uType          <span class="comment">// style of message box</span></span></span><br><span class="line"><span class="params">	)</span>;</span><br><span class="line"></span><br><span class="line">LONG WINAPI <span class="title function_">VectoredHandler1</span><span class="params">(<span class="keyword">struct</span> _EXCEPTION_POINTERS *ExceptionInfo)</span>;</span><br><span class="line">LONG WINAPI <span class="title function_">VectoredHandler2</span><span class="params">(<span class="keyword">struct</span> _EXCEPTION_POINTERS *ExceptionInfo)</span>;</span><br><span class="line">LONG WINAPI <span class="title function_">VectoredHandler3</span><span class="params">(<span class="keyword">struct</span> _EXCEPTION_POINTERS *ExceptionInfo)</span>;</span><br><span class="line">VOID <span class="title function_">ShowMsgBox</span><span class="params">(LPCTSTR lpMsg)</span>;</span><br><span class="line">ULONG_PTR <span class="title function_">InitTrampolineFun</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">PFN_MessageBox g_OriginalMessageBoxA;</span><br><span class="line">PVOID g_AddrofMessageBoxA = <span class="number">0</span> ;</span><br><span class="line">PVOID g_hVector;</span><br><span class="line">BYTE  g_OldCode[<span class="number">16</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	HMODULE hUser32 = LoadLibrary(<span class="string">&quot;user32.dll&quot;</span>);</span><br><span class="line">	g_AddrofMessageBoxA =  (PVOID)GetProcAddress(hUser32,<span class="string">&quot;MessageBoxA&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Address of MessageBoxA = 0x%p\n&quot;</span>,g_AddrofMessageBoxA);</span><br><span class="line">	g_OriginalMessageBoxA = (PFN_MessageBox)InitTrampolineFun();  <span class="comment">//è·³è¿‡å¼€å¤´çš„Hook</span></span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Addr of VectoredHandler1 = 0x%p\n&quot;</span>,VectoredHandler1);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Addr of VectoredHandler2 = 0x%p\n&quot;</span>,VectoredHandler2);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Addr of VectoredHandler3 = 0x%p\n&quot;</span>,VectoredHandler3);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//é€‰æ‹©å®‰è£…ä¸€ä¸ªè¿›è¡Œæµ‹è¯•</span></span><br><span class="line">	InstallVEHHook(VectoredHandler2);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//è®¾ç½®æ–­ç‚¹</span></span><br><span class="line">	SetBreakPoint(g_AddrofMessageBoxA);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//call</span></span><br><span class="line">	ShowMsgBox(<span class="string">&quot;VEH Hook Test.&quot;</span>);</span><br><span class="line">	<span class="comment">//ShowMsgBox(&quot;uihae&quot;);</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;All Finished!\n&quot;</span>);</span><br><span class="line">	ClearBreakPoint(g_AddrofMessageBoxA);</span><br><span class="line">	UnInstallVEHHook();</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	ShowMsgBox(<span class="string">&quot;Hook Cleared&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">ShowMsgBox</span><span class="params">(LPCTSTR lpMsg)</span></span><br><span class="line">&#123;</span><br><span class="line">	MessageBoxA(<span class="literal">NULL</span>,lpMsg,<span class="string">&quot;Test&quot;</span>,MB_OK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ULONG_PTR <span class="title function_">InitTrampolineFun</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	ULONG_PTR uResult = <span class="number">0</span> ;</span><br><span class="line">	PBYTE pFun = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line">	<span class="comment">//x64éœ€è¦ç”³è¯·shellcode</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	USER32!MessageBoxA:</span></span><br><span class="line"><span class="comment">	00000000`779412b8 4883ec38        sub     rsp,38h</span></span><br><span class="line"><span class="comment">	00000000`779412bc 4533db          xor     r11d,r11d</span></span><br><span class="line"><span class="comment">	00000000`779412bf 44391d760e0200  cmp     dword ptr [USER32!gapfnScSendMessage+0x927c (00000000`7796213c)],r11d</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	pFun = (PBYTE)VirtualAlloc(<span class="literal">NULL</span>,<span class="number">128</span>,MEM_COMMIT,PAGE_EXECUTE_READWRITE);</span><br><span class="line">	uResult = (ULONG_PTR)pFun;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;uResult:%p\n&quot;</span>, uResult);</span><br><span class="line">	<span class="built_in">memset</span>(pFun,<span class="number">0</span>,<span class="number">128</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(pFun,(PVOID)g_AddrofMessageBoxA,<span class="number">4</span>); <span class="comment">//æ‹·è´ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œ4å­—èŠ‚,æ¨èä½¿ç”¨åæ±‡ç¼–å¼•æ“æ¥å®é™…è®¡ç®—</span></span><br><span class="line">	pFun += <span class="number">4</span> ; <span class="comment">//ä¸‹ä¸€æ¡æŒ‡ä»¤æ„é€ ä¸ºjmp [xxxxxx]</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;pFun:%p\n&quot;</span>, pFun);</span><br><span class="line">	pFun[<span class="number">0</span>] = <span class="number">0xFF</span>;</span><br><span class="line">	pFun[<span class="number">1</span>] = <span class="number">0x25</span>;</span><br><span class="line">	<span class="comment">//è¿™é‡Œç›¸å½“äºæŠŠåŸå‡½æ•°åé¢4ä¸ªå­—èŠ‚åé¢çš„å†…å®¹ç»™ä¿å­˜ä¸‹æ¥ï¼Œå¥½è·³è½¬ã€‚</span></span><br><span class="line">	*(ULONG_PTR*)(pFun + <span class="number">6</span>) = (ULONG_PTR)g_AddrofMessageBoxA + <span class="number">4</span> ; <span class="comment">//è·³å›åˆ°åŸå‡½æ•°åŠ 4çš„åœ°æ–¹</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="comment">//x86,ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯mov edi,edi,ç›´æ¥è·³è¿‡å³å¯</span></span><br><span class="line">	uResult = (ULONG_PTR)g_AddrofMessageBoxA + <span class="number">2</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> uResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤„ç†æ–¹å¼ï¼Œä¿®æ”¹å‚æ•°å¹¶è¿”å›åŸå‡½æ•°ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">LONG WINAPI</span><br><span class="line"><span class="title function_">VectoredHandler1</span><span class="params">(</span></span><br><span class="line"><span class="params">	<span class="keyword">struct</span> _EXCEPTION_POINTERS *ExceptionInfo</span></span><br><span class="line"><span class="params">	)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> *szNewMsg =  <span class="string">&quot;[VectoredHandler1] Hacked by pediy.com&quot;</span>;</span><br><span class="line">	LONG lResult = EXCEPTION_CONTINUE_SEARCH;</span><br><span class="line">	PEXCEPTION_RECORD pExceptionRecord = ExceptionInfo-&gt;ExceptionRecord;</span><br><span class="line">	PCONTEXT pContextRecord = ExceptionInfo-&gt;ContextRecord;</span><br><span class="line">	ULONG_PTR* uESP = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Exception Address = %p\n&quot;</span>,pExceptionRecord-&gt;ExceptionAddress);</span><br><span class="line">	<span class="keyword">if</span> (pExceptionRecord-&gt;ExceptionCode == EXCEPTION_BREAKPOINT</span><br><span class="line">		&amp;&amp; pExceptionRecord-&gt;ExceptionAddress == g_AddrofMessageBoxA)</span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line">		<span class="comment">//x64ä¸Šå‰å››ä¸ªå‚æ•°ä¾æ¬¡ä¸ºRCX,RDX,R8,R9</span></span><br><span class="line">		<span class="comment">//ä¿®æ”¹ç¬¬äºŒä¸ªå‚æ•°ï¼Œå³LpMsg</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;lpText = 0x%p   %s\n&quot;</span>,pContextRecord-&gt;Rdx,(<span class="type">char</span>*)pContextRecord-&gt;Rdx);</span><br><span class="line">		pContextRecord-&gt;Rdx = (ULONG_PTR)szNewMsg;</span><br><span class="line">		pContextRecord-&gt;Rip = (ULONG_PTR)g_OriginalMessageBoxA ; <span class="comment">//è·³åˆ°Trampolineç»§ç»­æ‰§è¡Œ</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		0012FF70   0040105A   /CALL åˆ° MessageBoxA æ¥è‡ª VEHHook.00401054</span></span><br><span class="line"><span class="comment">		0012FF74   00000000   |hOwner = NULL</span></span><br><span class="line"><span class="comment">		0012FF78   00407030   |Text = &quot;VEH Hook&quot;</span></span><br><span class="line"><span class="comment">		0012FF7C   0040703C   |Title = &quot;Test&quot;</span></span><br><span class="line"><span class="comment">		0012FF80   00000000   \Style = MB_OK|MB_APPLMODAL</span></span><br><span class="line"><span class="comment">		0012FF84   00401225   è¿”å›åˆ° VEHHook.&lt;ModuleEntryPoint&gt;+0B4 æ¥è‡ª VEHHook.00401000</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ESP = 0x%p\n&quot;</span>,pContextRecord-&gt;Esp) ;</span><br><span class="line">		uESP = (ULONG_PTR*)pContextRecord-&gt;Esp ; <span class="comment">//å–ä¸­æ–­æ—¶çš„ESP</span></span><br><span class="line">		uESP[<span class="number">2</span>] = (ULONG_PTR)szNewMsg; <span class="comment">//ä¿®æ”¹æ ˆä¸­çš„å‚æ•°</span></span><br><span class="line">		pContextRecord-&gt;Eip = (ULONG_PTR)g_OriginalMessageBoxA ; <span class="comment">//è·³è¿‡å‡½æ•°å¼€å¤´</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		</span><br><span class="line">		lResult = EXCEPTION_CONTINUE_EXECUTION ;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> lResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤„ç†æ–¹å¼ï¼šç›´æ¥è°ƒç”¨åŸå‡½æ•°å¹¶æ›¿åŸå‡½æ•°è¿”å›</span></span><br><span class="line">LONG WINAPI</span><br><span class="line"><span class="title function_">VectoredHandler2</span><span class="params">(</span></span><br><span class="line"><span class="params">	<span class="keyword">struct</span> _EXCEPTION_POINTERS *ExceptionInfo</span></span><br><span class="line"><span class="params">	)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> *szNewMsg =  <span class="string">&quot;[VectoredHandler2] Hacked by pediy.com&quot;</span>;</span><br><span class="line">	LONG lResult = EXCEPTION_CONTINUE_SEARCH;</span><br><span class="line">	PEXCEPTION_RECORD pExceptionRecord = ExceptionInfo-&gt;ExceptionRecord;</span><br><span class="line">	PCONTEXT pContextRecord = ExceptionInfo-&gt;ContextRecord;</span><br><span class="line">	ULONG_PTR* uESP = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (pExceptionRecord-&gt;ExceptionCode == EXCEPTION_BREAKPOINT</span><br><span class="line">		&amp;&amp; pExceptionRecord-&gt;ExceptionAddress == g_AddrofMessageBoxA)</span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line">		<span class="comment">//x64ä¸Šå‰å››ä¸ªå‚æ•°ä¾æ¬¡ä¸ºRCX,RDX,R8,R9</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;RSP = 0x%p\n&quot;</span>,pContextRecord-&gt;Rsp) ;</span><br><span class="line">		uESP = (ULONG_PTR*)pContextRecord-&gt;Rsp ;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Return Address = 0x%p\n&quot;</span>,uESP[<span class="number">0</span>]);</span><br><span class="line">		ret = g_OriginalMessageBoxA((HWND)pContextRecord-&gt;Rcx,szNewMsg,(LPCTSTR)pContextRecord-&gt;R8,(<span class="type">int</span>)pContextRecord-&gt;R9);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ret = %d\n&quot;</span>,ret);</span><br><span class="line">		<span class="comment">//ä¿®æ­£RSP</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;RSP(before) = 0x%p\n&quot;</span>, pContextRecord-&gt;Rsp);</span><br><span class="line">		pContextRecord-&gt;Rsp += <span class="keyword">sizeof</span>(ULONG_PTR);<span class="comment">//å‚æ•°åœ¨å¯„å­˜å™¨ä¸­ï¼Œæ ˆä¸­æ— å‚æ•°ï¼Œä»…éœ€è·³è¿‡è¿”å›åœ°å€</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;RSP(after) = 0x%p\n&quot;</span>, pContextRecord-&gt;Rsp);</span><br><span class="line">		<span class="comment">//ç›´æ¥è¿”å›åˆ°è°ƒç”¨è€…å¤„</span></span><br><span class="line">		pContextRecord-&gt;Rip = uESP[<span class="number">0</span>] ;<span class="comment">//è®¾ç½®EIPä¸ºè¿”å›åœ°å€</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		0012FF70   0040105A   /CALL åˆ° MessageBoxA æ¥è‡ª VEHHook.00401054</span></span><br><span class="line"><span class="comment">		0012FF74   00000000   |hOwner = NULL</span></span><br><span class="line"><span class="comment">		0012FF78   00407030   |Text = &quot;VEH Hook&quot;</span></span><br><span class="line"><span class="comment">		0012FF7C   0040703C   |Title = &quot;Test&quot;</span></span><br><span class="line"><span class="comment">		0012FF80   00000000   \Style = MB_OK|MB_APPLMODAL</span></span><br><span class="line"><span class="comment">		0012FF84   00401225   è¿”å›åˆ° VEHHook.&lt;ModuleEntryPoint&gt;+0B4 æ¥è‡ª VEHHook.00401000</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ESP = 0x%p\n&quot;</span>,pContextRecord-&gt;Esp) ;</span><br><span class="line">		uESP = (ULONG_PTR*)pContextRecord-&gt;Esp ;</span><br><span class="line">		ret = g_OriginalMessageBoxA((HWND)uESP[<span class="number">1</span>],szNewMsg,(LPCTSTR)uESP[<span class="number">3</span>],(<span class="type">int</span>)uESP[<span class="number">4</span>]);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ret = %d\n&quot;</span>,ret);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//ç›´æ¥è¿”å›åˆ°è°ƒç”¨è€…å¤„</span></span><br><span class="line">		pContextRecord-&gt;Eip = uESP[<span class="number">0</span>] ;<span class="comment">//è®¾ç½®EIPä¸ºè¿”å›åœ°å€</span></span><br><span class="line">		pContextRecord-&gt;Esp += (<span class="number">4</span> + <span class="number">1</span>)*<span class="keyword">sizeof</span>(ULONG_PTR); <span class="comment">//4ä¸ºå‚æ•°ä¸ªæ•°,1ä¸ºè¿”å›åœ°å€</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		</span><br><span class="line">		lResult = EXCEPTION_CONTINUE_EXECUTION ;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> lResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤„ç†æ–¹å¼ï¼šç›´æ¥è¿”å›,ç›¸å½“äºè¿‡æ»¤æ‰</span></span><br><span class="line">LONG WINAPI</span><br><span class="line"><span class="title function_">VectoredHandler3</span><span class="params">(</span></span><br><span class="line"><span class="params">	<span class="keyword">struct</span> _EXCEPTION_POINTERS *ExceptionInfo</span></span><br><span class="line"><span class="params">	)</span></span><br><span class="line">&#123;</span><br><span class="line">	LONG lResult = EXCEPTION_CONTINUE_SEARCH ;</span><br><span class="line">	PEXCEPTION_RECORD pExceptionRecord = ExceptionInfo-&gt;ExceptionRecord ;</span><br><span class="line">	PCONTEXT pContextRecord = ExceptionInfo-&gt;ContextRecord ;</span><br><span class="line">	ULONG_PTR* uESP = <span class="number">0</span> ;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (pExceptionRecord-&gt;ExceptionCode == EXCEPTION_BREAKPOINT</span><br><span class="line">		&amp;&amp; pExceptionRecord-&gt;ExceptionAddress == g_AddrofMessageBoxA)</span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		0012FF70   0040105A   /CALL åˆ° MessageBoxA æ¥è‡ª VEHHook.00401054</span></span><br><span class="line"><span class="comment">		0012FF74   00000000   |hOwner = NULL</span></span><br><span class="line"><span class="comment">		0012FF78   00407030   |Text = &quot;VEH Hook&quot;</span></span><br><span class="line"><span class="comment">		0012FF7C   0040703C   |Title = &quot;Test&quot;</span></span><br><span class="line"><span class="comment">		0012FF80   00000000   \Style = MB_OK|MB_APPLMODAL</span></span><br><span class="line"><span class="comment">		0012FF84   00401225   è¿”å›åˆ° VEHHook.&lt;ModuleEntryPoint&gt;+0B4 æ¥è‡ª VEHHook.00401000</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">		<span class="comment">//ç›´æ¥è¿”å›åˆ°è°ƒç”¨è€…å¤„</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN64</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;RSP = 0x%p\n&quot;</span>,pContextRecord-&gt;Rsp) ;</span><br><span class="line">		uESP = (ULONG_PTR*)pContextRecord-&gt;Rsp ;</span><br><span class="line">		pContextRecord-&gt;Rip = uESP[<span class="number">0</span>] ;<span class="comment">//è®¾ç½®EIPä¸ºè¿”å›åœ°å€</span></span><br><span class="line">		pContextRecord-&gt;Rsp += <span class="keyword">sizeof</span>(ULONG_PTR); <span class="comment">//å°†å‹å…¥æ ˆå†…çš„å‚æ•°å’Œè¿”å›åœ°å€æ¸…ç†æ‰,4ä¸ºå‚æ•°ä¸ªæ•°,1ä¸ºè¿”å›åœ°å€</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ESP = 0x%X\n&quot;</span>,pContextRecord-&gt;Esp) ;</span><br><span class="line">		uESP = (ULONG_PTR*)pContextRecord-&gt;Esp ;</span><br><span class="line">		pContextRecord-&gt;Eip = uESP[<span class="number">0</span>] ;<span class="comment">//è®¾ç½®EIPä¸ºè¿”å›åœ°å€</span></span><br><span class="line">		pContextRecord-&gt;Esp += (<span class="number">4</span> + <span class="number">1</span>)*<span class="keyword">sizeof</span>(ULONG_PTR); <span class="comment">//å°†å‹å…¥æ ˆå†…çš„å‚æ•°å’Œè¿”å›åœ°å€æ¸…ç†æ‰,4ä¸ºå‚æ•°ä¸ªæ•°,1ä¸ºè¿”å›åœ°å€</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		</span><br><span class="line">		lResult = EXCEPTION_CONTINUE_EXECUTION ;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> lResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">InstallVEHHook</span><span class="params">(PVECTORED_EXCEPTION_HANDLER Handler)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Current Handler Address = 0x%p\n&quot;</span>,Handler);</span><br><span class="line">	g_hVector = AddVectoredExceptionHandler(<span class="number">1</span>,Handler);</span><br><span class="line">	<span class="keyword">return</span> g_hVector != <span class="literal">NULL</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">UnInstallVEHHook</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	RemoveVectoredExceptionHandler(g_hVector);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">0:000&gt; u user32!messageboxA</span></span><br><span class="line"><span class="comment">USER32!MessageBoxA:</span></span><br><span class="line"><span class="comment">77d507ea 8bff            mov     edi,edi</span></span><br><span class="line"><span class="comment">77d507ec 55              push    ebp</span></span><br><span class="line"><span class="comment">77d507ed 8bec            mov     ebp,esp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">BOOL <span class="title function_">SetBreakPoint</span><span class="params">(PVOID pFuncAddr)</span></span><br><span class="line">&#123;</span><br><span class="line">	DWORD dwCnt = <span class="number">0</span> ;</span><br><span class="line">	BYTE *pTarget = (BYTE*)pFuncAddr;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	g_OldCode[<span class="number">0</span>] = *pTarget;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Original Fun Head Code = 0x%02X\n&quot;</span>,g_OldCode[<span class="number">0</span>]);</span><br><span class="line">	<span class="comment">//ä¿®æ”¹å†…å­˜é¡µçš„å±æ€§</span></span><br><span class="line">	DWORD dwOLD;</span><br><span class="line">	MEMORY_BASIC_INFORMATION  mbi;</span><br><span class="line">	VirtualQuery(pTarget,&amp;mbi,<span class="keyword">sizeof</span>(mbi));</span><br><span class="line">	VirtualProtect(mbi.BaseAddress,mbi.RegionSize,PAGE_EXECUTE_READWRITE,&amp;dwOLD);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//å†™å…¥int3</span></span><br><span class="line">	*pTarget  = <span class="number">0xCC</span> ;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ¢å¤å†…å­˜é¡µçš„å±æ€§</span></span><br><span class="line">	VirtualProtect(mbi.BaseAddress,mbi.RegionSize,dwOLD,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">ClearBreakPoint</span><span class="params">(PVOID pFuncAddr)</span></span><br><span class="line">&#123;</span><br><span class="line">	BYTE *pTarget = (BYTE*)pFuncAddr;</span><br><span class="line">	<span class="comment">//ä¿®æ”¹å†…å­˜é¡µçš„å±æ€§</span></span><br><span class="line">	DWORD dwOLD;</span><br><span class="line">	MEMORY_BASIC_INFORMATION  mbi;</span><br><span class="line">	VirtualQuery(pTarget,&amp;mbi,<span class="keyword">sizeof</span>(mbi));</span><br><span class="line">	VirtualProtect(mbi.BaseAddress,mbi.RegionSize,PAGE_EXECUTE_READWRITE,&amp;dwOLD);</span><br><span class="line">	</span><br><span class="line">	*pTarget  = g_OldCode[<span class="number">0</span>] ;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//æ¢å¤å†…å­˜é¡µçš„å±æ€§</span></span><br><span class="line">	VirtualProtect(mbi.BaseAddress,mbi.RegionSize,dwOLD,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> WINAPI <span class="title function_">My_MessageBox</span><span class="params">(</span></span><br><span class="line"><span class="params">	HWND hWnd,          <span class="comment">// handle of owner window</span></span></span><br><span class="line"><span class="params">	LPCTSTR lpText,     <span class="comment">// address of text in message box</span></span></span><br><span class="line"><span class="params">	LPCTSTR lpCaption,  <span class="comment">// address of title of message box</span></span></span><br><span class="line"><span class="params">	UINT uType          <span class="comment">// style of message box</span></span></span><br><span class="line"><span class="params">	)</span></span><br><span class="line">&#123;	</span><br><span class="line">	<span class="type">char</span> newMsg[<span class="number">400</span>];</span><br><span class="line">	<span class="type">char</span> newCation[]=<span class="string">&quot;æ ‡é¢˜è¢«æˆ‘æ”¹äº†!&quot;</span>;</span><br><span class="line">	<span class="type">int</span> result;</span><br><span class="line">	<span class="keyword">if</span> (lpText)</span><br><span class="line">	&#123;</span><br><span class="line">		ZeroMemory(newMsg,<span class="number">400</span>);</span><br><span class="line">		lstrcpy(newMsg,lpText);</span><br><span class="line">		lstrcat(newMsg,<span class="string">&quot;\n\tMessage Box hacked by pediy.com&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;æœ‰äººè°ƒç”¨MessageBox...\n&quot;</span>);</span><br><span class="line">	result = g_OriginalMessageBoxA(hWnd,newMsg,newCation,uType);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ"></a>è§£æ</h4><p>å®ç°æµç¨‹ï¼Œå…ˆè·å¾—å…ˆè·å¾—åœ°å€ï¼Œè·å¾—ä¹‹åå®‰è£…ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œç„¶åè®¾ç½®æ¥ä¸‹æ¥è¿›è¡Œå‡½æ•°çš„æ–­ç‚¹ï¼Œç„¶åè°ƒç”¨å³å¯</p>
<h5 id="mainå‡½æ•°"><a href="#mainå‡½æ•°" class="headerlink" title="mainå‡½æ•°"></a>mainå‡½æ•°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	HMODULE hUser32 = LoadLibrary(<span class="string">&quot;user32.dll&quot;</span>);</span><br><span class="line">	g_AddrofMessageBoxA =  (PVOID)GetProcAddress(hUser32,<span class="string">&quot;MessageBoxA&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Address of MessageBoxA = 0x%p\n&quot;</span>,g_AddrofMessageBoxA);</span><br><span class="line">	g_OriginalMessageBoxA = (PFN_MessageBox)InitTrampolineFun();  <span class="comment">//è·³è¿‡å¼€å¤´çš„Hook</span></span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Addr of VectoredHandler1 = 0x%p\n&quot;</span>,VectoredHandler1);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Addr of VectoredHandler2 = 0x%p\n&quot;</span>,VectoredHandler2);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Addr of VectoredHandler3 = 0x%p\n&quot;</span>,VectoredHandler3);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//é€‰æ‹©å®‰è£…ä¸€ä¸ªè¿›è¡Œæµ‹è¯•</span></span><br><span class="line">	InstallVEHHook(VectoredHandler2);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//è®¾ç½®æ–­ç‚¹</span></span><br><span class="line">	SetBreakPoint(g_AddrofMessageBoxA);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//call</span></span><br><span class="line">	ShowMsgBox(<span class="string">&quot;VEH Hook Test.&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;All Finished!\n&quot;</span>);</span><br><span class="line">	ClearBreakPoint(g_AddrofMessageBoxA);</span><br><span class="line">	UnInstallVEHHook();</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	ShowMsgBox(<span class="string">&quot;Hook Cleared&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨printf(â€œAll Finished!\nâ€)ä¹‹å‰æ˜¯å¯¹å¼‚å¸¸çš„å‡†å¤‡å·¥ä½œï¼Œåé¢çš„æ˜¯æ¸…ç†å·¥ä½œï¼Œè¿™é‡Œéœ€è¦é‡ç‚¹ç ”ç©¶çš„æ˜¯ï¼Œä¸‰ç§å¼‚å¸¸å¤„ç†æ–¹æ³•å‡½æ•°å’Œå®‰è£…å‡½æ•°</p>
<h5 id="ä¸‰ç§å¼‚å¸¸å‡½æ•°"><a href="#ä¸‰ç§å¼‚å¸¸å‡½æ•°" class="headerlink" title="ä¸‰ç§å¼‚å¸¸å‡½æ•°"></a>ä¸‰ç§å¼‚å¸¸å‡½æ•°</h5><h6 id="å…±åŒéƒ¨åˆ†"><a href="#å…±åŒéƒ¨åˆ†" class="headerlink" title="å…±åŒéƒ¨åˆ†"></a>å…±åŒéƒ¨åˆ†</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LONG lResult = EXCEPTION_CONTINUE_SEARCH;</span><br><span class="line">PEXCEPTION_RECORD pExceptionRecord = ExceptionInfo-&gt;ExceptionRecord;</span><br><span class="line">PCONTEXT pContextRecord = ExceptionInfo-&gt;ContextRecord;</span><br><span class="line">ULONG_PTR* uESP = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (pExceptionRecord-&gt;ExceptionCode == EXCEPTION_BREAKPOINT</span><br><span class="line">	&amp;&amp; pExceptionRecord-&gt;ExceptionAddress == g_AddrofMessageBoxA)</span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure>

<p><code>EXCEPTION_RECORD</code> ç»“æ„ä½“</p>
<p><code>EXCEPTION_RECORD</code> ç»“æ„ä½“åŒ…å«äº†å¼‚å¸¸çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¸»è¦å­—æ®µæœ‰ï¼š</p>
<ul>
<li><code>ExceptionCode</code>ï¼šå¼‚å¸¸çš„ä»£ç ï¼Œè¡¨ç¤ºå¼‚å¸¸ç±»å‹ï¼Œä¾‹å¦‚ <code>EXCEPTION_ACCESS_VIOLATION</code>ã€<code>EXCEPTION_BREAKPOINT</code> ç­‰ã€‚</li>
<li><code>ExceptionAddress</code>ï¼šå¼‚å¸¸å‘ç”Ÿæ—¶çš„åœ°å€ï¼ˆé€šå¸¸æ˜¯ç¨‹åºå´©æºƒçš„æŒ‡ä»¤åœ°å€ï¼‰ã€‚</li>
<li><code>ExceptionFlags</code>ï¼šå¼‚å¸¸çš„æ ‡å¿—ä½ï¼Œç”¨æ¥è¡¨ç¤ºå¼‚å¸¸çš„ç‰¹æ®Šç±»å‹æˆ–å¤„ç†æ–¹å¼ã€‚</li>
<li><code>NumberParameters</code>ï¼šå¼‚å¸¸çš„å‚æ•°æ•°é‡ã€‚</li>
<li><code>ExceptionInformation[]</code>ï¼šåŒ…å«å¼‚å¸¸ç›¸å…³çš„é™„åŠ ä¿¡æ¯ï¼Œå…·ä½“ä¿¡æ¯å–å†³äºå¼‚å¸¸ç±»å‹ã€‚</li>
</ul>
<p><code>CONTEXT</code> ç»“æ„ä½“</p>
<p><code>CONTEXT</code> ç»“æ„ä½“ä¿å­˜äº†çº¿ç¨‹çš„å¯„å­˜å™¨çŠ¶æ€ã€‚å¯¹äº x86 å’Œ x64 å¹³å°ï¼Œç»“æ„ä½“çš„æˆå‘˜æœ‰æ‰€ä¸åŒã€‚</p>
<ul>
<li>åœ¨ <strong>x64</strong> ç³»ç»Ÿä¸­ï¼Œ<code>CONTEXT</code> ç»“æ„ä½“åŒ…å«ä»¥ä¸‹å¯„å­˜å™¨ï¼š<ul>
<li><code>Rax, Rbx, Rcx, Rdx</code> ç­‰é€šç”¨å¯„å­˜å™¨ã€‚</li>
<li><code>Rip</code>ï¼šæŒ‡ä»¤æŒ‡é’ˆï¼Œè¡¨ç¤ºå½“å‰æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ã€‚</li>
<li><code>Rsp</code>ï¼šå †æ ˆæŒ‡é’ˆï¼ŒæŒ‡å‘æ ˆçš„å½“å‰ä½ç½®ã€‚</li>
<li><code>Rbp</code>ï¼šåŸºå€æŒ‡é’ˆã€‚</li>
<li><code>Rdi, Rsi</code> ç­‰å…¶ä»–å¯„å­˜å™¨</li>
</ul>
</li>
</ul>
<p>å…ˆè®¾ç½®ä¸€ä¸ªé»˜è®¤çš„è¿”å›å€¼ï¼Œæ²¡æœ‰å®Œå…¨å¤„ç†å¼‚å¸¸</p>
<p>åˆå§‹åŒ–äº†ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªæŒ‡å‘å¼‚å¸¸çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¸€ä¸ªæŒ‡å‘ä¿å­˜å½“å‰CPUå¯„å­˜å™¨çŠ¶å†µçš„ç¯å¢ƒ</p>
<ul>
<li><code>**EXCEPTION_BREAKPOINT**</code>ï¼šè¿™æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå€¼ä¸º <code>0x80000003</code>ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª<strong>æ–­ç‚¹å¼‚å¸¸</strong>ã€‚é€šå¸¸æ˜¯ç”±è°ƒè¯•å™¨æˆ–æŸäº›ç¨‹åºå†…çš„æ˜¾å¼ <code>int 3</code> æŒ‡ä»¤ï¼ˆè§¦å‘æ–­ç‚¹ï¼‰å¼•å‘çš„ã€‚æ–­ç‚¹å¼‚å¸¸ä¸€èˆ¬åœ¨è°ƒè¯•ç¨‹åºæ—¶ç”¨æ¥æš‚åœç¨‹åºçš„æ‰§è¡Œã€‚</li>
</ul>
<p>è¿™é‡Œæ£€æµ‹æ–­ç‚¹æ˜¯ä¸æ˜¯è‡ªå·±è®¾ç½®çš„<code>0xCC</code>ï¼Œå¹¶ä¸”æ£€æµ‹æ˜¯ä¸æ˜¯åœ¨<code>MessageBoxA</code>é‡Œçš„</p>
<h6 id="VectoredHandler1"><a href="#VectoredHandler1" class="headerlink" title="VectoredHandler1"></a>VectoredHandler1</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//x64ä¸Šå‰å››ä¸ªå‚æ•°ä¾æ¬¡ä¸ºRCX,RDX,R8,R9</span></span><br><span class="line"><span class="comment">//ä¿®æ”¹ç¬¬äºŒä¸ªå‚æ•°ï¼Œå³LpMsg</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;lpText = 0x%p   %s\n&quot;</span>,pContextRecord-&gt;Rdx,(<span class="type">char</span>*)pContextRecord-&gt;Rdx);</span><br><span class="line">pContextRecord-&gt;Rdx = (ULONG_PTR)szNewMsg;</span><br><span class="line">pContextRecord-&gt;Rip = (ULONG_PTR)g_OriginalMessageBoxA ; <span class="comment">//è·³åˆ°Trampolineç»§ç»­æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ï¼ŒæŠŠå‡½æ•°è°ƒç”¨è¿›å»çš„å¯„å­˜å™¨æ”¹æˆéœ€è¦çš„å€¼ï¼Œç„¶åå°†ripå›æ­£</p>
<h6 id="VectoredHandler2"><a href="#VectoredHandler2" class="headerlink" title="VectoredHandler2"></a>VectoredHandler2</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//x64ä¸Šå‰å››ä¸ªå‚æ•°ä¾æ¬¡ä¸ºRCX,RDX,R8,R9</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;RSP = 0x%p\n&quot;</span>,pContextRecord-&gt;Rsp) ;</span><br><span class="line">uESP = (ULONG_PTR*)pContextRecord-&gt;Rsp ;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Return Address = 0x%p\n&quot;</span>,uESP[<span class="number">0</span>]);</span><br><span class="line">ret = g_OriginalMessageBoxA((HWND)pContextRecord-&gt;Rcx,szNewMsg,(LPCTSTR)pContextRecord-&gt;R8,(<span class="type">int</span>)pContextRecord-&gt;R9);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ret = %d\n&quot;</span>,ret);</span><br><span class="line"><span class="comment">//ä¿®æ­£RSP</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;RSP(before) = 0x%p\n&quot;</span>, pContextRecord-&gt;Rsp);<span class="comment">//RSP(before) = 0x000000000014FD98</span></span><br><span class="line">pContextRecord-&gt;Rsp += <span class="keyword">sizeof</span>(ULONG_PTR);<span class="comment">//å‚æ•°åœ¨å¯„å­˜å™¨ä¸­ï¼Œæ ˆä¸­æ— å‚æ•°ï¼Œä»…éœ€è·³è¿‡è¿”å›åœ°å€</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;RSP(after) = 0x%p\n&quot;</span>, pContextRecord-&gt;Rsp);<span class="comment">//RSP(after) = 0x000000000014FDA0</span></span><br></pre></td></tr></table></figure>

<p>ç›´æ¥å…ˆè°ƒç”¨ä¸€ä¸ªä½ éœ€è¦çš„å‡½æ•°ï¼Œä¼ å‚åœ¨ä¿å­˜ä¸Šä¸‹æ–‡ä¸­æœ‰ï¼Œç„¶åä¼ å…¥éœ€è¦ä¸åŒçš„åœ°æ–¹</p>
<p>å› ä¸ºè¿™é‡Œæ˜¯åˆšè¿›å…¥å‡½æ•°çš„æ—¶å€™æŠ¥é”™çš„ï¼Œæ‰€ä»¥æ ˆä¸­åªä¿å­˜äº†è¿”å›åœ°å€ï¼Œæ‰€ä»¥<code>uESP</code>ä¸­ä¿å­˜çš„æ˜¯è¿”å›åœ°å€ï¼Œåé¢è°ƒç”¨å®Œå‡½æ•°ä¹‹åï¼Œå°†Ripå›æ­£ï¼ŒRspè·³è¿‡è¿”å›åœ°å€</p>
<h6 id="VectoredHandler3"><a href="#VectoredHandler3" class="headerlink" title="VectoredHandler3"></a>VectoredHandler3</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;RSP = 0x%p\n&quot;</span>,pContextRecord-&gt;Rsp) ;</span><br><span class="line">uESP = (ULONG_PTR*)pContextRecord-&gt;Rsp ;</span><br><span class="line">pContextRecord-&gt;Rip = uESP[<span class="number">0</span>] ;<span class="comment">//è®¾ç½®EIPä¸ºè¿”å›åœ°å€</span></span><br><span class="line">pContextRecord-&gt;Rsp += <span class="keyword">sizeof</span>(ULONG_PTR); <span class="comment">//å°†å‹å…¥æ ˆå†…çš„å‚æ•°å’Œè¿”å›åœ°å€æ¸…ç†æ‰,4ä¸ºå‚æ•°ä¸ªæ•°,1ä¸ºè¿”å›åœ°å€</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç›´æ¥å°†ä¿å­˜ç¯å¢ƒä¸­çš„Ripæ”¹å›è¿”å›å€¼ï¼Œæ ˆè·³è¿‡è¿”å›å€¼ï¼Œç„¶åè¿”å›</p>
<h5 id="InstallVEHHookå‡½æ•°"><a href="#InstallVEHHookå‡½æ•°" class="headerlink" title="InstallVEHHookå‡½æ•°"></a>InstallVEHHookå‡½æ•°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">InstallVEHHook</span><span class="params">(PVECTORED_EXCEPTION_HANDLER Handler)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Current Handler Address = 0x%p\n&quot;</span>,Handler);</span><br><span class="line">	g_hVector = AddVectoredExceptionHandler(<span class="number">1</span>,Handler);</span><br><span class="line">	<span class="keyword">return</span> g_hVector != <span class="literal">NULL</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¾ˆå¥½åˆ†æï¼Œé¦–å…ˆç¡®å®šä½ ä½¿ç”¨çš„æ˜¯å“ªä¸ªå¤„ç†æ–¹æ¡ˆï¼Œç„¶åé€šè¿‡<code>AddVectoredExceptionHandler</code>å‡½æ•°æ¥å°†è§£å†³æ–¹æ¡ˆåŠ å…¥åˆ°VEHä¸­ï¼Œäºæ˜¯å°±hookäº†</p>
<h3 id="Address-Hookï¼ˆå¾…å®Œå–„ï¼‰ï¼ˆåå†…æ ¸ï¼‰"><a href="#Address-Hookï¼ˆå¾…å®Œå–„ï¼‰ï¼ˆåå†…æ ¸ï¼‰" class="headerlink" title="Address Hookï¼ˆå¾…å®Œå–„ï¼‰ï¼ˆåå†…æ ¸ï¼‰"></a>Address Hookï¼ˆå¾…å®Œå–„ï¼‰ï¼ˆåå†…æ ¸ï¼‰</h3><h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>é€šè¿‡æ”¹å˜å‡½æ•°çš„åœ°å€ï¼ˆå‡½æ•°åœ¨å„ç±»è¡¨æˆ–ç»“æ„ä¸­ï¼Œæˆ–è€…æŸä¸ªæŒ‡å®šçš„åœ°å€å¤„ï¼‰ï¼Œä½†ä»–ä»¬å…±åŒç‚¹å°±æ˜¯è°ƒç”¨å‡½æ•°äº†ï¼Œå°±ä¼šæˆä¸ºeipï¼Œå› æ­¤æŠŠæœ¬æ¥çš„åœ°å€æ¢æˆæˆ‘ä»¬è‡ªå·±çš„å°±å®ç°hookäº†</p>
<p>è¿™é‡Œå…ˆçœ‹ä¸€çœ¼è¿™ä¸ªæ–‡ç« é¢„å¤‡ä¸€ä¸‹å‰ç½®çŸ¥è¯†</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/diamond_biu/article/details/110691568">ã€Šé€†å‘å·¥ç¨‹æ ¸å¿ƒåŸç†ã€‹ç¬¬13ç« â€”â€”PEæ–‡ä»¶æ ¼å¼ï¼ˆ2ï¼‰ï¼šIATä¸EAT_odæŸ¥çœ‹iat-CSDNåšå®¢</a></p>
<h5 id="å„ç±»è¡¨ä¸­çš„åœ°å€"><a href="#å„ç±»è¡¨ä¸­çš„åœ°å€" class="headerlink" title="å„ç±»è¡¨ä¸­çš„åœ°å€"></a>å„ç±»è¡¨ä¸­çš„åœ°å€</h5><p>PEä¸­çš„IAT</p>
<p><font style="color:rgb(77, 77, 77);">å¯¼å…¥åœ°å€è¡¨ï¼ˆImport Adress Tableï¼‰ã€‚ç®€è€Œè¨€ä¹‹IATæ˜¯ä¸€ç§è¡¨æ ¼ï¼Œç”¨æ¥è®°å½•ç¨‹åºæ­£åœ¨ä½¿ç”¨å“ªäº›åº“ä¸­çš„å“ªäº›å‡½æ•°ã€‚</font></p>
<p><font style="color:rgb(77, 77, 77);">PEä¸­çš„EAT</font></p>
<p><font style="color:rgb(28, 31, 33);">EATæ˜¯ä¸€ç§æ ¸å¿ƒæœºåˆ¶ï¼Œä½¿ä¸åŒçš„åº”ç”¨ç¨‹åºå¯ä»¥è°ƒç”¨åº“æ–‡ä»¶ä¸­æä¾›çš„å‡½æ•°ï¼Œåªæœ‰é€šè¿‡EATæ‰èƒ½å‡†ç¡®æ±‚å¾—ä»ç›¸åº”åº“ä¸­åˆ°å¤„å‡½æ•°çš„èµ·å§‹åœ°å€ã€‚</font></p>
<p><font style="color:rgb(28, 31, 33);">user32.dllçš„å›è°ƒå‡½æ•°è¡¨</font></p>
<p>å­˜å‚¨ç³»ç»Ÿå›è°ƒå‡½æ•°çš„è¡¨</p>
<p>IDT</p>
<p>SSDTå’ŒShadow SSDT</p>
<p>C++ç±»çš„è™šå‡½æ•°è¡¨â€“è¿™é‡Œçš„è™šå‡½æ•°hookéœ€è¦æ³¨æ„</p>
<p>æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œå­ç±»å‡½æ•°ä¸­é‡è½½å‡½æ•°çš„åœ°å€ä¼šè¢«æ›¿æ¢æˆè™šå‡½æ•°è¡¨ä¸­å¯¹åº”çš„åœ°å€ï¼ˆå…¶ç»§æ‰¿å‡½æ•°ï¼‰</p>
<p>COMå€Ÿå£çš„åŠŸèƒ½å‡½æ•°è¡¨</p>
<p>å¤„ç†å†ç¨‹åœ°å€</p>
<p>ä¹¦ä¸Šæ‰€è¯´ï¼Œè¿™éƒ¨åˆ†å†…å®¹å¸¸ç”¨äºå†…æ ¸ä¸­</p>
<p>è¿™é‡Œè¡¥ä¹ ä¸€ä¸‹ä¾‹ç¨‹çš„æ¦‚å¿µ</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/scyatcs/article/details/77452336">ä»€ä¹ˆæ˜¯ä¾‹ç¨‹ï¼Ÿ_ä¾‹ç¨‹æ˜¯ä»€ä¹ˆæ„æ€-CSDNåšå®¢</a></p>
<p><code>ä¾‹ç¨‹â‰ˆ å‡½æ•°ï¼Ÿ</code>æˆ–è€…è¯´<code>ä¾‹ç¨‹&gt;=å‡½æ•°ï¼Ÿ</code></p>
<h6 id="DRIVER-OBJECT-çš„-MajorFunction-åŠFasIo-æ´¾é£å†ç¨‹åœ°å€"><a href="#DRIVER-OBJECT-çš„-MajorFunction-åŠFasIo-æ´¾é£å†ç¨‹åœ°å€" class="headerlink" title="DRIVER_OBJECT çš„ MajorFunction åŠFasIo æ´¾é£å†ç¨‹åœ°å€"></a>DRIVER_OBJECT çš„ MajorFunction åŠFasIo æ´¾é£å†ç¨‹åœ°å€</h6><p>åœ¨è¿™æœ¬ä¹¦çš„è¿™é‡Œï¼Œæˆ‘è¿˜æ²¡æœ‰å­¦ä¹ ä»–è¯´çš„ä¾‹å­ï¼Œå¹¶ä¸”æœ‰å¾ˆå¤šç”Ÿåè¯ï¼Œæˆ‘å…ˆæŠŠä¸çŸ¥é“çš„è‡ªå·±ç®€å•æœç´¢çš„æ ‡æ³¨åœ¨è¿™é‡Œ</p>
<p>ä»€ä¹ˆæ˜¯ ntfs.sys</p>
<p>è¯¥è¿‡ç¨‹çš„Ntfs.sysä¹Ÿè¢«ç§°ä¸ºNTæ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ç¨‹åºï¼Œå®ƒæ˜¯ç”±å¾®è½¯å…¬å¸æ‰€æ‹¥æœ‰ã€‚è¯¥çš„Ntfs.sysè¿‡ç¨‹ç”¨äºåˆ›å»ºå’Œå­˜å‚¨<br>ä¸ä½¿ç”¨NTFSçš„æ¶ˆé˜²å¤„çš„åº”ç”¨ç¨‹åºã€‚åœ¨Windowsæ“ä½œç³»ç»Ÿæ£€éªŒæœºæ„ï¼ˆå› ä¸ºåªæœ‰åˆæ³•çš„ç”¨æˆ·æ‰èƒ½è¿è¡Œæ­¤ï¼‰ï¼Œå…¶æ¬¡æ˜¯I<br>&#x2F; Oç®¡ç†ï¼Œå°†æ‰€è¿°æ–‡ä»¶å¥æŸ„åˆ°ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡çš„æŒ‡æ ‡ã€‚è¿™ä¸ªè¿‡ç¨‹ä¹‹åï¼Œå¾—åˆ°çš„NTFSæ–‡ä»¶åœ¨ç£ç›˜ä½¿ç”¨çš„æ–‡ä»¶å¯¹è±¡æŒ‡æ ‡ã€‚ NTFSçš„æ”¶é›†ä¸ä½¿ç”¨æ–‡ä»¶å¯¹è±¡æŒ‡é’ˆçš„æ–‡ä»¶å±æ€§çš„æ¸£æ‰“é“¶è¡Œï¼ˆæµæ§åˆ¶å—ï¼‰ã€‚æµæ§åˆ¶å—æ˜¯ç”±å•ä¸€çš„å±æ€§æ–‡ä»¶è¡¨ç¤ºï¼Œå¹¶åŒ…å«æœ‰å…³å¦‚ä½•è·å–æ–‡ä»¶ç‚¹çš„å›½æœ‰å•†ä¸šé“¶è¡Œçš„æ•°æ®å»ºè®¾FCBï¼ˆæ–‡ä»¶æ§åˆ¶å—ï¼‰æŒ‡å®šçš„å±æ€§ä¿¡æ¯ã€‚è¯¥FCBå…·æœ‰æŒ‡å®šMFTï¼ˆä¸»æ–‡ä»¶è¡¨ï¼‰çš„æ–‡ä»¶è®°å½•çš„æŒ‡æ ‡</p>
<p>ä¹¦ä¸­çš„ä¾‹å­ä¹Ÿæ²¡å¤ªçœ‹æ‡‚ï¼Œä»¥åæ‡‚äº†å›æ¥è§£é‡Šè¡¥å……ï¼Œæ€»ä¹‹çœ‹åˆ°äº†ï¼ŒFSD Hook æ˜¯ä¿®æ”¹çš„FileSystem Driver</p>
<h6 id="StartIoç­‰ç‰¹æ®Šä¾‹ç¨‹çš„åœ°å€"><a href="#StartIoç­‰ç‰¹æ®Šä¾‹ç¨‹çš„åœ°å€" class="headerlink" title="StartIoç­‰ç‰¹æ®Šä¾‹ç¨‹çš„åœ°å€"></a>StartIoç­‰ç‰¹æ®Šä¾‹ç¨‹çš„åœ°å€</h6><p>è¿™ä¸ªä¾‹ç¨‹ä¸»è¦ç”¨äºIRPçš„ä¸²è¡Œå¤„ç†ï¼Œåœ¨nt!IoStartPacketä¸­è¢«è°ƒç”¨</p>
<h6 id="OBJECT-TYPE-ä¸­-OBJECT-TYPE-INITIALIZERåŒ…å«çš„å„ç§å¤„ç†è¿‡ç¨‹"><a href="#OBJECT-TYPE-ä¸­-OBJECT-TYPE-INITIALIZERåŒ…å«çš„å„ç§å¤„ç†è¿‡ç¨‹" class="headerlink" title="OBJECT_TYPE ä¸­ _OBJECT_TYPE_INITIALIZERåŒ…å«çš„å„ç§å¤„ç†è¿‡ç¨‹"></a>OBJECT_TYPE ä¸­ _OBJECT_TYPE_INITIALIZERåŒ…å«çš„å„ç§å¤„ç†è¿‡ç¨‹</h6><p>çœ‹ä¸æ‡‚æ€å¯†è¾¾ï¼Œä»¥åå†è¯´å§</p>
<h5 id="ç‰¹æ®Šå¯„å­˜å™¨ä¸­çš„åœ°å€"><a href="#ç‰¹æ®Šå¯„å­˜å™¨ä¸­çš„åœ°å€" class="headerlink" title="ç‰¹æ®Šå¯„å­˜å™¨ä¸­çš„åœ°å€"></a>ç‰¹æ®Šå¯„å­˜å™¨ä¸­çš„åœ°å€</h5><p>å¥½åƒè¿˜æ˜¯å†…æ ¸</p>
<h5 id="ç‰¹æ®Šçš„å‡½æ•°æŒ‡é’ˆ"><a href="#ç‰¹æ®Šçš„å‡½æ•°æŒ‡é’ˆ" class="headerlink" title="ç‰¹æ®Šçš„å‡½æ•°æŒ‡é’ˆ"></a>ç‰¹æ®Šçš„å‡½æ•°æŒ‡é’ˆ</h5><p>å‰é¢è¯´çš„è¿˜æ­£å¸¸åé¢åˆæ˜¯å†…æ ¸</p>
<p>å¥½åƒæ˜¯ç»“æŸäº†ï¼Œé‚£ä¹ˆç»¼ä¸Šæ‰€çœ‹ï¼Œaddresshookå¤šç”¨äºå†…æ ¸ï¼Œä»¥åå›æ¥çœ‹</p>
<h4 id="IATHook"><a href="#IATHook" class="headerlink" title="IATHook"></a>IATHook</h4><h5 id="IAT"><a href="#IAT" class="headerlink" title="IAT"></a><font style="color:rgb(79, 79, 79);">IAT</font></h5><p><font style="color:rgb(77, 77, 77);">IATï¼šå¯¼å…¥åœ°å€è¡¨ï¼ˆImport Adress Tableï¼‰ã€‚ç®€è€Œè¨€ä¹‹IATæ˜¯ä¸€ç§è¡¨æ ¼ï¼Œç”¨æ¥</font><strong><font style="color:rgb(77, 77, 77);">è®°å½•ç¨‹åºæ­£åœ¨ä½¿ç”¨å“ªäº›åº“ä¸­çš„å“ªäº›å‡½æ•°</font></strong><font style="color:rgb(77, 77, 77);">ã€‚</font></p>
<h5 id="åŸç†-3"><a href="#åŸç†-3" class="headerlink" title="åŸç†"></a>åŸç†</h5><p><font style="color:rgb(68, 68, 68);">æ¯ä¸ªè°ƒç”¨çš„ API å‡½æ•°åœ°å€éƒ½ä¿å­˜åœ¨ IAT è¡¨ä¸­ã€‚ API å‡½æ•°è°ƒç”¨æ—¶ï¼Œæ¯ä¸ªè¾“å…¥èŠ‚ï¼ˆ IMPORT SECTION ï¼‰æ‰€æŒ‡å‘çš„ IATç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</font></p>
<p><font style="color:rgb(68, 68, 68);">ç¨‹åºä¸­æ¯ä¸ªè°ƒç”¨ API å‡½æ•°çš„ CALL æŒ‡ä»¤æ‰€ä½¿ç”¨çš„åœ°å€éƒ½æ˜¯ç›¸åº”å‡½æ•°ç™»è®°åœ¨ IAT è¡¨çš„åœ°å€ã€‚æ‰€ä»¥ä¸ºäº†æˆªè· API å‡½æ•°ï¼Œæˆ‘ä»¬å°† IAT è¡¨ä¸­çš„åœ°å€æ¢æˆç”¨æˆ·è‡ªå·±çš„ API PROXY å‡½æ•°åœ°å€ï¼Œè¿™æ ·æ¯ä¸ª API è°ƒç”¨éƒ½æ˜¯å…ˆè°ƒç”¨ç”¨æˆ·è‡ªå·±çš„ API PROXY å‡½æ•°ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥å®Œæˆå‡½æ•°åç§°çš„è®°å½•ã€å‚æ•°çš„è®°å½•ã€è°ƒç”¨åŸæ¥çš„è¿‡ç¨‹ï¼Œå¹¶åœ¨è¿”å›æ—¶è®°å½•ç»“æœã€‚</font></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[ ])</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bIsWow64 = IsWow64();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;IsWow64 = %d\n&quot;</span>,bIsWow64);</span><br><span class="line">	ShowMsgBox(<span class="string">&quot;Before IAT Hook&quot;</span>);</span><br><span class="line">	IAT_InstallHook();</span><br><span class="line">	ShowMsgBox(<span class="string">&quot;After  IAT Hook&quot;</span>);</span><br><span class="line">	IAT_UnInstallHook();</span><br><span class="line">	ShowMsgBox(<span class="string">&quot;After  IAT Hook UnHooked&quot;</span>);       </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">VOID <span class="title function_">ShowMsgBox</span><span class="params">(<span class="type">char</span> *szMsg)</span></span><br><span class="line">&#123;</span><br><span class="line">	MessageBoxA(<span class="literal">NULL</span>,szMsg,<span class="string">&quot;Test&quot;</span>,MB_OK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Šæ“ä½œï¼Œå¦‚æœæŒ‰ç…§æ­£å¸¸è¾“å‡ºçš„è¯ï¼Œåªä¼šæœ‰ä¸‰ä¸ªæ¡†ï¼Œä½†æ˜¯ç»è¿‡<code>IAT_InstallHook</code>å‡½æ•°ä¹‹åï¼Œboxè¡¨å°±ä¼šæ”¹å˜ï¼Œä½¿ç”¨äº†ä¿®æ”¹IATçš„æ–¹æ³•æ‹¦æˆªäº†APIçš„è°ƒç”¨ï¼Œæ‰€ä»¥ç§°ä¸ºIAT hookï¼Œè°ƒç”¨åœ°å€æ¬ºéª—</p>
<h5 id="æºç -3"><a href="#æºç -3" class="headerlink" title="æºç "></a>æºç </h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//         ç¬¬13ç«   HookæŠ€æœ¯ ã€ŠåŠ å¯†ä¸è§£å¯†ï¼ˆç¬¬å››ç‰ˆï¼‰ã€‹           //</span></span><br><span class="line"><span class="comment">//                                                             //</span></span><br><span class="line"><span class="comment">//         Author: achillis(é»‘æœˆæ•™ä¸»)                          //</span></span><br><span class="line"><span class="comment">//         Blog  : http://www.cnblogs.com/achillis/            //</span></span><br><span class="line"><span class="comment">//         QQ    : 344132161                                   //</span></span><br><span class="line"><span class="comment">//         Email : achillis@126.com                            //</span></span><br><span class="line"><span class="comment">//         è½¬è½½è¯·ä¿ç•™ä½œè€…ä¿¡æ¯                                  //</span></span><br><span class="line"><span class="comment">//         (c)  çœ‹é›ªå­¦é™¢ www.kanxue.com 2000-2018              //</span></span><br><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//ç¨‹åºåŠŸèƒ½:ä¸ºæœ¬è¿›ç¨‹çš„exeæ¨¡å—å®‰è£…IAT Hookï¼Œç›®æ ‡å‡½æ•°æ˜¯MessageBoxA</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;imagehlp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;imagehlp.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»¥MessageBoxAçš„åŸå‹å®šä¹‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç±»å‹</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> </span><br><span class="line"><span class="params">(WINAPI *PFN_MessageBoxA)</span><span class="params">(</span></span><br><span class="line"><span class="params">	HWND hWnd,          <span class="comment">// handle of owner window</span></span></span><br><span class="line"><span class="params">	LPCTSTR lpText,     <span class="comment">// address of text in message box</span></span></span><br><span class="line"><span class="params">	LPCTSTR lpCaption,  <span class="comment">// address of title of message box</span></span></span><br><span class="line"><span class="params">	UINT uType          <span class="comment">// style of message box</span></span></span><br><span class="line"><span class="params">	)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»¥MessageBoxAçš„åŸå‹å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥æ›¿ä»£åŸå§‹çš„MessageBoxA</span></span><br><span class="line"><span class="type">int</span> WINAPI <span class="title function_">My_MessageBoxA</span><span class="params">(</span></span><br><span class="line"><span class="params">	HWND hWnd,          <span class="comment">// handle of owner window</span></span></span><br><span class="line"><span class="params">	LPCTSTR lpText,     <span class="comment">// address of text in message box</span></span></span><br><span class="line"><span class="params">	LPCTSTR lpCaption,  <span class="comment">// address of title of message box</span></span></span><br><span class="line"><span class="params">	UINT uType          <span class="comment">// style of message box</span></span></span><br><span class="line"><span class="params">	)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å­˜åœ¨ä»¥ä¸‹å…³ç³»</span></span><br><span class="line"><span class="comment">//*(*pThunkPointer) == *pOriginalFuncAddr ;</span></span><br><span class="line">BOOL <span class="title function_">InstallModuleIATHook</span><span class="params">(</span></span><br><span class="line"><span class="params">	HMODULE hModToHook,</span></span><br><span class="line"><span class="params">	<span class="type">char</span> *szModuleName, </span></span><br><span class="line"><span class="params">	<span class="type">char</span> *szFuncName,</span></span><br><span class="line"><span class="params">	PVOID ProxyFunc,</span></span><br><span class="line"><span class="params">	PULONG_PTR *pThunkPointer,</span></span><br><span class="line"><span class="params">	ULONG_PTR *pOriginalFuncAddr</span></span><br><span class="line"><span class="params">	)</span>;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">ShowMsgBox</span><span class="params">(<span class="type">char</span> *szMsg)</span>;</span><br><span class="line">BOOL <span class="title function_">IAT_InstallHook</span><span class="params">()</span>;</span><br><span class="line">VOID <span class="title function_">IAT_UnInstallHook</span><span class="params">()</span>;</span><br><span class="line">BOOL <span class="title function_">IsWow64</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//ä¿å­˜åŸå§‹MessageBoxAçš„åœ°å€</span></span><br><span class="line">PFN_MessageBoxA OldMessageBox=<span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">//æŒ‡å‘IATä¸­pThunkçš„åœ°å€</span></span><br><span class="line">PULONG_PTR g_PointerToIATThunk = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[ ])</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bIsWow64 = IsWow64();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;IsWow64 = %d\n&quot;</span>,bIsWow64);</span><br><span class="line">	ShowMsgBox(<span class="string">&quot;Before IAT Hook&quot;</span>);</span><br><span class="line">	IAT_InstallHook();</span><br><span class="line">	ShowMsgBox(<span class="string">&quot;After  IAT Hook&quot;</span>);</span><br><span class="line">	IAT_UnInstallHook();</span><br><span class="line">	ShowMsgBox(<span class="string">&quot;After  IAT Hook UnHooked&quot;</span>);       </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¹‹æ‰€ä»¥æŠŠè¿™ä¸ªè°ƒç”¨å•ç‹¬æ”¾åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œæ˜¯å› ä¸ºReleaseæ¨¡å¼ä¸‹å¯¹è°ƒç”¨è¿›è¡Œäº†ä¼˜åŒ–,ç¬¬äºŒæ¬¡è°ƒç”¨æ—¶ç›´æ¥é‡‡ç”¨äº†å¯„å­˜å™¨å¯»å€è€Œä¸æ˜¯å¯¼å…¥è¡¨</span></span><br><span class="line"><span class="comment">//å› æ­¤ï¼Œå•ç‹¬æ”¾åœ¨ä¸€ä¸ªå‡½æ•°ä¸­å¯ä»¥é¿å…è¿™ä¸ªæƒ…å†µã€‚</span></span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">ShowMsgBox</span><span class="params">(<span class="type">char</span> *szMsg)</span></span><br><span class="line">&#123;</span><br><span class="line">	MessageBoxA(<span class="literal">NULL</span>,szMsg,<span class="string">&quot;Test&quot;</span>,MB_OK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> WINAPI <span class="title function_">My_MessageBoxA</span><span class="params">(</span></span><br><span class="line"><span class="params">	HWND hWnd,          <span class="comment">// handle of owner window</span></span></span><br><span class="line"><span class="params">	LPCTSTR lpText,     <span class="comment">// address of text in message box</span></span></span><br><span class="line"><span class="params">	LPCTSTR lpCaption,  <span class="comment">// address of title of message box</span></span></span><br><span class="line"><span class="params">	UINT uType          <span class="comment">// style of message box</span></span></span><br><span class="line"><span class="params">	)</span></span><br><span class="line">&#123;	</span><br><span class="line">	<span class="comment">//åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥å¯¹åŸå§‹å‚æ•°è¿›è¡Œä»»æ„æ“ä½œ</span></span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line">	<span class="type">char</span> newText[<span class="number">1024</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="type">char</span> newCaption[<span class="number">256</span>]=<span class="string">&quot;pediy.com&quot;</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;æœ‰äººè°ƒç”¨MessageBox!\n&quot;</span>);</span><br><span class="line">	<span class="comment">//åœ¨è°ƒç”¨åŸå‡½æ•°ä¹‹å‰ï¼Œå¯ä»¥å¯¹IN(è¾“å…¥ç±»)å‚æ•°è¿›è¡Œå¹²æ¶‰</span></span><br><span class="line">	lstrcpy(newText,lpText);<span class="comment">//ä¸ºé˜²æ­¢åŸå‡½æ•°æä¾›çš„ç¼“å†²åŒºä¸å¤Ÿï¼Œè¿™é‡Œå¤åˆ¶åˆ°æˆ‘ä»¬è‡ªå·±çš„ä¸€ä¸ªç¼“å†²åŒºä¸­å†è¿›è¡Œæ“ä½œ</span></span><br><span class="line">	lstrcat(newText,<span class="string">&quot;\n\tMessageBox Hacked by pediy.com!&quot;</span>);<span class="comment">//ç¯¡æ”¹æ¶ˆæ¯æ¡†å†…å®¹</span></span><br><span class="line">	uType|=MB_ICONERROR;<span class="comment">//å¢åŠ ä¸€ä¸ªé”™è¯¯å›¾æ ‡</span></span><br><span class="line">	ret = OldMessageBox(hWnd,newText,newCaption,uType);<span class="comment">//è°ƒç”¨åŸMessageBoxï¼Œå¹¶ä¿å­˜è¿”å›å€¼</span></span><br><span class="line">	<span class="comment">//è°ƒç”¨åŸå‡½æ•°ä¹‹åï¼Œå¯ä»¥ç»§ç»­å¯¹OUT(è¾“å‡ºç±»)å‚æ•°è¿›è¡Œå¹²æ¶‰,æ¯”å¦‚ç½‘ç»œå‡½æ•°çš„recvï¼Œå¯ä»¥å¹²æ¶‰è¿”å›çš„å†…å®¹</span></span><br><span class="line">	<span class="keyword">return</span> ret;<span class="comment">//è¿™é‡Œä½ è¿˜å¯ä»¥å¹²æ¶‰åŸå§‹å‡½æ•°çš„è¿”å›å€¼</span></span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">IAT_InstallHook</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bResult = FALSE ;</span><br><span class="line">	HMODULE hCurExe = GetModuleHandle(<span class="literal">NULL</span>);</span><br><span class="line">	PULONG_PTR pt ;</span><br><span class="line">	ULONG_PTR OrginalAddr;</span><br><span class="line">	bResult = InstallModuleIATHook(hCurExe,<span class="string">&quot;user32.dll&quot;</span>,<span class="string">&quot;MessageBoxA&quot;</span>,(PVOID)My_MessageBoxA,&amp;pt,&amp;OrginalAddr);</span><br><span class="line">	<span class="keyword">if</span> (bResult)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[*]Hookå®‰è£…å®Œæ¯•! pThunk=0x%p  OriginalAddr = 0x%p\n&quot;</span>,pt,OrginalAddr);</span><br><span class="line">		g_PointerToIATThunk = pt ;</span><br><span class="line">		OldMessageBox = (PFN_MessageBoxA)OrginalAddr ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bResult;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">IAT_UnInstallHook</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line">	DWORD dwOLD;</span><br><span class="line">	MEMORY_BASIC_INFORMATION  mbi;</span><br><span class="line">	<span class="keyword">if</span> (g_PointerToIATThunk)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//æŸ¥è¯¢å¹¶ä¿®æ”¹å†…å­˜é¡µçš„å±æ€§</span></span><br><span class="line">		VirtualQuery((LPCVOID)g_PointerToIATThunk,&amp;mbi,<span class="keyword">sizeof</span>(mbi));</span><br><span class="line">		VirtualProtect(mbi.BaseAddress,mbi.RegionSize,PAGE_EXECUTE_READWRITE,&amp;dwOLD);</span><br><span class="line">		<span class="comment">//å°†åŸå§‹çš„MessageBoxAåœ°å€å¡«å…¥IATä¸­</span></span><br><span class="line">		*g_PointerToIATThunk = (ULONG)OldMessageBox;</span><br><span class="line">		<span class="comment">//æ¢å¤å†…å­˜é¡µçš„å±æ€§</span></span><br><span class="line">		VirtualProtect(mbi.BaseAddress,mbi.RegionSize,dwOLD,<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//************************************</span></span><br><span class="line"><span class="comment">// FullName:    InstallModuleIATHook</span></span><br><span class="line"><span class="comment">// Description: ä¸ºæŒ‡å®šæ¨¡å—å®‰è£…IAT Hook</span></span><br><span class="line"><span class="comment">// Access:      public </span></span><br><span class="line"><span class="comment">// Returns:     BOOL</span></span><br><span class="line"><span class="comment">// Parameter:   HMODULE hModToHook , å¾…Hookçš„æ¨¡å—åŸºå€</span></span><br><span class="line"><span class="comment">// Parameter:   char * szModuleName , ç›®æ ‡å‡½æ•°æ‰€åœ¨æ¨¡å—çš„åå­—</span></span><br><span class="line"><span class="comment">// Parameter:   char * szFuncName , ç›®æ ‡å‡½æ•°çš„åå­—</span></span><br><span class="line"><span class="comment">// Parameter:   PVOID DetourFunc , Detourå‡½æ•°åœ°å€</span></span><br><span class="line"><span class="comment">// Parameter:   PULONG * pThunkPointer , ç”¨ä»¥æ¥æ”¶æŒ‡å‘ä¿®æ”¹çš„ä½ç½®çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// Parameter:   ULONG * pOriginalFuncAddr , ç”¨ä»¥æ¥æ”¶åŸå§‹å‡½æ•°åœ°å€</span></span><br><span class="line"><span class="comment">//************************************</span></span><br><span class="line">BOOL <span class="title function_">InstallModuleIATHook</span><span class="params">(</span></span><br><span class="line"><span class="params">	HMODULE hModToHook,<span class="comment">// IN</span></span></span><br><span class="line"><span class="params">	<span class="type">char</span> *szModuleName,<span class="comment">// IN</span></span></span><br><span class="line"><span class="params">	<span class="type">char</span> *szFuncName,<span class="comment">// IN</span></span></span><br><span class="line"><span class="params">	PVOID DetourFunc,<span class="comment">// IN</span></span></span><br><span class="line"><span class="params">	PULONG_PTR *pThunkPointer,<span class="comment">//OUT</span></span></span><br><span class="line"><span class="params">	ULONG_PTR *pOriginalFuncAddr<span class="comment">//OUT</span></span></span><br><span class="line"><span class="params">	)</span></span><br><span class="line">&#123;</span><br><span class="line">	PIMAGE_IMPORT_DESCRIPTOR  pImportDescriptor;</span><br><span class="line">	PIMAGE_THUNK_DATA         pThunkData;</span><br><span class="line">	ULONG ulSize;</span><br><span class="line">	HMODULE hModule=<span class="number">0</span>;</span><br><span class="line">	ULONG_PTR TargetFunAddr;</span><br><span class="line">	PULONG_PTR lpAddr;</span><br><span class="line">	<span class="type">char</span> *szModName;</span><br><span class="line">	BOOL result = FALSE ;</span><br><span class="line">	BOOL bRetn = FALSE;</span><br><span class="line"></span><br><span class="line">	hModule = LoadLibrary(szModuleName);</span><br><span class="line">	TargetFunAddr = (ULONG_PTR)GetProcAddress(hModule,szFuncName);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*]Address of %s:0x%p\n&quot;</span>,szFuncName,TargetFunAddr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*]Module To Hook at Base:0x%p\n&quot;</span>,hModToHook);</span><br><span class="line">	pImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)ImageDirectoryEntryToData(hModToHook, TRUE,IMAGE_DIRECTORY_ENTRY_IMPORT, &amp;ulSize);;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*]Find ImportTable,Address:0x%p\n&quot;</span>,pImportDescriptor);</span><br><span class="line">	<span class="keyword">while</span> (pImportDescriptor-&gt;FirstThunk)</span><br><span class="line">	&#123;</span><br><span class="line">		szModName = (<span class="type">char</span>*)((PBYTE)hModToHook+pImportDescriptor-&gt;Name) ;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[*]Cur Module Name:%s\n&quot;</span>,szModName);</span><br><span class="line">		<span class="keyword">if</span> (stricmp(szModName,szModuleName) != <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;[*]Module Name does not match, search next...\n&quot;</span>);</span><br><span class="line">			pImportDescriptor++;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//ç¨‹åºçš„å¯¼å…¥è¡¨å¤„ç†å®Œæ¯•åOriginalFirstThunkå¯èƒ½æ˜¯æ— æ•ˆçš„ï¼Œä¸èƒ½å†æ ¹æ®åç§°æ¥æŸ¥æ‰¾ï¼Œè€Œæ˜¯éå†FirstThunkç›´æ¥æ ¹æ®åœ°å€åˆ¤æ–­</span></span><br><span class="line">		pThunkData = (PIMAGE_THUNK_DATA)((BYTE *)hModToHook + pImportDescriptor-&gt;FirstThunk);</span><br><span class="line">		<span class="keyword">while</span>(pThunkData-&gt;u1.Function)</span><br><span class="line">		&#123;</span><br><span class="line">			lpAddr = (ULONG_PTR*)pThunkData;</span><br><span class="line">			<span class="comment">//æ‰¾åˆ°äº†åœ°å€</span></span><br><span class="line">			<span class="keyword">if</span>((*lpAddr) == TargetFunAddr)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;[*]Find target address!\n&quot;</span>);</span><br><span class="line">				<span class="comment">//é€šå¸¸æƒ…å†µä¸‹å¯¼å…¥è¡¨æ‰€åœ¨å†…å­˜é¡µéƒ½æ˜¯åªè¯»çš„ï¼Œå› æ­¤éœ€è¦å…ˆä¿®æ”¹å†…å­˜é¡µçš„å±æ€§ä¸ºå¯å†™</span></span><br><span class="line">				DWORD dwOldProtect;</span><br><span class="line">				MEMORY_BASIC_INFORMATION  mbi;</span><br><span class="line">				VirtualQuery(lpAddr,&amp;mbi,<span class="keyword">sizeof</span>(mbi));</span><br><span class="line">				bRetn = VirtualProtect(mbi.BaseAddress,mbi.RegionSize,PAGE_EXECUTE_READWRITE,&amp;dwOldProtect);</span><br><span class="line">				<span class="keyword">if</span> (bRetn)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//å†…å­˜é¡µå±æ€§ä¿®æ”¹æˆåŠŸ,ç»§ç»­ä¸‹ä¸€æ­¥æ“ä½œ,å…ˆä¿å­˜åŸå§‹æ•°æ®</span></span><br><span class="line">					<span class="keyword">if</span> (pThunkPointer != <span class="literal">NULL</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						*pThunkPointer = lpAddr ;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (pOriginalFuncAddr != <span class="literal">NULL</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						*pOriginalFuncAddr = *lpAddr ;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="comment">//ä¿®æ”¹åœ°å€</span></span><br><span class="line">					*lpAddr = (ULONG_PTR)DetourFunc;</span><br><span class="line">					result = TRUE ;</span><br><span class="line">					<span class="comment">//æ¢å¤å†…å­˜é¡µçš„å±æ€§</span></span><br><span class="line">					VirtualProtect(mbi.BaseAddress,mbi.RegionSize,dwOldProtect,<span class="number">0</span>);</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">&quot;[*]Hook ok.\n&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">break</span>;	</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//---------</span></span><br><span class="line">			pThunkData++;</span><br><span class="line">		&#125;</span><br><span class="line">		pImportDescriptor++;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	FreeLibrary(hModule);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">BOOL</span> <span class="params">(WINAPI *LPFN_ISWOW64PROCESS)</span> <span class="params">(HANDLE, PBOOL)</span>;</span><br><span class="line"></span><br><span class="line">LPFN_ISWOW64PROCESS fnIsWow64Process;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">IsWow64</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bIsWow64 = FALSE;</span><br><span class="line"></span><br><span class="line">	fnIsWow64Process = (LPFN_ISWOW64PROCESS)GetProcAddress(</span><br><span class="line">		GetModuleHandle(TEXT(<span class="string">&quot;kernel32&quot;</span>)),<span class="string">&quot;IsWow64Process&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> != fnIsWow64Process)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!fnIsWow64Process(GetCurrentProcess(),&amp;bIsWow64))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// handle error</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bIsWow64;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="è§£æ-1"><a href="#è§£æ-1" class="headerlink" title="è§£æ"></a>è§£æ</h5><p>è¿™é‡Œåªè§£æè¿™ä¸ªå…³é”®å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">IAT_InstallHook</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	BOOL bResult = FALSE ;</span><br><span class="line">	HMODULE hCurExe = GetModuleHandle(<span class="literal">NULL</span>);</span><br><span class="line">	PULONG_PTR pt ;</span><br><span class="line">	ULONG_PTR OrginalAddr;</span><br><span class="line">	bResult = InstallModuleIATHook(hCurExe,<span class="string">&quot;user32.dll&quot;</span>,<span class="string">&quot;MessageBoxA&quot;</span>,(PVOID)My_MessageBoxA,&amp;pt,&amp;OrginalAddr);</span><br><span class="line">	<span class="keyword">if</span> (bResult)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[*]Hookå®‰è£…å®Œæ¯•! pThunk=0x%p  OriginalAddr = 0x%p\n&quot;</span>,pt,OrginalAddr);</span><br><span class="line">		g_PointerToIATThunk = pt ;</span><br><span class="line">		OldMessageBox = (PFN_MessageBoxA)OrginalAddr ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bResult;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="ç¬¬ä¸€æ®µ"><a href="#ç¬¬ä¸€æ®µ" class="headerlink" title="ç¬¬ä¸€æ®µ"></a>ç¬¬ä¸€æ®µ</h6><p><code>BOOL bResult = FALSE ;</code></p>
<p><code>HMODULE hCurExe = GetModuleHandle(NULL);</code></p>
<p>å®šä¹‰ä¸¤ä¸ªåˆå§‹å€¼ï¼Œä¸€ä¸ªæ˜¯è¿”å›æ˜¯å¦æˆåŠŸï¼Œä¸€ä¸ªæ˜¯è·å–å½“å‰çº¿ç¨‹çš„å¥æŸ„</p>
<p>å…¶ä¸­å‡½æ•°è§£æ<code>GetMouduleHandle</code></p>
<p>æ˜¯ä¸€ä¸ªwin32APIå‡½æ•°ï¼Œç”¨äºè·å–å¥æŸ„ï¼Œå½“ä¼ å…¥å‚æ•°ä¸ºNULLçš„æ—¶å€™ä»£è¡¨è·å–å½“å‰è¿›ç¨‹ä¸­ä¸»æ¨¡å—çš„å¥æŸ„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PULONG_PTR pt;</span><br><span class="line">ULONG_PTR OrginalAddr;</span><br><span class="line">bResult = InstallModuleIATHook(</span><br><span class="line">    hCurExe,              <span class="comment">// æ¨¡å—å¥æŸ„</span></span><br><span class="line">    <span class="string">&quot;user32.dll&quot;</span>,         <span class="comment">// è¢«é’©å­çš„æ¨¡å—</span></span><br><span class="line">    <span class="string">&quot;MessageBoxA&quot;</span>,        <span class="comment">// ç›®æ ‡å‡½æ•°åç§°</span></span><br><span class="line">    (PVOID)My_MessageBoxA,<span class="comment">// æ›¿æ¢çš„æ–°å‡½æ•°</span></span><br><span class="line">    &amp;pt,                  <span class="comment">// åŸå‡½æ•°åœ°å€æŒ‡é’ˆ</span></span><br><span class="line">    &amp;OrginalAddr          <span class="comment">// å­˜å‚¨ç›®æ ‡å‡½æ•°çš„åŸå§‹åœ°å€</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h6 id="ç¬¬äºŒæ®µ"><a href="#ç¬¬äºŒæ®µ" class="headerlink" title="ç¬¬äºŒæ®µ"></a>ç¬¬äºŒæ®µ</h6><p>å®šä¹‰äº†pt(åŸå‡½æ•°åœ°å€ï¼‰ï¼ŒOrginalAddrï¼ˆå­˜å‚¨ç›®æ ‡å‡½æ•°åœ°å€ï¼‰</p>
<p>å…¶ä¸­çš„å‡½æ•°è§£æ<code>InstallModuleIATHook</code>ï¼Œå‡½æ•°å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">InstallModuleIATHook</span><span class="params">(</span></span><br><span class="line"><span class="params">	HMODULE hModToHook,       <span class="comment">// [IN] è¦ä¿®æ”¹çš„ç›®æ ‡æ¨¡å—å¥æŸ„ã€‚</span></span></span><br><span class="line"><span class="params">	<span class="type">char</span>* szModuleName,       <span class="comment">// [IN] è¢«é’©å–çš„ç›®æ ‡æ¨¡å—åç§°ï¼ˆä¾‹å¦‚ &quot;user32.dll&quot;ï¼‰ã€‚</span></span></span><br><span class="line"><span class="params">	<span class="type">char</span>* szFuncName,         <span class="comment">// [IN] è¦æ‹¦æˆªçš„ç›®æ ‡å‡½æ•°åç§°ï¼ˆä¾‹å¦‚ &quot;MessageBoxA&quot;ï¼‰ã€‚</span></span></span><br><span class="line"><span class="params">	PVOID DetourFunc,         <span class="comment">// [IN] æ›¿æ¢å‡½æ•°åœ°å€ï¼ˆé’©å­å‡½æ•°åœ°å€ï¼‰ã€‚</span></span></span><br><span class="line"><span class="params">	PULONG_PTR* pThunkPointer,<span class="comment">// [OUT] ä¿å­˜å¯¼å…¥è¡¨ä¸­ç›®æ ‡å‡½æ•°åœ°å€çš„æŒ‡é’ˆã€‚</span></span></span><br><span class="line"><span class="params">	ULONG_PTR* pOriginalFuncAddr<span class="comment">// [OUT] ä¿å­˜ç›®æ ‡å‡½æ•°çš„åŸå§‹åœ°å€ã€‚</span></span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// å®šä¹‰æ‰€éœ€çš„å˜é‡ã€‚</span></span><br><span class="line">	PIMAGE_IMPORT_DESCRIPTOR  pImportDescriptor; <span class="comment">// å¯¼å…¥è¡¨æè¿°ç¬¦ï¼Œç”¨äºå®šä½å¯¼å…¥è¡¨ã€‚</span></span><br><span class="line">	PIMAGE_THUNK_DATA         pThunkData;        <span class="comment">// ç”¨äºéå†å¯¼å…¥è¡¨çš„å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">	ULONG ulSize;                                 <span class="comment">// å­˜å‚¨å¯¼å…¥è¡¨å¤§å°ã€‚</span></span><br><span class="line">	HMODULE hModule = <span class="number">0</span>;                          <span class="comment">// å­˜å‚¨è¢«é’©å–æ¨¡å—çš„å¥æŸ„ã€‚</span></span><br><span class="line">	ULONG_PTR TargetFunAddr;                      <span class="comment">// å­˜å‚¨ç›®æ ‡å‡½æ•°çš„çœŸå®åœ°å€ã€‚</span></span><br><span class="line">	PULONG_PTR lpAddr;                            <span class="comment">// æŒ‡å‘å¯¼å…¥è¡¨ä¸­çš„ç›®æ ‡åœ°å€ã€‚</span></span><br><span class="line">	<span class="type">char</span>* szModName;                              <span class="comment">// ä¿å­˜å½“å‰æ¨¡å—çš„åç§°ã€‚</span></span><br><span class="line">	BOOL result = FALSE;                          <span class="comment">// è¿”å›å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦é’©å­æˆåŠŸã€‚</span></span><br><span class="line">	BOOL bRetn = FALSE;                           <span class="comment">// ä¸´æ—¶å˜é‡ï¼Œç”¨äºå­˜å‚¨å†…å­˜æƒé™ä¿®æ”¹çš„ç»“æœã€‚</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// åŠ è½½ç›®æ ‡æ¨¡å—å¹¶è·å–ç›®æ ‡å‡½æ•°çš„åœ°å€ã€‚</span></span><br><span class="line">	hModule = LoadLibrary(szModuleName);           <span class="comment">// åŠ è½½è¢«é’©å–çš„æ¨¡å—ï¼ˆä¾‹å¦‚ &quot;user32.dll&quot;ï¼‰ã€‚</span></span><br><span class="line">	TargetFunAddr = (ULONG_PTR)GetProcAddress(hModule, szFuncName); <span class="comment">// è·å–ç›®æ ‡å‡½æ•°åœ°å€ã€‚</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*]Address of %s:0x%p\n&quot;</span>, szFuncName, TargetFunAddr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*]Module To Hook at Base:0x%p\n&quot;</span>, hModToHook);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æŸ¥æ‰¾ç›®æ ‡æ¨¡å—çš„å¯¼å…¥è¡¨åœ°å€ã€‚</span></span><br><span class="line">	pImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)ImageDirectoryEntryToData(</span><br><span class="line">		hModToHook, </span><br><span class="line">		TRUE, </span><br><span class="line">		IMAGE_DIRECTORY_ENTRY_IMPORT, </span><br><span class="line">		&amp;ulSize); <span class="comment">// è·å–å¯¼å…¥è¡¨çš„èµ·å§‹åœ°å€åŠå¤§å°ã€‚</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[*]Find ImportTable,Address:0x%p\n&quot;</span>, pImportDescriptor);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// éå†å¯¼å…¥è¡¨ä¸­çš„æ¯ä¸ªæ¨¡å—ã€‚</span></span><br><span class="line">	<span class="keyword">while</span> (pImportDescriptor-&gt;FirstThunk)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// è·å–å½“å‰æ¨¡å—çš„åç§°ã€‚</span></span><br><span class="line">		szModName = (<span class="type">char</span>*)((PBYTE)hModToHook + pImportDescriptor-&gt;Name);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[*]Cur Module Name:%s\n&quot;</span>, szModName);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// å¦‚æœæ¨¡å—åç§°ä¸ç›®æ ‡æ¨¡å—ä¸åŒ¹é…ï¼Œç»§ç»­æŸ¥æ‰¾ä¸‹ä¸€ä¸ªã€‚</span></span><br><span class="line">		<span class="keyword">if</span> (stricmp(szModName, szModuleName) != <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;[*]Module Name does not match, search next...\n&quot;</span>);</span><br><span class="line">			pImportDescriptor++;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// å¼€å§‹éå†å¯¼å…¥è¡¨ä¸­çš„å‡½æ•°åœ°å€ã€‚</span></span><br><span class="line">		pThunkData = (PIMAGE_THUNK_DATA)((BYTE*)hModToHook + pImportDescriptor-&gt;FirstThunk);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (pThunkData-&gt;u1.Function)</span><br><span class="line">		&#123;</span><br><span class="line">			lpAddr = (ULONG_PTR*)pThunkData; <span class="comment">// è·å–å½“å‰å‡½æ•°çš„åœ°å€æŒ‡é’ˆã€‚</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// å¦‚æœæ‰¾åˆ°ç›®æ ‡å‡½æ•°åœ°å€ã€‚</span></span><br><span class="line">			<span class="keyword">if</span> ((*lpAddr) == TargetFunAddr)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;[*]Find target address!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// è·å–å½“å‰åœ°å€æ‰€åœ¨å†…å­˜é¡µä¿¡æ¯å¹¶å°è¯•ä¿®æ”¹æƒé™ã€‚</span></span><br><span class="line">				DWORD dwOldProtect; <span class="comment">// ä¿å­˜åŸå†…å­˜ä¿æŠ¤å±æ€§ã€‚</span></span><br><span class="line">				MEMORY_BASIC_INFORMATION  mbi;</span><br><span class="line">				VirtualQuery(lpAddr, &amp;mbi, <span class="keyword">sizeof</span>(mbi)); <span class="comment">// æŸ¥è¯¢å†…å­˜é¡µå±æ€§ã€‚</span></span><br><span class="line">				bRetn = VirtualProtect(mbi.BaseAddress, mbi.RegionSize, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (bRetn)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// ä¿®æ”¹å†…å­˜é¡µå±æ€§æˆåŠŸã€‚</span></span><br><span class="line"></span><br><span class="line">					<span class="comment">// ä¿å­˜å¯¼å…¥è¡¨ä¸­ç›®æ ‡å‡½æ•°åœ°å€æŒ‡é’ˆå’ŒåŸå§‹å‡½æ•°åœ°å€ã€‚</span></span><br><span class="line">					<span class="keyword">if</span> (pThunkPointer != <span class="literal">NULL</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						*pThunkPointer = lpAddr; <span class="comment">// ä¿å­˜å¯¼å…¥è¡¨ä¸­çš„åœ°å€ã€‚</span></span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (pOriginalFuncAddr != <span class="literal">NULL</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						*pOriginalFuncAddr = *lpAddr; <span class="comment">// ä¿å­˜ç›®æ ‡å‡½æ•°çš„åŸå§‹åœ°å€ã€‚</span></span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="comment">// æ›¿æ¢å¯¼å…¥è¡¨ä¸­çš„ç›®æ ‡å‡½æ•°åœ°å€ä¸ºè‡ªå®šä¹‰å‡½æ•°åœ°å€ã€‚</span></span><br><span class="line">					*lpAddr = (ULONG_PTR)DetourFunc;</span><br><span class="line"></span><br><span class="line">					result = TRUE; <span class="comment">// é’©å­å®‰è£…æˆåŠŸã€‚</span></span><br><span class="line"></span><br><span class="line">					<span class="comment">// æ¢å¤å†…å­˜é¡µçš„åŸå§‹æƒé™ã€‚</span></span><br><span class="line">					VirtualProtect(mbi.BaseAddress, mbi.RegionSize, dwOldProtect, <span class="number">0</span>);</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">&quot;[*]Hook ok.\n&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">break</span>; <span class="comment">// è·³å‡ºå¾ªç¯ã€‚</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			pThunkData++; <span class="comment">// æ£€æŸ¥ä¸‹ä¸€ä¸ªå‡½æ•°åœ°å€ã€‚</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		pImportDescriptor++; <span class="comment">// æ£€æŸ¥ä¸‹ä¸€ä¸ªæ¨¡å—çš„å¯¼å…¥è¡¨ã€‚</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// é‡Šæ”¾åŠ è½½çš„æ¨¡å—å¥æŸ„ã€‚</span></span><br><span class="line">	FreeLibrary(hModule);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result; <span class="comment">// è¿”å›é’©å­å®‰è£…ç»“æœã€‚</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç®€å•æ¥è¯´å°±æ˜¯ä¼ å…¥è¦ä¿®æ”¹çš„æ¨¡å—å¥æŸ„å’Œåç§°ä»¥åŠå…·ä½“çš„å‡½æ•°ï¼Œç„¶ååœ¨ä¼ å…¥è¦æ›¿æ¢çš„å‡½æ•°çš„åœ°å€ï¼Œæœ€åä¿å­˜æºå‡½æ•°åœ°å€çš„æŒ‡é’ˆå’Œç›®æ ‡å‡½æ•°çš„åœ°å€</p>
<h6 id="ç¬¬ä¸‰æ®µ"><a href="#ç¬¬ä¸‰æ®µ" class="headerlink" title="ç¬¬ä¸‰æ®µ"></a>ç¬¬ä¸‰æ®µ</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bResult)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[*]Hookå®‰è£…å®Œæ¯•! pThunk=0x%p  OriginalAddr = 0x%p\n&quot;</span>,pt,OrginalAddr);</span><br><span class="line">		g_PointerToIATThunk = pt ;</span><br><span class="line">		OldMessageBox = (PFN_MessageBoxA)OrginalAddr ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ ¹æ®ä¸Šä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ä¹Ÿå°±æ˜¯TRUEæˆ–FULLæ¥åˆ¤æ–­æ˜¯å¦æˆåŠŸï¼Œå¹¶æ‰“å°ç»“æœï¼Œæœ€åä¿å­˜ä¸€ä¸‹åŸå‡½æ•°åœ°å€ä¸æŒ‡é’ˆå°±ç»“æŸäº†</p>
<h4 id="è™šå‡½æ•°hook"><a href="#è™šå‡½æ•°hook" class="headerlink" title="è™šå‡½æ•°hook"></a>è™šå‡½æ•°hook</h4><h5 id="è™šå‡½æ•°è¡¨"><a href="#è™šå‡½æ•°è¡¨" class="headerlink" title="è™šå‡½æ•°è¡¨"></a>è™šå‡½æ•°è¡¨</h5><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Primeprime/article/details/80776625">è™šå‡½æ•°è¡¨è¯¦è§£-CSDNåšå®¢</a></p>
<h5 id="åŸç†-4"><a href="#åŸç†-4" class="headerlink" title="åŸç†"></a>åŸç†</h5><p>ååˆ†ç¬¦åˆAddress Hookçš„åŸç†ï¼Œå°†è™šå‡½æ•°è¡¨ä¸­çš„å‡½æ•°åœ°å€æ¢æˆè‡ªå·±çš„å‡½æ•°åœ°å€</p>
<h5 id="æºç -4"><a href="#æºç -4" class="headerlink" title="æºç "></a>æºç </h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*-----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">ç¬¬13ç«   HookæŠ€æœ¯</span></span><br><span class="line"><span class="comment">ã€ŠåŠ å¯†ä¸è§£å¯†ï¼ˆç¬¬å››ç‰ˆï¼‰ã€‹</span></span><br><span class="line"><span class="comment">(c)  çœ‹é›ªå­¦é™¢ www.kanxue.com 2000-2018</span></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// CClassHook.cpp : Defines the entry point for the console application.</span></span><br><span class="line"><span class="comment">//  // åŒ…å« AfxWinInit æ‰€åœ¨çš„å¤´æ–‡ä»¶</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CClassHook.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _DEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> new DEBUG_NEW</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> THIS_FILE</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> THIS_FILE[] = __FILE__;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">è¦è§£å†³ä¸¤ä¸ªé—®é¢˜</span></span><br><span class="line"><span class="comment">1.å¦‚ä½•è·å–ç±»æˆå‘˜å‡½æ•°çš„åœ°å€</span></span><br><span class="line"><span class="comment">2.å¦‚ä½•ä½¿ç”¨æ™®é€šå‡½æ•°æ›¿æ¢ç±»æˆå‘˜å‡½æ•°</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// The one and only application object</span></span><br><span class="line"></span><br><span class="line">CWinApp theApp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">base</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">g</span><span class="params">()</span></span>&#123;cout&lt;&lt;<span class="string">&quot;base::g&quot;</span>&lt;&lt;endl;&#125;;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">h</span><span class="params">()</span></span>&#123;cout&lt;&lt;<span class="string">&quot;base::h&quot;</span>&lt;&lt;endl;&#125;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">novirtual</span><span class="params">()</span></span>&#123;cout&lt;&lt;<span class="string">&quot;base::not virtual&quot;</span>&lt;&lt;endl;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">base::Add</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;base::Add\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> a + b ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DetourClass</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">DetourFun</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TrampolineClass</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">TrampolineFun</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;TrampolineClass\n&quot;</span>);<span class="keyword">return</span> <span class="number">0</span> ;&#125;;<span class="comment">//åŸå‹ä¸è¢«Hookå‡½æ•°ç›¸åŒ</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">DetourClass Detour;</span><br><span class="line">TrampolineClass Trampoline;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">DetourClass::DetourFun</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//TrampolineFun();  //ç”±äºè¿™é‡Œçš„ç±»å®é™…ä¸Šæ˜¯base,æ‰€ä»¥è°ƒç”¨TrampolineFunå³è°ƒç”¨ç¬¬äºŒä¸ªè™šå‡½æ•°ï¼Œç›¸å½“äºè°ƒç”¨pbase-&gt;g()</span></span><br><span class="line">    TrampolineClass *pTrampoline = <span class="keyword">new</span> TrampolineClass;</span><br><span class="line">    <span class="type">int</span> result = pTrampoline-&gt;<span class="built_in">TrampolineFun</span>(a,b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DetourClass:: OriginalFun returned %d\n&quot;</span>,result);</span><br><span class="line">    result += <span class="number">10</span> ;</span><br><span class="line">    <span class="keyword">delete</span> pTrampoline;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*pfun)</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">LPVOID <span class="title">GetClassVirtualFnAddress</span><span class="params">(LPVOID pthis,<span class="type">int</span> Index)</span></span>;</span><br><span class="line"><span class="function">VOID <span class="title">HookClassMemberByAnotherClassMember</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, TCHAR* argv[], TCHAR* envp[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> nRetCode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize MFC and print and error on failure</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">AfxWinInit</span>(::<span class="built_in">GetModuleHandle</span>(<span class="literal">NULL</span>), <span class="literal">NULL</span>, ::<span class="built_in">GetCommandLine</span>(), <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> change error code to suit your needs</span></span><br><span class="line">        cerr &lt;&lt; _T(<span class="string">&quot;Fatal Error: MFC initialization failed&quot;</span>) &lt;&lt; endl;</span><br><span class="line">        nRetCode = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> code your application&#x27;s behavior here.</span></span><br><span class="line">        <span class="built_in">HookClassMemberByAnotherClassMember</span>();</span><br><span class="line">        <span class="built_in">getchar</span>(); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nRetCode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HookClassMemberByAnotherClassMember</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    base b;</span><br><span class="line">    base *pbase=&amp;b;</span><br><span class="line"></span><br><span class="line">    DWORD dwOLD;</span><br><span class="line">    MEMORY_BASIC_INFORMATION  mbi;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pbase = 0x%X\n&quot;</span>,pbase);</span><br><span class="line"></span><br><span class="line">    ULONG_PTR *vfTableToHook = (ULONG_PTR*)*(ULONG_PTR*)pbase;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;vfTable = 0x%x\n&quot;</span>,vfTableToHook);</span><br><span class="line"></span><br><span class="line">    ULONG_PTR *vfTableTrampoline = (ULONG_PTR*)*(ULONG_PTR*)&amp;Trampoline;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…ˆå°†åŸå‡½æ•°çš„åœ°å€ä¿å­˜åˆ°å½“å‰ç±»çš„è¡¨ä¸­ï¼Œä½œä¸ºè°ƒç”¨åŸå‡½æ•°çš„å…¥å£</span></span><br><span class="line">    <span class="built_in">VirtualQuery</span>(vfTableTrampoline,&amp;mbi,<span class="built_in">sizeof</span>(mbi));</span><br><span class="line">    <span class="built_in">VirtualProtect</span>(mbi.BaseAddress,mbi.RegionSize,PAGE_EXECUTE_READWRITE,&amp;dwOLD);</span><br><span class="line">    <span class="comment">//ä¿å­˜åŸå§‹æ•°æ®</span></span><br><span class="line">    <span class="comment">//åŸå‡½æ•°ä½äºç¬¬å‡ ä¸ªè¿™é‡Œå°±æ˜¯ç¬¬å‡ ä¸ªï¼Œå¿…é¡»ä¿è¯ä½ç½®ä¸€æ ·</span></span><br><span class="line">    vfTableTrampoline[<span class="number">0</span>] = (ULONG_PTR)<span class="built_in">GetClassVirtualFnAddress</span>(pbase,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Base::Add()  %p\n&quot;</span>,vfTableTrampoline[<span class="number">0</span>]);</span><br><span class="line">    TrampolineClass *p = &amp;Trampoline;</span><br><span class="line">    <span class="comment">//æ¢å¤å†…å­˜é¡µçš„å±æ€§</span></span><br><span class="line">    <span class="built_in">VirtualProtect</span>(mbi.BaseAddress,mbi.RegionSize,dwOLD,<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//ä¿®æ”¹å†…å­˜é¡µçš„å±æ€§</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualQuery</span>(vfTableToHook,&amp;mbi,<span class="built_in">sizeof</span>(mbi));</span><br><span class="line">    <span class="built_in">VirtualProtect</span>(mbi.BaseAddress,mbi.RegionSize,PAGE_EXECUTE_READWRITE,&amp;dwOLD);</span><br><span class="line">    <span class="comment">//ä¿å­˜åŸå§‹æ•°æ®</span></span><br><span class="line">    vfTableToHook[<span class="number">0</span>] = (ULONG_PTR)<span class="built_in">GetClassVirtualFnAddress</span>(&amp;Detour,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Detour::Add()  %p\n&quot;</span>,vfTableToHook[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">//æ¢å¤å†…å­˜é¡µçš„å±æ€§</span></span><br><span class="line">    <span class="built_in">VirtualProtect</span>(mbi.BaseAddress,mbi.RegionSize,dwOLD,<span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> result = pbase-&gt;<span class="built_in">Add</span>(<span class="number">1</span>,<span class="number">2</span>);    <span class="comment">//è°ƒç”¨ç¬¬3ä¸ªè™šå‡½æ•°ï¼Œå®é™…è°ƒç”¨çš„æ˜¯HookClass::DetourFun()</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;result = %d  \nafter call member fun.\n&quot;</span>,result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å¾—ç±»è™šæ‹Ÿæˆå‘˜å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line"><span class="function">LPVOID <span class="title">GetClassVirtualFnAddress</span><span class="params">(LPVOID pthis,<span class="type">int</span> Index)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ULONG_PTR *vfTable = (ULONG_PTR*)*(ULONG_PTR*)pthis;</span><br><span class="line">    <span class="keyword">return</span> (LPVOID)vfTable[Index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="å‡½æ•°åˆ†æ"><a href="#å‡½æ•°åˆ†æ" class="headerlink" title="å‡½æ•°åˆ†æ"></a>å‡½æ•°åˆ†æ</h5><p>è¿™é‡Œä¸»è¦åˆ†æhookå‡½æ•°ï¼Œä¹Ÿæ˜¯è¿™ä¸ªå‡½æ•°çš„æ ¸å¿ƒ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">HookClassMemberByAnotherClassMember</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    base b;</span><br><span class="line">    base *pbase = &amp;b;</span><br><span class="line"></span><br><span class="line">    DWORD dwOLD;</span><br><span class="line">    MEMORY_BASIC_INFORMATION mbi;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pbase = 0x%X\n&quot;</span>, pbase);</span><br><span class="line"></span><br><span class="line">    ULONG_PTR *vfTableToHook = (ULONG_PTR*)*(ULONG_PTR*)pbase;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;vfTable = 0x%x\n&quot;</span>, vfTableToHook);</span><br><span class="line"></span><br><span class="line">    ULONG_PTR *vfTableTrampoline = (ULONG_PTR*)*(ULONG_PTR*)&amp;Trampoline;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualQuery</span>(vfTableTrampoline, &amp;mbi, <span class="built_in">sizeof</span>(mbi));</span><br><span class="line">    <span class="built_in">VirtualProtect</span>(mbi.BaseAddress, mbi.RegionSize, PAGE_EXECUTE_READWRITE, &amp;dwOLD);</span><br><span class="line"></span><br><span class="line">    vfTableTrampoline[<span class="number">0</span>] = (ULONG_PTR)<span class="built_in">GetClassVirtualFnAddress</span>(pbase, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Base::Add()  %p\n&quot;</span>, vfTableTrampoline[<span class="number">0</span>]);</span><br><span class="line">    TrampolineClass *p = &amp;Trampoline;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualProtect</span>(mbi.BaseAddress, mbi.RegionSize, dwOLD, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualQuery</span>(vfTableToHook, &amp;mbi, <span class="built_in">sizeof</span>(mbi));</span><br><span class="line">    <span class="built_in">VirtualProtect</span>(mbi.BaseAddress, mbi.RegionSize, PAGE_EXECUTE_READWRITE, &amp;dwOLD);</span><br><span class="line"></span><br><span class="line">    vfTableToHook[<span class="number">0</span>] = (ULONG_PTR)<span class="built_in">GetClassVirtualFnAddress</span>(&amp;Detour, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Detour::Add()  %p\n&quot;</span>, vfTableToHook[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VirtualProtect</span>(mbi.BaseAddress, mbi.RegionSize, dwOLD, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> result = pbase-&gt;<span class="built_in">Add</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;result = %d  \nafter call member fun.\n&quot;</span>, result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="æ­¥éª¤-1-è·å–è™šæ‹Ÿå‡½æ•°è¡¨åœ°å€"><a href="#æ­¥éª¤-1-è·å–è™šæ‹Ÿå‡½æ•°è¡¨åœ°å€" class="headerlink" title="æ­¥éª¤ 1: è·å–è™šæ‹Ÿå‡½æ•°è¡¨åœ°å€"></a>æ­¥éª¤ 1: è·å–è™šæ‹Ÿå‡½æ•°è¡¨åœ°å€</h6><ul>
<li><code>vfTableToHook = (ULONG_PTR*)*(ULONG_PTR*)pbase</code> è·å–åˆ° <code>base</code> ç±»å®ä¾‹çš„è™šæ‹Ÿå‡½æ•°è¡¨æŒ‡é’ˆã€‚</li>
<li><code>vfTableTrampoline = (ULONG_PTR*)*(ULONG_PTR*)&amp;Trampoline</code> è·å–åˆ° <code>TrampolineClass</code> çš„è™šæ‹Ÿå‡½æ•°è¡¨æŒ‡é’ˆã€‚</li>
</ul>
<h6 id="æ­¥éª¤-2-ä¿®æ”¹è™šæ‹Ÿå‡½æ•°è¡¨"><a href="#æ­¥éª¤-2-ä¿®æ”¹è™šæ‹Ÿå‡½æ•°è¡¨" class="headerlink" title="æ­¥éª¤ 2: ä¿®æ”¹è™šæ‹Ÿå‡½æ•°è¡¨"></a>æ­¥éª¤ 2: ä¿®æ”¹è™šæ‹Ÿå‡½æ•°è¡¨</h6><ul>
<li><strong>ä¿å­˜åŸå§‹å‡½æ•°åœ°å€</strong>ï¼šé€šè¿‡ <code>VirtualQuery</code> å’Œ <code>VirtualProtect</code> ä¿®æ”¹å†…å­˜æƒé™ï¼Œä½¿å¾—å¯ä»¥ä¿®æ”¹è™šæ‹Ÿå‡½æ•°è¡¨ã€‚åœ¨ <code>vfTableTrampoline[0]</code> ä¸­ä¿å­˜åŸæ¥ <code>base::Add</code> å‡½æ•°çš„åœ°å€ã€‚</li>
<li><strong>æ›¿æ¢ä¸º Detour å‡½æ•°</strong>ï¼šå°† <code>vfTableToHook[0]</code> æ›¿æ¢ä¸º <code>DetourClass::DetourFun</code> çš„åœ°å€ï¼Œä»è€Œä½¿å¾— <code>base::Add</code> å‡½æ•°è¢«æ›¿æ¢ä¸º <code>DetourClass::DetourFun</code>ã€‚</li>
</ul>
<h6 id="æ­¥éª¤-3-æ¢å¤è™šæ‹Ÿå‡½æ•°è¡¨ä¿®æ”¹"><a href="#æ­¥éª¤-3-æ¢å¤è™šæ‹Ÿå‡½æ•°è¡¨ä¿®æ”¹" class="headerlink" title="æ­¥éª¤ 3: æ¢å¤è™šæ‹Ÿå‡½æ•°è¡¨ä¿®æ”¹"></a>æ­¥éª¤ 3: æ¢å¤è™šæ‹Ÿå‡½æ•°è¡¨ä¿®æ”¹</h6><ul>
<li>é€šè¿‡ <code>VirtualProtect</code> æ¢å¤å†…å­˜é¡µçš„ä¿æŠ¤ï¼Œä»¥ä¿è¯ä¿®æ”¹åçš„å†…å­˜åŒºåŸŸå¯ä»¥æ­£å¸¸è®¿é—®ã€‚</li>
</ul>
<h6 id="æ­¥éª¤-4-è°ƒç”¨è™šæ‹Ÿå‡½æ•°"><a href="#æ­¥éª¤-4-è°ƒç”¨è™šæ‹Ÿå‡½æ•°" class="headerlink" title="æ­¥éª¤ 4: è°ƒç”¨è™šæ‹Ÿå‡½æ•°"></a>æ­¥éª¤ 4: è°ƒç”¨è™šæ‹Ÿå‡½æ•°</h6><ul>
<li><code>int result = pbase-&gt;Add(1, 2)</code> è°ƒç”¨äº†è¢« Hook çš„ <code>base::Add</code> å‡½æ•°ï¼Œä½†ç”±äºæˆ‘ä»¬æ›¿æ¢äº†è™šæ‹Ÿå‡½æ•°è¡¨ä¸­çš„åœ°å€ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯ <code>DetourClass::DetourFun</code>ï¼Œæœ€ç»ˆè¾“å‡ºå’Œè¿”å›çš„å€¼æ˜¯é€šè¿‡ <code>DetourClass::DetourFun</code> å¤„ç†åçš„ã€‚</li>
</ul>
<h2 id="äºŒæ¬¡hookæ³¨æ„äº‹é¡¹"><a href="#äºŒæ¬¡hookæ³¨æ„äº‹é¡¹" class="headerlink" title="äºŒæ¬¡hookæ³¨æ„äº‹é¡¹"></a>äºŒæ¬¡hookæ³¨æ„äº‹é¡¹</h2><h3 id="1-ä¸Hook"><a href="#1-ä¸Hook" class="headerlink" title="1.ä¸Hook"></a>1.ä¸Hook</h3><p><code>Hook</code>æ›´æ”¹ç¨æœ‰ä¸æ…å°±å¯èƒ½é€ æˆç¨‹åºé”™è¯¯çš„åæœï¼ˆè“å±è­¦å‘Šï¼‰ï¼Œå°¤å…¶æ˜¯åå‘å†…æ ¸çš„ä¸œè¥¿<code>AddressHook</code>ï¼Œåœ¨æ—©æœŸç—…æ¯’æŸ¥æ€å¸‚åœºï¼Œå„å¤§ç—…æ¯’æŸ¥æ€è½¯ä»¶ï¼Œå°±æ˜¯åœ¨å„ä¸ªé£é™©çš„ç‚¹æ·»åŠ <code>Hook</code>ï¼Œä½†æ˜¯ç—…æ¯’æŸ¥æ€è½¯ä»¶ä¹‹é—´æ·»åŠ <code>Hook</code>ï¼Œå¹¶ä¸”è¿™äº›<code>Hook</code>å¹¶ä¸å…¼å®¹ï¼Œè°ä¹Ÿä¸èƒ½ä¿å‡†å“ªä¸ª<code>Hook</code>åˆšå¥½ä¼šè¦†ç›–æ‰å¦ä¸€ä¸ªçš„<code>Hook</code>ï¼Œè¿™æ ·çš„é—®é¢˜ä¹ŸæŒç»­è‡³ä»Šï¼Œæ‰€ä»¥åˆ°å¦‚ä»Šè¿™ä¸ªæ—¶ä»£ç—…æ¯’æŸ¥æ€è½¯ä»¶ä¹Ÿæœ€å¥½åªå®‰è£…ä¸€ç§	</p>
<p>æ‰€ä»¥æœ‰æ—¶å€™<code>Hook</code>éšæ„æ›´æ”¹ä¼šå¸¦æ¥é£é™©</p>
<h3 id="2-æ¢å¤Hookå‰çš„æŒ‡ä»¤"><a href="#2-æ¢å¤Hookå‰çš„æŒ‡ä»¤" class="headerlink" title="2.æ¢å¤Hookå‰çš„æŒ‡ä»¤"></a>2.æ¢å¤Hookå‰çš„æŒ‡ä»¤</h3><p>è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯ï¼Œè¯¥æ®µçš„<code>Hook</code>ä¼šæ˜¯å”¯ä¸€æ€§çš„ï¼Œä¸€ä¸ªç¨‹åºé‡Œåªèƒ½æœ‰ä¸€ä¸ª<code>Hook</code></p>
<h3 id="3-æ¢ä¸ªç›®æ ‡åœ°å€Hook"><a href="#3-æ¢ä¸ªç›®æ ‡åœ°å€Hook" class="headerlink" title="3.æ¢ä¸ªç›®æ ‡åœ°å€Hook"></a>3.æ¢ä¸ªç›®æ ‡åœ°å€Hook</h3><p>å°±è·Ÿé¢˜ç›®ä¸€æ ·ï¼Œæ¢ä¸ªåœ°æ–¹</p>
<h3 id="4-Hookä¸Šä¸€ä¸ªHookè¿‡ç¨‹çš„Detourå‡½æ•°"><a href="#4-Hookä¸Šä¸€ä¸ªHookè¿‡ç¨‹çš„Detourå‡½æ•°" class="headerlink" title="4.Hookä¸Šä¸€ä¸ªHookè¿‡ç¨‹çš„Detourå‡½æ•°"></a>4.Hookä¸Šä¸€ä¸ªHookè¿‡ç¨‹çš„Detourå‡½æ•°</h3><p>è¿™ä¸ªä¹Ÿå’Œé¢˜ç›®ä¸€æ ·ç†è§£å°±å¯ä»¥</p>
</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>l1pmoluy,1392181761@qq.com</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="https://l1pmoluy.github.io/2024/12/01/Hook%E6%8A%80%E6%9C%AF/" title="HookæŠ€æœ¯">https://l1pmoluy.github.io/2024/12/01/Hook%E6%8A%80%E6%9C%AF/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é»˜è®¤é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> è®¸å¯åè®®ã€‚</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2024/12/04/PE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/" rel="prev" title="PEæ–‡ä»¶æ ¼å¼"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">PEæ–‡ä»¶æ ¼å¼</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2024/11/09/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/" rel="next" title="æ³¨å…¥æŠ€æœ¯"><span class="post-nav-text">æ³¨å…¥æŠ€æœ¯</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2025 </span><a class="with-love" id="animate" href="https://l1pmoluy.github.io" title="l1pmoluy's blog"><span class="icon iconify" data-icon="ri:cloud-line"></span></a><span class="author"> l1pmoluy</span></div><div class="powered"><span>ç”± <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> é©±åŠ¨ v7.3.0</span><span class="footer-separator">|</span><span>ä¸»é¢˜ - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#f5b8d5" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="æœç´¢"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script defer src="https://fastly.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script defer src="https://fastly.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script defer src="/js/search/algolia-search.js" type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div class="algolia-pagination" id="algolia-pagination"></div></div></div></body></html>